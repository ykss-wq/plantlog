<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>PlantLogï¼ˆãƒ©ã‚¤ãƒˆï¼‰</title>
  <meta name="theme-color" content="#f6f7fb" />

  <style>
    :root{
      /* Light, eye-friendly */
      --bg:#f6f7fb;
      --panel:#ffffff;
      --panel2:#fbfcff;
      --line:#e7eaf2;
      --text:#0f172a;
      --muted:#64748b;

      --accent:#22c55e;   /* green */
      --accent2:#06b6d4;  /* cyan */
      --danger:#ef4444;
      --warn:#f59e0b;

      --shadow: 0 10px 30px rgba(15, 23, 42, .08);
      --radius:18px;
    }

    *{box-sizing:border-box}
    html,body{
      min-height:100dvh;
      margin:0;
      padding:0;
      background:var(--bg);
      color:var(--text);
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,"Hiragino Kaku Gothic ProN","Noto Sans JP","Yu Gothic",sans-serif;
    }

    /* å…¨ä½“ä½™ç™½ï¼šä¸ŠãŒè©°ã¾ã‚‰ãªã„ã‚ˆã†ã« */
    body{
      padding:
        calc(env(safe-area-inset-top) + 18px)
        14px
        calc(env(safe-area-inset-bottom) + 18px);
    }

    .wrap{max-width:980px;margin:0 auto;}
    .grid{display:grid;gap:14px;}

    /* header: ä½™ç™½å¢—ã‚„ã™ãƒ»è©°ã¾ã‚Šå›é¿ */
    header{
      position:sticky;
      top:0;
      z-index:10;

      padding: 14px 0 16px;
      margin: -10px 0 8px;

      background: rgba(246,247,251,.92);
      backdrop-filter: blur(10px);
      border-bottom:1px solid rgba(231,234,242,.9);
    }

    .topline{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      padding: 0 2px 10px;
    }

    .brand{
      display:flex;
      align-items:center;
      gap:10px;
    }

    .logo{
      width:38px;height:38px;
      border-radius:12px;
      display:grid;place-items:center;
      background: linear-gradient(135deg, rgba(34,197,94,.18), rgba(6,182,212,.14));
      border:1px solid rgba(231,234,242,.9);
      box-shadow: var(--shadow);
      font-size:18px;
    }

    h1{
      margin:0;
      font-size:18px;
      letter-spacing:.2px;
      line-height:1.2;
    }
    .subtitle{
      margin-top:2px;
      font-size:12px;
      color:var(--muted);
    }

    .pill{
      font-size:12px;
      color:var(--muted);
      padding:8px 10px;
      border:1px solid var(--line);
      border-radius:999px;
      background: rgba(255,255,255,.7);
      box-shadow: 0 6px 18px rgba(15,23,42,.05);
      white-space:nowrap;
      align-self:flex-start;
    }

    /* tabs: 2è¡Œã§ã‚‚è©°ã¾ã‚‰ãªã„ */
    .tabs{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      padding: 0 2px;
    }
    .tab{
      display:flex;
      align-items:center;
      gap:8px;

      padding:12px 14px;
      border-radius:999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.75);
      color: var(--text);
      cursor:pointer;
      user-select:none;
      font-size:14px;
      line-height:1;
      box-shadow: 0 8px 22px rgba(15,23,42,.05);
    }
    .tab.active{
      border-color: rgba(34,197,94,.45);
      background: linear-gradient(90deg, rgba(34,197,94,.16), rgba(6,182,212,.10));
    }

    .card{
      border:1px solid var(--line);
      background: var(--panel);
      border-radius: var(--radius);
      padding: 16px;
      box-shadow: var(--shadow);
    }
    .card h2{
      margin:0 0 6px;
      font-size:18px;
    }
    .sub{
      color:var(--muted);
      font-size:13px;
      line-height:1.5;
    }
    .hr{height:1px;background:var(--line);margin:14px 0;}

    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;}
    .split{display:grid;grid-template-columns:1fr;gap:14px;}
    @media(min-width:860px){ .split{grid-template-columns:1.2fr .8fr} }

    .btn{
      border:none;
      color:#052014;
      background: linear-gradient(90deg, rgba(34,197,94,1), rgba(6,182,212,1));
      padding:12px 14px;
      border-radius:14px;
      font-weight:800;
      cursor:pointer;
      box-shadow: 0 14px 30px rgba(34,197,94,.18);
    }
    .btn:disabled{opacity:.6;cursor:not-allowed;}
    .btn.small{padding:10px 12px;font-size:13px;border-radius:12px;}
    .btn.ghost{
      background:transparent;
      color:var(--text);
      border:1px solid var(--line);
      box-shadow:none;
    }
    .btn.danger{
      background: linear-gradient(90deg, #ef4444, #fb7185);
      color:#2a0b0b;
    }

    input,select,textarea{
      width:100%;
      background: var(--panel2);
      border:1px solid var(--line);
      color:var(--text);
      border-radius: 14px;
      padding: 12px 12px;
      outline:none;
      font-size:14px;
    }
    textarea{min-height:92px;resize:vertical;}
    label{font-size:12px;color:var(--muted);display:block;margin:12px 0 6px;}

    /* hero: æ˜ã‚‹ã */
    .hero{
      border:1px solid var(--line);
      background: linear-gradient(180deg, rgba(34,197,94,.08), rgba(6,182,212,.06));
      border-radius: 18px;
      padding: 14px;
    }
    .heroTop{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:12px;
      flex-wrap:wrap;
    }
    .heroTitle{
      margin:0;
      font-size:20px;
      letter-spacing:.2px;
    }
    .heroCTA{display:flex;gap:10px;flex-wrap:wrap;}

    .bigAction{
      margin-top:12px;
      padding:14px;
      border-radius:18px;
      border:1px dashed rgba(100,116,139,.35);
      background: rgba(255,255,255,.55);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      cursor:pointer;
    }
    .bigAction strong{font-size:15px;}
    .bigAction span{display:block;color:var(--muted);font-size:12px;margin-top:4px;}

    /* pills row */
    .miniPills{
      display:flex;gap:10px;flex-wrap:wrap;align-items:center;
      margin-top:12px;
    }

    /* plant grid */
    .plantGrid{
      display:grid;
      gap:12px;
      grid-template-columns: repeat(2, minmax(0,1fr));
    }
    @media(min-width:860px){ .plantGrid{grid-template-columns: repeat(3, minmax(0,1fr));} }

    .plantCard{
      border:1px solid var(--line);
      border-radius: 18px;
      overflow:hidden;
      background: rgba(255,255,255,.9);
      box-shadow: var(--shadow);
      cursor:pointer;
    }
    .thumb{
      height:130px;
      background: linear-gradient(90deg, rgba(34,197,94,.10), rgba(6,182,212,.10));
      position:relative;
    }
    .thumb img{
      width:100%;height:100%;
      object-fit:cover;display:block;
    }
    .badge{
      position:absolute;left:10px;top:10px;
      font-size:12px;
      color:#052014;
      background: rgba(255,255,255,.85);
      border:1px solid var(--line);
      padding:6px 10px;
      border-radius:999px;
      font-weight:800;
      backdrop-filter: blur(8px);
    }
    .plantBody{padding:12px;}
    .plantName{margin:0;font-size:15px;line-height:1.25;}
    .plantMeta{margin:6px 0 0;color:var(--muted);font-size:12px;line-height:1.45;}

    .chips{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .chip{
      font-size:12px;
      color:var(--text);
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background: rgba(251,252,255,.9);
    }

    /* tasks */
    .tasks{display:grid;gap:10px;margin-top:12px}
    .task{
      display:flex;gap:10px;align-items:flex-start;
      padding:12px;
      border-radius:16px;
      border:1px solid var(--line);
      background: rgba(251,252,255,.92);
    }
    .task input{width:auto;margin-top:2px}
    .taskTitle{font-weight:900}
    .taskSub{color:var(--muted);font-size:12px;margin-top:2px}

    /* Modal */
    .modalBack{
      position:fixed;inset:0;
      background: rgba(15,23,42,.35);
      display:none;
      align-items:flex-end;
      justify-content:center;
      padding: 18px;
      z-index:50;
    }
    .modal{
      width:min(720px, 100%);
      border-radius: 20px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.95);
      backdrop-filter: blur(10px);
      box-shadow: 0 30px 80px rgba(15,23,42,.18);
      overflow:hidden;
    }
    .modalHeader{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:14px 14px;
      border-bottom:1px solid var(--line);
    }
    .modalHeader strong{font-size:15px}
    .x{
      background:transparent;
      border:1px solid var(--line);
      color:var(--text);
      border-radius:12px;
      padding:8px 10px;
      cursor:pointer
    }
    .modalBody{padding:14px}
    .modalImg{
      width:100%;
      height:220px;
      border-radius:16px;
      object-fit:cover;
      border:1px solid var(--line)
    }
    .tiny{font-size:12px;color:var(--muted)}
    a{color:#0284c7}
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="topline">
        <div class="brand">
          <div class="logo">ğŸŒ¿</div>
          <div>
            <h1>PlantLog</h1>
            <div class="subtitle">ç›®ãŒç–²ã‚Œãªã„ãƒ©ã‚¤ãƒˆãƒ†ãƒ¼ãƒ / è‡ªåˆ†ç”¨</div>
          </div>
        </div>
        <div class="pill" id="statusPill">ä¿å­˜: localStorage</div>
      </div>

      <div class="tabs" id="tabs">
        <div class="tab active" data-tab="today">ğŸ  ä»Šæ—¥</div>
        <div class="tab" data-tab="plants">ğŸŒ¿ æ¤ç‰©</div>
        <div class="tab" data-tab="add">â• è¿½åŠ </div>
        <div class="tab" data-tab="diag">ğŸ©º ç—…æ°—ãƒã‚§ãƒƒã‚¯</div>
        <div class="tab" data-tab="backup">ğŸ’¾ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—</div>
      </div>
    </header>

    <main class="grid" style="margin-top:14px">
      <!-- TODAY -->
      <section class="card" id="view-today">
        <div class="hero">
          <div class="heroTop">
            <div>
              <h2 class="heroTitle">ä»Šæ—¥ã‚„ã‚‹ã“ã¨</h2>
              <div class="sub">æœŸé™ãƒ™ãƒ¼ã‚¹ï¼‹ãƒã‚§ãƒƒã‚¯å¼ã€‚å¿…è¦ãªã‚‰å†™çœŸã§â€œçŠ¶æ…‹ãƒã‚§ãƒƒã‚¯â€ã‚‚ã€‚</div>
            </div>
            <div class="heroCTA">
              <button class="btn small" id="goAdd">â• æ¤ç‰©ã‚’è¿½åŠ </button>
              <button class="btn small ghost" id="goPlants">ğŸŒ¿ ä¸€è¦§ã‚’è¦‹ã‚‹</button>
            </div>
          </div>

          <div class="bigAction" id="quickDiag" role="button" aria-label="å†™çœŸã§çŠ¶æ…‹ãƒã‚§ãƒƒã‚¯ã¸">
            <div>
              <strong>ğŸ“¸ å†™çœŸã§çŠ¶æ…‹ãƒã‚§ãƒƒã‚¯</strong>
              <span>å†™çœŸ â†’ ç—‡çŠ¶è³ªå• â†’ åŸå› å€™è£œã¨å¯¾å‡¦ï¼ˆã¾ãšã¯ãƒ«ãƒ¼ãƒ«å¼ï¼‰</span>
            </div>
            <button class="btn small ghost" type="button">é–‹ã</button>
          </div>

          <div class="miniPills">
            <span class="pill" id="countPill">ç™»éŒ² 0</span>
            <span class="pill" id="duePill">æœŸé™ã‚¿ã‚¹ã‚¯ 0</span>
            <span class="pill">
              æœŸé™(æ—¥)
              <input id="daysWindow" type="number" min="0" value="3" style="width:90px;margin-left:8px;background:transparent;border:none;outline:none;color:var(--text)" />
            </span>
          </div>

          <div class="tasks" id="taskList"></div>
          <div class="tiny" id="taskEmpty" style="margin-top:8px;display:none">ä»Šæ—¥ã‚„ã‚‹ã“ã¨ï¼šãªã—</div>
        </div>
      </section>

      <!-- PLANTS -->
      <section class="card" id="view-plants" style="display:none">
        <div class="row" style="justify-content:space-between">
          <div>
            <h2>æ¤ç‰©</h2>
            <div class="sub">å†™çœŸã‚«ãƒ¼ãƒ‰ç®¡ç†ã€‚ã‚¿ãƒƒãƒ—ã§è©³ç´°ï¼ˆè‡ªå‹•èª¬æ˜ã¤ãï¼‰ã€‚</div>
          </div>
          <button class="btn small" id="addFromPlants">â• è¿½åŠ </button>
        </div>

        <div class="hr"></div>

        <div class="plantGrid" id="plantGrid"></div>
        <div class="tiny" id="plantEmpty" style="display:none;margin-top:10px">
          ã¾ã æ¤ç‰©ãŒã‚ã‚Šã¾ã›ã‚“ã€‚â•è¿½åŠ  ã‹ã‚‰1ã¤ç™»éŒ²ã—ã¦ã¿ã¦ã€‚
        </div>
      </section>

      <!-- ADD -->
      <section class="card" id="view-add" style="display:none">
        <h2>æ¤ç‰©ã‚’è¿½åŠ </h2>
        <div class="sub">ç™»éŒ²æ™‚ã« Wikipedia ã‹ã‚‰èª¬æ˜ã‚’è‡ªå‹•å–å¾—ï¼ˆç„¡æ–™ï¼‰ã€‚å–ã‚Œãªã„æ™‚ã¯ç©ºã®ã¾ã¾ã€‚</div>

        <div class="split" style="margin-top:12px">
          <div class="card" style="padding:14px;background:var(--panel2);box-shadow:none;border:1px solid var(--line)">
            <label>å†™çœŸï¼ˆã‚«ãƒ¡ãƒ©/ã‚¢ãƒ«ãƒãƒ ï¼‰</label>
            <input id="photoInput" type="file" accept="image/*" capture="environment" />
            <div style="margin-top:10px">
              <img id="photoPreview" class="modalImg" style="height:200px;display:none" />
              <div class="tiny" id="photoHint">â€» å†™çœŸã¯ç«¯æœ«å†…ä¿å­˜ï¼ˆã‚¯ãƒ©ã‚¦ãƒ‰é€ä¿¡ãªã—ï¼‰</div>
            </div>

            <label style="margin-top:12px">åå‰</label>
            <input id="nameInput" placeholder="ä¾‹ï¼šãƒ¢ãƒ³ã‚¹ãƒ†ãƒ© / ã‚³ãƒ«ã‚¸ãƒªãƒ" />

            <label>ç¨®ï¼ˆç·‘ç¨®ï¼‰</label>
            <input id="speciesInput" placeholder="ä¾‹ï¼šMonstera deliciosa / è¦³è‘‰æ¤ç‰©" />

            <label>ç½®ãå ´æ‰€</label>
            <input id="locInput" placeholder="ä¾‹ï¼šãƒªãƒ“ãƒ³ã‚°çª“éš› / æ¸©å®¤" />

            <div class="row" style="margin-top:10px">
              <div style="flex:1">
                <label>æ°´ã‚„ã‚Šå‘¨æœŸï¼ˆæ—¥ï¼‰</label>
                <input id="waterEvery" type="number" min="0" value="7" />
              </div>
              <div style="flex:1">
                <label>è‚¥æ–™å‘¨æœŸï¼ˆæ—¥ï¼‰</label>
                <input id="fertEvery" type="number" min="0" value="30" />
              </div>
              <div style="flex:1">
                <label>å‰ªå®šå‘¨æœŸï¼ˆæ—¥ï¼‰</label>
                <input id="pruneEvery" type="number" min="0" value="90" />
              </div>
            </div>

            <label>ãƒ¡ãƒ¢</label>
            <textarea id="memoInput" placeholder="ä¾‹ï¼šè‘‰æ°´ã¯é€±2ã€å†¬ã¯æ§ãˆã‚ã€‚"></textarea>

            <div class="row" style="margin-top:12px">
              <button class="btn" id="savePlant">âœ… ç™»éŒ²ã™ã‚‹</button>
              <button class="btn ghost" id="resetAdd">ãƒªã‚»ãƒƒãƒˆ</button>
            </div>
          </div>

          <div class="card" style="padding:14px;background:var(--panel2);box-shadow:none;border:1px solid var(--line)">
            <h3 style="margin:0 0 8px">ã‚³ãƒ„</h3>
            <div class="sub">
              ãƒ»èª¬æ˜ãŒå–ã‚Œãªã„æ™‚ã¯ã€è¡¨è¨˜ã‚’å¤‰ãˆã‚‹ã¨å–ã‚Œã‚‹ï¼ˆä¾‹ï¼šå­¦åï¼åˆ¥åï¼‰ã€‚<br/>
              ãƒ»å†™çœŸãŒãªãã¦ã‚‚OKï¼ˆWikipediaã®ã‚µãƒ ãƒãŒå‡ºã‚‹å ´åˆã‚ã‚Šï¼‰ã€‚
            </div>
            <div class="hr"></div>
            <div class="tiny">æ¬¡ã®å¼·åŒ–ï¼ˆä»»æ„ï¼‰</div>
            <div class="row" style="margin-top:10px">
              <span class="pill">ğŸ§¾ ä½œæ¥­å±¥æ­´</span>
              <span class="pill">ğŸª´ ç½®ãå ´æ‰€ãƒ•ã‚£ãƒ«ã‚¿</span>
              <span class="pill">ğŸ¤– AIè‚²ã¦æ–¹</span>
            </div>
          </div>
        </div>
      </section>

      <!-- DIAG -->
      <section class="card" id="view-diag" style="display:none">
        <h2>ç—…æ°—ãƒã‚§ãƒƒã‚¯</h2>
        <div class="sub">å†™çœŸï¼‹ç—‡çŠ¶ãƒã‚§ãƒƒã‚¯ã§åŸå› å€™è£œã¨å¯¾å‡¦ï¼ˆä»Šã¯ãƒ«ãƒ¼ãƒ«å¼ï¼‰ã€‚</div>

        <div class="split" style="margin-top:12px">
          <div class="card" style="padding:14px;background:var(--panel2);box-shadow:none;border:1px solid var(--line)">
            <label>å†™çœŸï¼ˆä»»æ„ï¼‰</label>
            <input id="diagPhotoInput" type="file" accept="image/*" capture="environment" />
            <img id="diagPreview" class="modalImg" style="height:200px;display:none;margin-top:10px" />

            <label style="margin-top:12px">æ¤ç‰©ï¼ˆä»»æ„ï¼‰</label>
            <select id="diagPlantSelect"></select>

            <label style="margin-top:12px">ç—‡çŠ¶ï¼ˆå½“ã¦ã¯ã¾ã‚‹ã‚‚ã®ï¼‰</label>
            <div class="row">
              <label style="flex:1"><input type="checkbox" class="sym" value="yellow"> è‘‰ãŒé»„ã°ã‚€</label>
              <label style="flex:1"><input type="checkbox" class="sym" value="spots"> æ–‘ç‚¹/ã‚·ãƒŸ</label>
              <label style="flex:1"><input type="checkbox" class="sym" value="wilting"> ã—ãŠã‚Œã‚‹</label>
            </div>
            <div class="row">
              <label style="flex:1"><input type="checkbox" class="sym" value="bugs"> è™«/ãƒ™ã‚¿ã¤ã</label>
              <label style="flex:1"><input type="checkbox" class="sym" value="mold"> ã‚«ãƒ“/ç™½ã„ç²‰</label>
              <label style="flex:1"><input type="checkbox" class="sym" value="brown"> èŒ¶è‰²ãæ¯ã‚Œã‚‹</label>
            </div>

            <label style="margin-top:12px">çŠ¶æ³</label>
            <div class="row">
              <div style="flex:1">
                <label style="margin-top:0">ç›´è¿‘ã§æ°´ã‚„ã‚Šå¤šã‚ï¼Ÿ</label>
                <select id="ctxWater">
                  <option value="unknown">ã‚ã‹ã‚‰ãªã„</option>
                  <option value="more">å¤šã‚</option>
                  <option value="less">å°‘ãªã‚</option>
                </select>
              </div>
              <div style="flex:1">
                <label style="margin-top:0">æ—¥å½“ãŸã‚Š</label>
                <select id="ctxLight">
                  <option value="unknown">ã‚ã‹ã‚‰ãªã„</option>
                  <option value="strong">å¼·ã„</option>
                  <option value="weak">å¼±ã„</option>
                </select>
              </div>
              <div style="flex:1">
                <label style="margin-top:0">é¢¨é€šã—</label>
                <select id="ctxAir">
                  <option value="unknown">ã‚ã‹ã‚‰ãªã„</option>
                  <option value="good">è‰¯ã„</option>
                  <option value="bad">æ‚ªã„</option>
                </select>
              </div>
            </div>

            <label>ãƒ¡ãƒ¢</label>
            <textarea id="diagMemo" placeholder="ä¾‹ï¼šæœ€è¿‘å¯’ã„ï¼åœŸãŒä¹¾ã‹ãªã„ãªã©"></textarea>

            <div class="row" style="margin-top:12px">
              <button class="btn" id="runDiag">ğŸ©º åˆ¤å®šã™ã‚‹</button>
              <button class="btn ghost" id="resetDiag">ãƒªã‚»ãƒƒãƒˆ</button>
            </div>
          </div>

          <div class="card" style="padding:14px;background:var(--panel2);box-shadow:none;border:1px solid var(--line)">
            <h3 style="margin:0 0 8px">çµæœ</h3>
            <div class="sub">ã¾ã åˆ¤å®šã—ã¦ãªã„ã€‚</div>
            <div class="hr"></div>
            <div id="diagResult" class="sub">ç—‡çŠ¶ã‚’é¸ã‚“ã§ã€Œåˆ¤å®šã™ã‚‹ã€ã‚’æŠ¼ã—ã¦ã€‚</div>
          </div>
        </div>
      </section>

      <!-- BACKUP -->
      <section class="card" id="view-backup" style="display:none">
        <h2>ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—</h2>
        <div class="sub">ãƒ‡ãƒ¼ã‚¿ã¯ç«¯æœ«å†…ï¼ˆlocalStorageï¼‰ã€‚ãƒ•ã‚¡ã‚¤ãƒ«ã§ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—/å¾©å…ƒã€‚</div>

        <div class="split" style="margin-top:12px">
          <div class="card" style="padding:14px;background:var(--panel2);box-shadow:none;border:1px solid var(--line)">
            <h3 style="margin:0 0 8px">ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</h3>
            <div class="sub">JSONã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦ä¿ç®¡ã€‚</div>
            <div class="row" style="margin-top:10px">
              <button class="btn" id="exportBtn">â¬‡ï¸ JSONæ›¸ãå‡ºã—</button>
              <button class="btn ghost" id="exportIcsBtn">ğŸ“† icsç”Ÿæˆ</button>
            </div>
          </div>

          <div class="card" style="padding:14px;background:var(--panel2);box-shadow:none;border:1px solid var(--line)">
            <h3 style="margin:0 0 8px">ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</h3>
            <div class="sub">JSONã‚’èª­ã¿è¾¼ã‚“ã§å¾©å…ƒã€‚</div>
            <input id="importInput" type="file" accept="application/json" />
            <div class="row" style="margin-top:10px">
              <button class="btn" id="importBtn">â¬†ï¸ å¾©å…ƒã™ã‚‹</button>
              <button class="btn danger" id="wipeBtn">ğŸ§¨ å…¨å‰Šé™¤</button>
            </div>
            <div class="tiny" style="margin-top:10px;color:#b91c1c">å…¨å‰Šé™¤ã¯æˆ»ã›ãªã„ï¼ˆãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—æ¨å¥¨ï¼‰</div>
          </div>
        </div>
      </section>
    </main>
  </div>

  <!-- Modal (plant detail) -->
  <div class="modalBack" id="modalBack">
    <div class="modal">
      <div class="modalHeader">
        <strong id="modalTitle">è©³ç´°</strong>
        <button class="x" id="closeModal">é–‰ã˜ã‚‹</button>
      </div>
      <div class="modalBody" id="modalBody"></div>
    </div>
  </div>

  <script>
    // =========================
    // Utils
    // =========================
    const LS_KEY = "plantlog_light_v1";
    const $ = (id) => document.getElementById(id);

    function nowISO(){ return new Date().toISOString(); }
    function clampInt(n, def=0){ n = parseInt(n,10); return Number.isFinite(n) ? n : def; }
    function escapeHtml(s=""){
      return String(s).replace(/[&<>"']/g, m => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
      }[m]));
    }
    function toDateOnly(d){
      const x = new Date(d);
      x.setHours(0,0,0,0);
      return x;
    }
    function addDays(date, days){
      const d = new Date(date);
      d.setDate(d.getDate() + days);
      return d;
    }
    function fmtDate(d){
      const x = new Date(d);
      const y = x.getFullYear();
      const m = String(x.getMonth()+1).padStart(2,"0");
      const dd = String(x.getDate()).padStart(2,"0");
      return `${y}-${m}-${dd}`;
    }
    function fileToDataUrl(file){
      return new Promise((resolve,reject)=>{
        const r = new FileReader();
        r.onload = ()=> resolve(r.result);
        r.onerror = reject;
        r.readAsDataURL(file);
      });
    }
    function newId(){
      return "p_" + Math.random().toString(36).slice(2,10) + "_" + Date.now().toString(36);
    }

    // =========================
    // Wikipediaï¼ˆç„¡æ–™ï¼‰ã§èª¬æ˜ã‚’è‡ªå‹•å–å¾—
    // =========================
    async function fetchWikiSummary(title, lang = "ja") {
      const url = `https://${lang}.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(title)}`;
      try {
        const res = await fetch(url, { headers: { accept: "application/json" } });
        if (!res.ok) return null;
        const data = await res.json();
        if (!data.extract || data.type === "disambiguation") return null;
        return {
          source: `wikipedia:${lang}`,
          title: data.title || title,
          extract: data.extract,
          thumbnail: data.thumbnail?.source || "",
          pageUrl: data.content_urls?.desktop?.page || ""
        };
      } catch {
        return null;
      }
    }
    async function getAutoDescription(name) {
      let info = await fetchWikiSummary(name, "ja");
      if (!info) info = await fetchWikiSummary(name, "en");
      return info; // nullã‚ã‚Š
    }

    // =========================
    // Data
    // =========================
    function loadState(){
      const raw = localStorage.getItem(LS_KEY);
      if(!raw) return { plants: [] };
      try{
        const st = JSON.parse(raw);
        if(!st || !Array.isArray(st.plants)) return { plants: [] };
        return st;
      }catch{
        return { plants: [] };
      }
    }
    function saveState(st){
      localStorage.setItem(LS_KEY, JSON.stringify(st));
      $("statusPill").textContent = "ä¿å­˜: localStorage âœ“";
      setTimeout(()=> $("statusPill").textContent = "ä¿å­˜: localStorage", 800);
    }
    let state = loadState();

    // plant schema:
    // {
    //  id, name, species, location, memo,
    //  photoDataUrl,
    //  waterEvery, fertEvery, pruneEvery,
    //  createdAt,
    //  lastWaterAt, lastFertAt, lastPruneAt,
    //  autoDesc, autoSource, autoTitle, autoThumb, autoUrl
    // }

    // =========================
    // Tabs
    // =========================
    const views = ["today","plants","add","diag","backup"];
    function showTab(tab){
      views.forEach(v => $("view-"+v).style.display = (v===tab) ? "" : "none");
      document.querySelectorAll(".tab").forEach(el=>{
        el.classList.toggle("active", el.dataset.tab === tab);
      });
      if(tab==="plants") renderPlants();
      if(tab==="today") renderToday();
      if(tab==="diag") refreshDiagSelect();
    }

    $("tabs").addEventListener("click", (e)=>{
      const t = e.target.closest(".tab");
      if(!t) return;
      showTab(t.dataset.tab);
    });

    $("goAdd").onclick = ()=> showTab("add");
    $("goPlants").onclick = ()=> showTab("plants");
    $("addFromPlants").onclick = ()=> showTab("add");
    $("quickDiag").onclick = ()=> showTab("diag");

    // =========================
    // Add
    // =========================
    $("photoInput").addEventListener("change", async ()=>{
      const f = $("photoInput").files?.[0];
      if(!f) return;
      const dataUrl = await fileToDataUrl(f);
      $("photoPreview").src = dataUrl;
      $("photoPreview").style.display = "";
      $("photoHint").textContent = "â€» å†™çœŸã¯ç«¯æœ«å†…ä¿å­˜ï¼ˆã‚¯ãƒ©ã‚¦ãƒ‰é€ä¿¡ãªã—ï¼‰";
    });

    $("resetAdd").onclick = ()=>{
      $("photoInput").value = "";
      $("photoPreview").style.display = "none";
      $("nameInput").value = "";
      $("speciesInput").value = "";
      $("locInput").value = "";
      $("waterEvery").value = "7";
      $("fertEvery").value = "30";
      $("pruneEvery").value = "90";
      $("memoInput").value = "";
      $("photoHint").textContent = "â€» å†™çœŸã¯ç«¯æœ«å†…ä¿å­˜ï¼ˆã‚¯ãƒ©ã‚¦ãƒ‰é€ä¿¡ãªã—ï¼‰";
    };

    $("savePlant").onclick = async ()=>{
      const name = $("nameInput").value.trim();
      if(!name){ alert("åå‰ã‚’å…¥ã‚Œã¦ã€‚"); return; }

      const btn = $("savePlant");
      const prevText = btn.textContent;
      btn.textContent = "â³ èª¬æ˜å–å¾—ä¸­â€¦";
      btn.disabled = true;

      const species = $("speciesInput").value.trim();
      const location = $("locInput").value.trim();
      const memo = $("memoInput").value.trim();
      const waterEvery = clampInt($("waterEvery").value, 0);
      const fertEvery = clampInt($("fertEvery").value, 0);
      const pruneEvery = clampInt($("pruneEvery").value, 0);

      let photoDataUrl = "";
      const f = $("photoInput").files?.[0];
      if(f){
        try { photoDataUrl = await fileToDataUrl(f); } catch {}
      } else if($("photoPreview").style.display !== "none" && $("photoPreview").src){
        photoDataUrl = $("photoPreview").src;
      }

      const auto = await getAutoDescription(name);

      const plant = {
        id: newId(),
        name, species, location, memo,
        photoDataUrl,
        waterEvery, fertEvery, pruneEvery,
        createdAt: nowISO(),
        lastWaterAt: nowISO(),
        lastFertAt: nowISO(),
        lastPruneAt: nowISO(),
        autoDesc: auto?.extract || "",
        autoSource: auto?.source || "",
        autoTitle: auto?.title || "",
        autoThumb: auto?.thumbnail || "",
        autoUrl: auto?.pageUrl || ""
      };

      state.plants.unshift(plant);
      saveState(state);

      btn.textContent = prevText;
      btn.disabled = false;

      $("resetAdd").click();
      showTab("plants");
    };

    // =========================
    // Plants
    // =========================
    function oneLineDesc(p){
      const s = (p.autoDesc || "").replace(/\s+/g," ").trim();
      if(!s) return "";
      return s.length > 52 ? s.slice(0,52) + "â€¦" : s;
    }

    function renderPlants(){
      const grid = $("plantGrid");
      grid.innerHTML = "";

      if(state.plants.length === 0){
        $("plantEmpty").style.display = "";
        return;
      }
      $("plantEmpty").style.display = "none";

      for(const p of state.plants){
        const card = document.createElement("div");
        card.className = "plantCard";

        const badge = p.location ? escapeHtml(p.location) : "ç™»éŒ²æ¸ˆ";
        const thumbUrl = p.photoDataUrl || p.autoThumb || "";
        const desc = oneLineDesc(p);

        card.innerHTML = `
          <div class="thumb">
            ${thumbUrl ? `<img src="${thumbUrl}" alt="">` : ""}
            <div class="badge">${badge}</div>
          </div>
          <div class="plantBody">
            <h3 class="plantName">${escapeHtml(p.name)}</h3>
            <div class="plantMeta">${desc ? escapeHtml(desc) : "èª¬æ˜ï¼šæœªå–å¾—ï¼ˆè¡¨è¨˜ã‚’å¤‰ãˆã‚‹ã¨å–ã‚Œã‚‹ã“ã¨ã‚ã‚Šï¼‰"}</div>
            <div class="chips">
              <span class="chip">ğŸ’§${p.waterEvery||0}æ—¥</span>
              <span class="chip">ğŸ§ª${p.fertEvery||0}æ—¥</span>
              <span class="chip">âœ‚ï¸${p.pruneEvery||0}æ—¥</span>
            </div>
          </div>
        `;
        card.onclick = ()=> openPlantModal(p.id);
        grid.appendChild(card);
      }

      refreshDiagSelect();
      renderToday();
    }

    // =========================
    // Modal detail
    // =========================
    function updatePlant(id, patch){
      const idx = state.plants.findIndex(x=>x.id===id);
      if(idx<0) return;
      state.plants[idx] = { ...state.plants[idx], ...patch };
      saveState(state);
      renderPlants();
    }

    function closeModal(){ $("modalBack").style.display = "none"; }
    $("closeModal").onclick = closeModal;
    $("modalBack").addEventListener("click", (e)=>{ if(e.target.id==="modalBack") closeModal(); });

    function openPlantModal(id){
      const p = state.plants.find(x=>x.id===id);
      if(!p) return;

      $("modalTitle").textContent = `è©³ç´°ï¼š${p.name}`;

      const imgUrl = p.photoDataUrl || p.autoThumb || "";
      const autoBlock = p.autoDesc ? `
        <div class="hr"></div>
        <div class="sub"><b>èª¬æ˜ï¼ˆè‡ªå‹•ï¼‰</b><br>${escapeHtml(p.autoDesc)}</div>
        <div class="tiny" style="margin-top:8px">
          å‡ºå…¸ï¼š${p.autoUrl ? `<a href="${p.autoUrl}" target="_blank" rel="noreferrer">Wikipedia</a>` : escapeHtml(p.autoSource || "")}
        </div>
      ` : `
        <div class="hr"></div>
        <div class="tiny">èª¬æ˜ãŒå–ã‚Œãªã‹ã£ãŸã€‚åˆ¥å/å­¦åã§å†ç™»éŒ²ã™ã‚‹ã¨å–ã‚Œã‚‹ã“ã¨ãŒã‚ã‚‹ã€‚</div>
      `;

      $("modalBody").innerHTML = `
        ${imgUrl ? `<img class="modalImg" src="${imgUrl}" alt="">` : ""}
        <div class="hr"></div>

        <div class="row">
          <div style="flex:1">
            <div class="tiny">ç¨®ï¼ˆç·‘ç¨®ï¼‰</div>
            <div class="sub">${escapeHtml(p.species || "â€”")}</div>
          </div>
          <div style="flex:1">
            <div class="tiny">ç½®ãå ´æ‰€</div>
            <div class="sub">${escapeHtml(p.location || "â€”")}</div>
          </div>
        </div>

        <div class="hr"></div>

        <div class="row">
          <button class="btn small" id="markWater">ğŸ’§ æ°´ã‚„ã‚Šã—ãŸ</button>
          <button class="btn small ghost" id="markFert">ğŸ§ª è‚¥æ–™ã—ãŸ</button>
          <button class="btn small ghost" id="markPrune">âœ‚ï¸ å‰ªå®šã—ãŸ</button>
        </div>

        <div class="hr"></div>

        <div class="row">
          <div style="flex:1">
            <div class="tiny">å‘¨æœŸ</div>
            <div class="sub">ğŸ’§ ${p.waterEvery||0}æ—¥ / ğŸ§ª ${p.fertEvery||0}æ—¥ / âœ‚ï¸ ${p.pruneEvery||0}æ—¥</div>
          </div>
          <div style="flex:1">
            <div class="tiny">æœ€çµ‚</div>
            <div class="sub">ğŸ’§ ${fmtDate(p.lastWaterAt)} / ğŸ§ª ${fmtDate(p.lastFertAt)} / âœ‚ï¸ ${fmtDate(p.lastPruneAt)}</div>
          </div>
        </div>

        <div class="hr"></div>
        <div class="tiny">ãƒ¡ãƒ¢</div>
        <div class="sub">${escapeHtml(p.memo || "â€”")}</div>

        ${autoBlock}

        <div class="hr"></div>
        <div class="row" style="justify-content:space-between">
          <button class="btn danger small" id="deletePlant">ğŸ§¨ å‰Šé™¤</button>
          <button class="btn small ghost" id="closePlant">é–‰ã˜ã‚‹</button>
        </div>
      `;

      $("modalBack").style.display = "flex";

      document.getElementById("closePlant").onclick = closeModal;
      document.getElementById("markWater").onclick = ()=>{ updatePlant(id,{lastWaterAt:nowISO()}); openPlantModal(id); renderToday(); };
      document.getElementById("markFert").onclick  = ()=>{ updatePlant(id,{lastFertAt:nowISO()}); openPlantModal(id); renderToday(); };
      document.getElementById("markPrune").onclick = ()=>{ updatePlant(id,{lastPruneAt:nowISO()}); openPlantModal(id); renderToday(); };
      document.getElementById("deletePlant").onclick = ()=>{
        if(!confirm("ã“ã®æ¤ç‰©ã‚’å‰Šé™¤ã™ã‚‹ï¼Ÿï¼ˆæˆ»ã›ãªã„ï¼‰")) return;
        state.plants = state.plants.filter(x=>x.id!==id);
        saveState(state);
        closeModal();
        renderPlants();
      };
    }

    // =========================
    // Today tasks
    // =========================
    function computeDueTasks(daysWindow){
      const today = toDateOnly(new Date());
      const until = addDays(today, daysWindow);
      const tasks = [];

      for(const p of state.plants){
        const items = [
          { kind:"water", label:"ğŸ’§ æ°´ã‚„ã‚Š", every:p.waterEvery||0, last:p.lastWaterAt },
          { kind:"fert",  label:"ğŸ§ª è‚¥æ–™",   every:p.fertEvery||0,  last:p.lastFertAt  },
          { kind:"prune", label:"âœ‚ï¸ å‰ªå®š",   every:p.pruneEvery||0, last:p.lastPruneAt },
        ];
        for(const it of items){
          if(!it.every || it.every<=0) continue;
          const due = addDays(toDateOnly(it.last || p.createdAt), it.every);
          if(due >= today && due <= until){
            tasks.push({
              id: `${p.id}:${it.kind}:${fmtDate(due)}`,
              plantId: p.id,
              plantName: p.name,
              kind: it.kind,
              label: it.label,
              due
            });
          }
        }
      }
      tasks.sort((a,b)=> a.due - b.due);
      return tasks;
    }

    function renderToday(){
      $("countPill").textContent = `ç™»éŒ² ${state.plants.length}`;

      const days = clampInt($("daysWindow").value, 3);
      const tasks = computeDueTasks(days);
      $("duePill").textContent = `æœŸé™ã‚¿ã‚¹ã‚¯ ${tasks.length}`;

      const list = $("taskList");
      list.innerHTML = "";

      if(tasks.length === 0){
        $("taskEmpty").style.display = "";
        return;
      }
      $("taskEmpty").style.display = "none";

      for(const t of tasks){
        const row = document.createElement("div");
        row.className = "task";
        row.innerHTML = `
          <input type="checkbox">
          <div style="flex:1">
            <div class="taskTitle">${escapeHtml(t.label)}ï¼š${escapeHtml(t.plantName)}</div>
            <div class="taskSub">æœŸé™ï¼š${fmtDate(t.due)}ï¼ˆ${days}æ—¥ä»¥å†…ï¼‰</div>
          </div>
          <button class="btn small ghost">è©³ç´°</button>
        `;
        const chk = row.querySelector("input");
        const btn = row.querySelector("button");
        btn.onclick = ()=> openPlantModal(t.plantId);
        chk.onchange = ()=>{
          if(!chk.checked) return;
          if(t.kind==="water") updatePlant(t.plantId, { lastWaterAt: nowISO() });
          if(t.kind==="fert")  updatePlant(t.plantId, { lastFertAt: nowISO() });
          if(t.kind==="prune") updatePlant(t.plantId, { lastPruneAt: nowISO() });
          renderToday();
        };
        list.appendChild(row);
      }
    }
    $("daysWindow").addEventListener("change", renderToday);

    // =========================
    // DIAG
    // =========================
    function refreshDiagSelect(){
      const sel = $("diagPlantSelect");
      sel.innerHTML = `<option value="">ï¼ˆé¸ã°ãªã„ï¼‰</option>`;
      for(const p of state.plants){
        const opt = document.createElement("option");
        opt.value = p.id;
        opt.textContent = p.name;
        sel.appendChild(opt);
      }
    }

    $("diagPhotoInput").addEventListener("change", async ()=>{
      const f = $("diagPhotoInput").files?.[0];
      if(!f) return;
      const dataUrl = await fileToDataUrl(f);
      $("diagPreview").src = dataUrl;
      $("diagPreview").style.display = "";
    });

    function diagRule(sym, ctx){
      const score = new Map();
      const add = (k,v)=> score.set(k,(score.get(k)||0)+v);

      if(sym.includes("yellow")){
        add("æ°´ã®ã‚„ã‚Šã™ãï¼ˆæ ¹è…ã‚Œï¼‰", 2);
        add("è‚¥æ–™ä¸è¶³/çª’ç´ ä¸è¶³", 1);
        add("å¯’ã•/æ¸©åº¦ã‚¹ãƒˆãƒ¬ã‚¹", 1);
      }
      if(sym.includes("spots")){
        add("è‘‰ç„¼ã‘ï¼ˆå¼·å…‰ï¼‰", 2);
        add("ç—…æ°—ï¼ˆã‚«ãƒ“/ç´°èŒï¼‰", 2);
        add("æ°´æ»´ï¼‹æ—¥å…‰ï¼ˆãƒ¬ãƒ³ã‚ºç„¼ã‘ï¼‰", 1);
      }
      if(sym.includes("wilting")){
        add("æ°´åˆ‡ã‚Œ", 2);
        add("æ ¹è…ã‚Œï¼ˆå¸ãˆãªã„ï¼‰", 2);
        add("é«˜æ¸©/ä¹¾ç‡¥ã‚¹ãƒˆãƒ¬ã‚¹", 1);
      }
      if(sym.includes("bugs")){
        add("ãƒãƒ€ãƒ‹/ã‚¢ãƒ–ãƒ©ãƒ ã‚·ç­‰ã®å®³è™«", 3);
        add("é¢¨é€šã—ä¸è¶³", 1);
      }
      if(sym.includes("mold")){
        add("é¢¨é€šã—ä¸è¶³ï¼ˆã‚«ãƒ“ï¼‰", 3);
        add("éæ¹¿", 2);
      }
      if(sym.includes("brown")){
        add("æ°´åˆ‡ã‚Œ/ä¹¾ç‡¥", 2);
        add("è‘‰ç„¼ã‘/ç›´å°„", 2);
        add("è‚¥æ–™æ¿ƒåº¦ãŒå¼·ã„", 1);
      }

      if(ctx.water==="more") add("æ°´ã®ã‚„ã‚Šã™ãï¼ˆæ ¹è…ã‚Œï¼‰", 2);
      if(ctx.water==="less") add("æ°´åˆ‡ã‚Œ", 2);
      if(ctx.light==="strong") add("è‘‰ç„¼ã‘ï¼ˆå¼·å…‰ï¼‰", 2);
      if(ctx.light==="weak") add("æ—¥ç…§ä¸è¶³", 2);
      if(ctx.air==="bad") add("é¢¨é€šã—ä¸è¶³ï¼ˆã‚«ãƒ“ï¼‰", 2);

      const ranked = [...score.entries()].sort((a,b)=> b[1]-a[1]).slice(0,3);
      const tips = [
        "ãƒ»åœŸãŒæ¹¿ã‚Šã£ã±ãªã—ãªã‚‰ï¼šä¹¾ã‹ã—æ°—å‘³ï¼‹é‰¢åº•/æ ¹ã‚’ç¢ºèª",
        "ãƒ»è‘‰ç„¼ã‘ç–‘ã„ï¼šé®å…‰ï¼ˆãƒ¬ãƒ¼ã‚¹è¶Šã—ï¼‰ï¼‹è‘‰æ°´ã¯æœã€œå¤•",
        "ãƒ»å®³è™«ç–‘ã„ï¼šè‘‰è£ãƒã‚§ãƒƒã‚¯â†’ã‚·ãƒ£ãƒ¯ãƒ¼â†’å¿…è¦ãªã‚‰è–¬å‰¤",
        "ãƒ»ã‚«ãƒ“ç–‘ã„ï¼šé¢¨é€šã—æ”¹å–„ï¼‹åœŸè¡¨é¢ã‚’ä¹¾ã‹ã™"
      ];
      return { ranked, tips };
    }

    $("runDiag").onclick = ()=>{
      const sym = [...document.querySelectorAll(".sym:checked")].map(x=>x.value);
      const ctx = { water:$("ctxWater").value, light:$("ctxLight").value, air:$("ctxAir").value };
      const plantId = $("diagPlantSelect").value;
      const plant = plantId ? state.plants.find(p=>p.id===plantId) : null;

      if(sym.length===0 && !plant){
        $("diagResult").innerHTML = "ç—‡çŠ¶ãƒã‚§ãƒƒã‚¯ã‚’å…¥ã‚Œã‚‹ã‹ã€æ¤ç‰©ã‚’é¸ã‚“ã§ã€‚";
        return;
      }

      const r = diagRule(sym, ctx);
      const top = r.ranked.length
        ? r.ranked.map(([k,v],i)=> `<div class="sub"><b>TOP${i+1}</b>ï¼š${escapeHtml(k)} <span class="tiny">ï¼ˆ${v}ï¼‰</span></div>`).join("")
        : `<div class="sub">æƒ…å ±ãŒå°‘ãªãã¦ç‰¹å®šã§ããªã„ã€‚ç—‡çŠ¶ãƒã‚§ãƒƒã‚¯ã‚’å¢—ã‚„ã—ã¦ã€‚</div>`;

      $("diagResult").innerHTML = `
        ${plant ? `<div class="tiny">å¯¾è±¡ï¼š${escapeHtml(plant.name)}</div>` : ""}
        <div class="hr"></div>
        ${top}
        <div class="hr"></div>
        <div class="tiny">ã¾ãšã®å¯¾å‡¦ï¼ˆå®‰å…¨å´ï¼‰</div>
        <div class="sub">${r.tips.map(t=>escapeHtml(t)).join("<br>")}</div>
      `;
    };

    $("resetDiag").onclick = ()=>{
      document.querySelectorAll(".sym").forEach(x=>x.checked=false);
      $("ctxWater").value = "unknown";
      $("ctxLight").value = "unknown";
      $("ctxAir").value = "unknown";
      $("diagMemo").value = "";
      $("diagPlantSelect").value = "";
      $("diagPhotoInput").value = "";
      $("diagPreview").style.display = "none";
      $("diagResult").textContent = "ç—‡çŠ¶ã‚’é¸ã‚“ã§ã€Œåˆ¤å®šã™ã‚‹ã€ã‚’æŠ¼ã—ã¦ã€‚";
    };

    // =========================
    // Backup
    // =========================
    function downloadText(filename, text, mime="application/json"){
      const blob = new Blob([text], { type: mime });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    $("exportBtn").onclick = ()=>{
      const payload = JSON.stringify(state, null, 2);
      downloadText(`plantlog_backup_${fmtDate(new Date())}.json`, payload, "application/json");
    };

    $("importBtn").onclick = async ()=>{
      const f = $("importInput").files?.[0];
      if(!f){ alert("JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸ã‚“ã§ã€‚"); return; }
      try{
        const text = await f.text();
        const obj = JSON.parse(text);
        if(!obj || !Array.isArray(obj.plants)) throw new Error("format");
        state = obj;
        saveState(state);
        alert("å¾©å…ƒOKã€‚");
        renderPlants();
        showTab("today");
      }catch{
        alert("èª­ã¿è¾¼ã¿å¤±æ•—ã€‚PlantLogã®JSONã˜ã‚ƒãªã„å¯èƒ½æ€§ã€‚");
      }
    };

    $("wipeBtn").onclick = ()=>{
      if(!confirm("å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã™ã‚‹ï¼Ÿï¼ˆæˆ»ã›ãªã„ï¼‰")) return;
      state = { plants: [] };
      saveState(state);
      renderPlants();
      renderToday();
      alert("å…¨å‰Šé™¤ã—ãŸã€‚");
    };

    // =========================
    // ICS
    // =========================
    function icsEscape(s=""){
      return String(s).replace(/\\/g,"\\\\").replace(/\n/g,"\\n").replace(/,/g,"\\,").replace(/;/g,"\\;");
    }
    function toIcsDate(d){
      const x = new Date(d);
      const y = x.getFullYear();
      const m = String(x.getMonth()+1).padStart(2,"0");
      const dd = String(x.getDate()).padStart(2,"0");
      return `${y}${m}${dd}`;
    }
    function genIcsForDue(daysWindow=60){
      const tasks = computeDueTasks(daysWindow);
      const lines = [];
      lines.push("BEGIN:VCALENDAR");
      lines.push("VERSION:2.0");
      lines.push("PRODID:-//PlantLog//JP//EN");
      for(const t of tasks){
        const uid = icsEscape(t.id) + "@plantlog";
        const dt = toIcsDate(t.due);
        lines.push("BEGIN:VEVENT");
        lines.push(`UID:${uid}`);
        lines.push(`DTSTAMP:${toIcsDate(new Date())}T000000Z`);
        lines.push(`DTSTART;VALUE=DATE:${dt}`);
        lines.push(`SUMMARY:${icsEscape(`${t.label}ï¼š${t.plantName}`)}`);
        lines.push(`DESCRIPTION:${icsEscape("PlantLog æœŸé™ã‚¿ã‚¹ã‚¯ï¼ˆè‡ªå‹•ç”Ÿæˆï¼‰")}`);
        lines.push("END:VEVENT");
      }
      lines.push("END:VCALENDAR");
      return lines.join("\r\n");
    }
    $("exportIcsBtn").onclick = ()=>{
      const ics = genIcsForDue(60);
      downloadText(`plantlog_due_${fmtDate(new Date())}.ics`, ics, "text/calendar");
      alert("icsã‚’ä½œã£ãŸã€‚ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã«å–ã‚Šè¾¼ã‚ã°é€šçŸ¥ã§ãã‚‹ã€‚");
    };

    // =========================
    // Init
    // =========================
    function renderHeaderPills(){
      $("statusPill").textContent = "ä¿å­˜: localStorage";
    }
    renderHeaderPills();
    renderPlants();
    renderToday();
    refreshDiagSelect();
    showTab("today");
  </script>
</body>
</html>
