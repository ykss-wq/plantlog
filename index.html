<!doctype html>
<html lang="ja" data-theme="beige">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>PlantLog</title>
  <meta name="theme-color" content="#f4efe6" />
  <style>
    :root{
      --bg:#f4efe6; --panel:#ffffff; --panel2:#fbf7f0; --line:#e7ded2;
      --text:#2b2b2b; --muted:#7a756b;
      --accent:#6a8f6a; --accent2:#94b594;
      --warn:#f59e0b; --danger:#ef4444; --ok:#10b981;
      --shadow:0 12px 30px rgba(60,40,20,.10); --shadow2:0 6px 18px rgba(60,40,20,.08);
      --radius:22px; --tap:.985;
    }
    [data-theme="dark"]{
      --bg:#070b10; --panel:rgba(15,23,34,.92); --panel2:rgba(12,19,32,.84); --line:rgba(255,255,255,.12);
      --text:#e9eef6; --muted:#9bb0c6;
      --accent:#26e39b; --accent2:#2bd3ff;
      --warn:#ffcc66; --danger:#ff6b6b; --ok:#34d399;
      --shadow:0 18px 50px rgba(0,0,0,.45); --shadow2:0 10px 30px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box}
    html,body{min-height:100dvh}
    body{
      margin:0;
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,"Hiragino Kaku Gothic ProN","Noto Sans JP","Yu Gothic",sans-serif;
      color:var(--text);
      background:var(--bg);
      padding:calc(env(safe-area-inset-top) + 14px) 14px calc(env(safe-area-inset-bottom) + 150px);
      overflow-x:hidden;
    }
    body::before{
      content:""; position:fixed; inset:0; pointer-events:none; opacity:.62;
      background:
        radial-gradient(820px 520px at 10% 25%, color-mix(in srgb, var(--accent) 18%, transparent), transparent 62%),
        radial-gradient(760px 520px at 95% 22%, color-mix(in srgb, var(--accent2) 16%, transparent), transparent 62%),
        radial-gradient(820px 520px at 50% 115%, color-mix(in srgb, var(--accent) 12%, transparent), transparent 64%);
    }
    .wrap{max-width:980px;margin:0 auto;position:relative}
    header{
      position:sticky; top:0; z-index:20;
      margin:-6px 0 10px; padding:8px 0 12px;
      background: color-mix(in srgb, var(--bg) 86%, transparent);
      backdrop-filter: blur(12px);
      border-bottom:1px solid color-mix(in srgb, var(--line) 80%, transparent);
    }
    .top{display:flex;align-items:flex-start;justify-content:space-between;gap:12px;padding:0 2px 10px}
    .brand{display:flex;align-items:center;gap:10px}
    .logo{
      width:40px;height:40px;border-radius:14px;display:grid;place-items:center;font-size:18px;
      background: linear-gradient(135deg, color-mix(in srgb, var(--accent) 18%, transparent), color-mix(in srgb, var(--accent2) 14%, transparent));
      border:1px solid color-mix(in srgb, var(--line) 92%, transparent);
      box-shadow:var(--shadow2);
    }
    .title{margin:0;font-size:20px;letter-spacing:.2px;line-height:1.1;font-weight:999}
    .subtitle{margin-top:4px;font-size:12px;color:var(--muted)}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .pill{
      font-size:12px;color:var(--muted);
      padding:8px 12px;border:1px solid color-mix(in srgb, var(--line) 92%, transparent);
      border-radius:999px;background: color-mix(in srgb, var(--panel) 78%, transparent);
      box-shadow:0 8px 18px rgba(60,40,20,.06);
      user-select:none; white-space:nowrap;
    }
    .pillBtn{cursor:pointer}
    .tabs{
      display:flex;gap:10px;overflow-x:auto;-webkit-overflow-scrolling:touch;padding:0 2px 4px;scrollbar-width:none
    }
    .tabs::-webkit-scrollbar{display:none}
    .tab{
      flex:0 0 auto;
      display:flex;align-items:center;gap:8px;
      padding:12px 14px;border-radius:999px;
      border:1px solid color-mix(in srgb, var(--line) 92%, transparent);
      background: color-mix(in srgb, var(--panel) 72%, transparent);
      box-shadow:var(--shadow2);
      cursor:pointer;user-select:none;font-weight:999;font-size:14px;
      transition: transform .08s ease;
    }
    .tab:active{transform:scale(var(--tap))}
    .tab.active{
      background: linear-gradient(90deg, color-mix(in srgb, var(--accent) 24%, transparent), color-mix(in srgb, var(--accent2) 18%, transparent));
      border-color: color-mix(in srgb, var(--accent) 36%, var(--line));
    }
    main{display:grid;gap:14px}
    .card{
      border:1px solid color-mix(in srgb, var(--line) 92%, transparent);
      border-radius:var(--radius);
      background: color-mix(in srgb, var(--panel) 90%, transparent);
      box-shadow:var(--shadow);
      padding:16px; overflow:hidden;
    }
    .card.soft{background: color-mix(in srgb, var(--panel) 78%, transparent); box-shadow:none}
    .cardTitle{margin:0 0 6px;font-size:18px;letter-spacing:.2px;display:flex;gap:8px;align-items:center;font-weight:999}
    .sub{color:var(--muted);font-size:13px;line-height:1.6}
    .tiny{font-size:12px;color:var(--muted)}
    .hr{height:1px;background: color-mix(in srgb, var(--line) 85%, transparent); margin:14px 0}
    .btn{
      border:none;
      background: linear-gradient(90deg, var(--accent), var(--accent2));
      color: color-mix(in srgb, var(--text) 10%, #0d2011);
      font-weight:999;
      padding:12px 14px;border-radius:14px;cursor:pointer;
      box-shadow:0 12px 24px color-mix(in srgb, var(--accent) 18%, transparent);
      transition: transform .08s ease;
    }
    .btn:active{transform:scale(var(--tap))}
    .btn.small{padding:10px 12px;font-size:13px;border-radius:12px}
    .btn.ghost{
      background: color-mix(in srgb, var(--panel) 90%, transparent);
      border:1px solid color-mix(in srgb, var(--line) 92%, transparent);
      box-shadow:none;color:var(--text);font-weight:999;
    }
    .btn.warn{
      background: linear-gradient(90deg, color-mix(in srgb, var(--warn) 92%, #ffd8a8), #ffd8a8);
      color:#2a1a05;
      box-shadow:0 12px 24px color-mix(in srgb, var(--warn) 18%, transparent);
    }
    .btn.danger{
      background: linear-gradient(90deg, var(--danger), #fb7185);
      color:#2a0b0b;
      box-shadow:0 12px 24px color-mix(in srgb, var(--danger) 20%, transparent);
    }
    input,select,textarea{
      width:100%;
      border:1px solid color-mix(in srgb, var(--line) 92%, transparent);
      border-radius:14px;padding:12px 12px;
      background: color-mix(in srgb, var(--panel) 78%, transparent);
      color:var(--text); outline:none; font-size:14px;
    }
    textarea{min-height:92px;resize:vertical}
    label{display:block;margin:12px 0 6px;font-size:12px;color:var(--muted)}
    .split{display:grid;grid-template-columns:1fr;gap:12px}
    @media(min-width:860px){ .split{grid-template-columns:1.2fr .8fr} }

    .plantGrid{display:grid;gap:12px;grid-template-columns:repeat(2,minmax(0,1fr))}
    @media(min-width:860px){ .plantGrid{grid-template-columns:repeat(3,minmax(0,1fr))} }
    .plantCard{
      border:1px solid color-mix(in srgb, var(--line) 92%, transparent);
      border-radius:var(--radius); overflow:hidden;
      background: color-mix(in srgb, var(--panel) 90%, transparent);
      box-shadow:var(--shadow);
      cursor:pointer; transition: transform .08s ease;
    }
    .plantCard:active{transform:scale(var(--tap))}
    .thumb{height:120px;position:relative;
      background: linear-gradient(90deg, color-mix(in srgb, var(--accent) 22%, transparent), color-mix(in srgb, var(--accent2) 18%, transparent));
    }
    .thumb img{width:100%;height:100%;object-fit:cover;display:block}
    .badge{
      position:absolute;left:10px;top:10px;
      font-size:12px;padding:7px 10px;border-radius:999px;
      background: color-mix(in srgb, var(--panel) 92%, transparent);
      border:1px solid color-mix(in srgb, var(--line) 92%, transparent);
      color:var(--muted); font-weight:999; backdrop-filter: blur(8px);
      max-width: calc(100% - 20px);
      overflow:hidden;text-overflow:ellipsis;white-space:nowrap;
    }
    .plantBody{padding:12px}
    .plantName{margin:0;font-size:15px;font-weight:999}
    .plantMeta{margin-top:6px;font-size:12px;color:var(--muted);line-height:1.45}

    .modalBack{
      position:fixed; inset:0; background: rgba(0,0,0,.26);
      display:none; align-items:flex-end; justify-content:center;
      padding:18px; z-index:60;
    }
    .modal{
      width:min(740px,100%);
      border-radius:22px; overflow:hidden;
      background: color-mix(in srgb, var(--panel) 96%, transparent);
      border:1px solid color-mix(in srgb, var(--line) 92%, transparent);
      box-shadow:0 30px 90px rgba(0,0,0,.25);
    }
    .modalHeader{
      display:flex;justify-content:space-between;align-items:center;
      padding:14px 14px;border-bottom:1px solid color-mix(in srgb, var(--line) 92%, transparent);
    }
    .x{
      border:1px solid color-mix(in srgb, var(--line) 92%, transparent);
      background: color-mix(in srgb, var(--panel) 90%, transparent);
      border-radius:12px;padding:8px 10px;cursor:pointer;font-weight:999;color:var(--text);
    }
    .modalBody{padding:14px}
    .modalImg{
      width:100%;height:220px;object-fit:cover;border-radius:18px;
      border:1px solid color-mix(in srgb, var(--line) 92%, transparent);
      background: color-mix(in srgb, var(--panel) 86%, transparent);
    }

    .bottomNav{
      position:fixed; left:14px; right:14px;
      bottom: calc(env(safe-area-inset-bottom) + 18px);
      height:66px; border-radius:20px;
      border:1px solid color-mix(in srgb, var(--line) 92%, transparent);
      background: color-mix(in srgb, var(--panel) 88%, transparent);
      box-shadow:0 18px 40px rgba(0,0,0,.14);
      display:flex; overflow:hidden; z-index:40;
      backdrop-filter: blur(12px);
      transition: transform .22s ease;
    }
    .bottomNav.hide{transform:translateY(120%)}
    .navBtn{
      flex:1; border:none; background:transparent;
      display:flex;flex-direction:column;align-items:center;justify-content:center;gap:6px;
      color:var(--muted); font-weight:999; cursor:pointer;
    }
    .navBtn .ico{font-size:18px;line-height:1}
    .navBtn.active{color:var(--accent)}
    .navMid{
      width:72px;display:flex;align-items:center;justify-content:center;
      border-left:1px solid color-mix(in srgb, var(--line) 75%, transparent);
      border-right:1px solid color-mix(in srgb, var(--line) 75%, transparent);
      background: linear-gradient(180deg, color-mix(in srgb, var(--accent) 10%, transparent), transparent);
    }
    .navMid button{
      width:46px;height:46px;border-radius:16px;border:none;
      background: linear-gradient(90deg, var(--accent), var(--accent2));
      color:#0d2011;font-weight:999;cursor:pointer;font-size:20px;
      box-shadow:0 14px 26px color-mix(in srgb, var(--accent) 22%, transparent);
      transition: transform .08s ease;
    }
    .navMid button:active{transform:scale(var(--tap))}
    .chipRow{display:flex;gap:8px;flex-wrap:wrap}
    .chip{
      font-size:12px;padding:7px 10px;border-radius:999px;
      border:1px solid color-mix(in srgb, var(--line) 92%, transparent);
      background: color-mix(in srgb, var(--panel2) 90%, transparent);
      color:var(--text); user-select:none;
    }
    .chip.ok{border-color: color-mix(in srgb, var(--ok) 35%, var(--line))}
    .chip.warn{border-color: color-mix(in srgb, var(--warn) 35%, var(--line))}
    .chip.bad{border-color: color-mix(in srgb, var(--danger) 35%, var(--line))}
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="top">
        <div class="brand">
          <div class="logo">ğŸƒ</div>
          <div>
            <h1 class="title">PlantLog</h1>
            <div class="subtitle">å†™çœŸãƒ»ã‚¿ã‚¹ã‚¯ãƒ»è¨ºæ–­ãƒ­ã‚°ï¼ˆç«¯æœ«å†…ä¿å­˜ï¼‰</div>
          </div>
        </div>
        <div class="row" style="justify-content:flex-end">
          <div class="pill" id="statusPill">ä¿å­˜: ç«¯æœ«ã®ä¸­</div>
          <div class="pill pillBtn" id="themeBtn">ğŸŒ™ ãƒ€ãƒ¼ã‚¯</div>
        </div>
      </div>

      <div class="tabs" id="tabs">
        <div class="tab active" data-tab="home">ğŸ  ãƒ›ãƒ¼ãƒ </div>
        <div class="tab" data-tab="plants">ğŸŒ¿ æ¤ç‰©</div>
        <div class="tab" data-tab="add">â• è¿½åŠ </div>
        <div class="tab" data-tab="diag">ğŸ©º è¨ºæ–­</div>
        <div class="tab" data-tab="backup">ğŸ’¾ ä¿å­˜</div>
      </div>
    </header>

    <main>
      <!-- HOME -->
      <section class="card" id="view-home">
        <h2 class="cardTitle">ğŸ  ãƒ›ãƒ¼ãƒ </h2>
        <div class="sub">æœŸé™ãŒè¿‘ã„ã‚¿ã‚¹ã‚¯ã ã‘è¡¨ç¤ºã€‚å®Œäº†ã§æ¬¡ã®æœŸé™ã«æ›´æ–°ã€‚</div>

        <div class="hr"></div>

        <div class="row">
          <button class="btn" id="homeAddBtn">ğŸ“· è¿½åŠ ï¼ˆå†™çœŸï¼‰</button>
          <button class="btn ghost" id="homePresetBtn">âœ¨ æ—¢å®šã‹ã‚‰è¿½åŠ </button>
          <button class="btn ghost" id="homePlantsBtn">ğŸŒ¿ ä¸€è¦§ã¸</button>
        </div>

        <div class="hr"></div>

        <div class="row" style="justify-content:space-between">
          <div class="sub">ç™»éŒ²æ•°</div>
          <div class="pill"><b id="countPill">0</b> ä»¶</div>
        </div>

        <div class="hr"></div>

        <div class="row" style="justify-content:space-between;align-items:flex-end">
          <div>
            <div style="font-weight:999">ã‚¿ã‚¹ã‚¯ï¼ˆæœŸé™ãŒè¿‘ã„ã‚‚ã®ï¼‰</div>
            <div class="sub" style="margin-top:4px">æœŸé™ã®è¡¨ç¤ºç¯„å›²ã‚’å¤‰ãˆã‚‰ã‚Œã‚‹ã€‚</div>
          </div>
          <div class="row" style="gap:6px">
            <span class="tiny">æœŸé™</span>
            <input id="daysWindow" type="number" min="0" value="3" style="width:78px;text-align:center;font-weight:999" />
            <span class="tiny">æ—¥ä»¥å†…</span>
          </div>
        </div>

        <div id="taskList" style="display:grid;gap:10px;margin-top:12px"></div>
        <div class="sub" id="taskEmpty" style="display:none;margin-top:10px">ä»Šæ—¥ã‚„ã‚‹ã“ã¨ï¼šãªã—</div>

        <div class="hr"></div>

        <div class="row" style="justify-content:space-between;align-items:flex-end">
          <div>
            <div style="font-weight:999">è¨ºæ–­ãƒ­ã‚°ï¼ˆæœ€è¿‘ï¼‰</div>
            <div class="sub" style="margin-top:4px">å†™çœŸã¤ããƒ­ã‚°ãŒæ®‹ã‚‹ï¼ˆè»½é‡ä¿å­˜ï¼‰ã€‚</div>
          </div>
          <button class="btn small ghost" id="homeGoDiag">ğŸ©º è¨ºæ–­ã¸</button>
        </div>

        <div id="homeDiagList" style="display:grid;gap:10px;margin-top:12px"></div>
        <div class="sub" id="homeDiagEmpty" style="display:none;margin-top:10px">è¨ºæ–­ãƒ­ã‚°ï¼šãªã—</div>

        <div class="hr"></div>
        <div class="tiny">â€»ã‚¯ãƒ©ã‚¦ãƒ‰é€ä¿¡ãªã—ï¼ˆlocalStorageä¿å­˜ï¼‰</div>
      </section>

      <!-- PLANTS -->
      <section class="card" id="view-plants" style="display:none">
        <div class="row" style="justify-content:space-between;align-items:flex-end">
          <div>
            <h2 class="cardTitle">ğŸŒ¿ æ¤ç‰©</h2>
            <div class="sub">å†™çœŸã‚«ãƒ¼ãƒ‰ã€‚ã‚¿ãƒƒãƒ—ã§è©³ç´°ï¼†å®Œäº†ã€‚</div>
          </div>
          <div class="row">
            <button class="btn small" id="plantsAddBtn">â• è¿½åŠ </button>
            <button class="btn small ghost" id="plantsPresetBtn">âœ¨ æ—¢å®š</button>
          </div>
        </div>

        <div class="hr"></div>

        <div class="plantGrid" id="plantGrid"></div>
        <div class="sub" id="plantEmpty" style="display:none;margin-top:10px">ã¾ã æ¤ç‰©ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</div>
      </section>

      <!-- ADD -->
      <section class="card" id="view-add" style="display:none">
        <h2 class="cardTitle">â• æ¤ç‰©ã‚’è¿½åŠ </h2>
        <div class="sub">å†™çœŸï¼‹åå‰ï¼‹å“ç¨®ï¼‹å‘¨æœŸã€‚è¨ºæ–­ã¨ã‚¿ã‚¹ã‚¯ã«ç¹‹ãŒã‚‹ã€‚</div>

        <div class="hr"></div>

        <div class="split">
          <div class="card soft">
            <label>å†™çœŸï¼ˆã‚«ãƒ¡ãƒ©/ã‚¢ãƒ«ãƒãƒ ï¼‰</label>
            <input id="photoInput" type="file" accept="image/*" capture="environment" />
            <img id="photoPreview" class="modalImg" style="display:none;margin-top:10px" />
            <div class="tiny" style="margin-top:8px">â€»å†™çœŸã¯ç«¯æœ«å†…ä¿å­˜ï¼ˆè»½é‡åŒ–ã—ã¦ä¿å­˜ï¼‰</div>

            <label style="margin-top:12px">åå‰ï¼ˆè¡¨ç¤ºåï¼‰</label>
            <input id="nameInput" placeholder="ä¾‹ï¼šãƒ¢ãƒ³ã‚¹ãƒ†ãƒ©" />

            <label>æ¤ç‰©ã®å“ç¨®ï¼ˆä»»æ„ï¼‰</label>
            <input id="speciesInput" placeholder="ä¾‹ï¼šMonstera deliciosa / æ–‘å…¥ã‚Š" />

            <label>ç½®ãå ´æ‰€ï¼ˆä»»æ„ï¼‰</label>
            <input id="locInput" placeholder="ä¾‹ï¼šãƒªãƒ“ãƒ³ã‚°çª“éš› / æ¸©å®¤" />

            <div class="row" style="margin-top:10px">
              <div style="flex:1">
                <label>æ°´ã‚„ã‚Šå‘¨æœŸï¼ˆæ—¥ï¼‰</label>
                <input id="waterEvery" type="number" min="0" value="7" />
              </div>
              <div style="flex:1">
                <label>è‚¥æ–™å‘¨æœŸï¼ˆæ—¥ï¼‰</label>
                <input id="fertEvery" type="number" min="0" value="30" />
              </div>
              <div style="flex:1">
                <label>å‰ªå®šå‘¨æœŸï¼ˆæ—¥ï¼‰</label>
                <input id="pruneEvery" type="number" min="0" value="90" />
              </div>
            </div>

            <label>ãƒ¡ãƒ¢ï¼ˆä»»æ„ï¼‰</label>
            <textarea id="memoInput" placeholder="ä¾‹ï¼šå†¬ã¯æ§ãˆã‚ã€‚è‘‰æ°´ã¯é€±2ã€‚"></textarea>

            <div class="row" style="margin-top:12px">
              <button class="btn" id="savePlant">âœ… è¿½åŠ ã™ã‚‹</button>
              <button class="btn ghost" id="resetAdd">ãƒªã‚»ãƒƒãƒˆ</button>
            </div>
          </div>

          <div class="card soft">
            <h3 style="margin:0 0 10px">âœ¨ æ—¢å®šãƒ†ãƒ³ãƒ—ãƒ¬ã‹ã‚‰è¿½åŠ </h3>
            <div class="sub">ã‚ˆãã‚ã‚‹è¦³è‘‰æ¤ç‰©60ç¨®ã€‚å‘¨æœŸã¨å“ç¨®ã®ãŸãŸãå°ã«ãªã‚‹ã€‚</div>
            <div class="hr"></div>
            <label>ãƒ†ãƒ³ãƒ—ãƒ¬ã‚’é¸ã¶</label>
            <select id="presetSelect"></select>

            <div class="row" style="margin-top:10px">
              <button class="btn ghost" id="presetFillBtn">â¬‡ï¸ å…¥åŠ›ã«åæ˜ </button>
              <button class="btn warn" id="presetQuickAddBtn">âš¡ ã™ãè¿½åŠ ï¼ˆå†™çœŸãªã—ï¼‰</button>
            </div>

            <div class="hr"></div>
            <div class="tiny">ã‚³ãƒ„ï¼šãƒ†ãƒ³ãƒ—ãƒ¬â†’å†™çœŸæ’®å½±â†’ä¿å­˜ ãŒæœ€é€Ÿã€‚</div>
            <div class="chipRow" style="margin-top:10px">
              <span class="chip">ğŸ“· å†™çœŸã¯åœ§ç¸®ä¿å­˜</span>
              <span class="chip">ğŸ“† ã‚¿ã‚¹ã‚¯è‡ªå‹•</span>
              <span class="chip">ğŸ©º è¨ºæ–­ãƒ­ã‚°</span>
            </div>
          </div>
        </div>
      </section>

      <!-- DIAG -->
      <section class="card" id="view-diag" style="display:none">
        <h2 class="cardTitle">ğŸ©º ç—…æ°—ãƒã‚§ãƒƒã‚¯</h2>
        <div class="sub">å†™çœŸï¼‹ç—‡çŠ¶è³ªå•ã§ã€ŒåŸå› å€™è£œTOP3ã€ã¨ã€Œå¯¾å‡¦ã€ã‚’å‡ºã™ï¼ˆãƒ«ãƒ¼ãƒ«å¼â†’å¾Œã§AIå¯ï¼‰ã€‚</div>

        <div class="hr"></div>

        <div class="split">
          <div class="card soft">
            <label>å†™çœŸï¼ˆä»»æ„ï¼‰</label>
            <input id="diagPhotoInput" type="file" accept="image/*" capture="environment" />
            <img id="diagPreview" class="modalImg" style="display:none;margin-top:10px" />

            <label style="margin-top:12px">ã“ã®è¨ºæ–­ã‚’ä¿å­˜ã™ã‚‹æ¤ç‰©ï¼ˆä»»æ„ï¼‰</label>
            <select id="diagPlantSelect"></select>

            <label style="margin-top:12px">ç—‡çŠ¶ï¼ˆå½“ã¦ã¯ã¾ã‚‹ã‚‚ã®ï¼‰</label>
            <div class="row">
              <label style="flex:1"><input type="checkbox" class="sym" value="yellow"> è‘‰ãŒé»„ã°ã‚€</label>
              <label style="flex:1"><input type="checkbox" class="sym" value="spots"> æ–‘ç‚¹/ã‚·ãƒŸ</label>
              <label style="flex:1"><input type="checkbox" class="sym" value="wilting"> ã—ãŠã‚Œã‚‹</label>
            </div>
            <div class="row">
              <label style="flex:1"><input type="checkbox" class="sym" value="bugs"> è™«/ãƒ™ã‚¿ã¤ã</label>
              <label style="flex:1"><input type="checkbox" class="sym" value="mold"> ã‚«ãƒ“/ç™½ã„ç²‰</label>
              <label style="flex:1"><input type="checkbox" class="sym" value="brown"> èŒ¶è‰²ãæ¯ã‚Œã‚‹</label>
            </div>

            <label style="margin-top:12px">çŠ¶æ³</label>
            <div class="row">
              <div style="flex:1">
                <label style="margin-top:0">ç›´è¿‘ã§æ°´ã‚„ã‚Šå¤šã‚ï¼Ÿ</label>
                <select id="ctxWater">
                  <option value="unknown">ã‚ã‹ã‚‰ãªã„</option>
                  <option value="more">å¤šã‚</option>
                  <option value="less">å°‘ãªã‚</option>
                </select>
              </div>
              <div style="flex:1">
                <label style="margin-top:0">æ—¥å½“ãŸã‚Š</label>
                <select id="ctxLight">
                  <option value="unknown">ã‚ã‹ã‚‰ãªã„</option>
                  <option value="strong">å¼·ã„</option>
                  <option value="weak">å¼±ã„</option>
                </select>
              </div>
              <div style="flex:1">
                <label style="margin-top:0">é¢¨é€šã—</label>
                <select id="ctxAir">
                  <option value="unknown">ã‚ã‹ã‚‰ãªã„</option>
                  <option value="good">è‰¯ã„</option>
                  <option value="bad">æ‚ªã„</option>
                </select>
              </div>
            </div>

            <label>ãƒ¡ãƒ¢</label>
            <textarea id="diagMemo" placeholder="ä¾‹ï¼šæœ€è¿‘å¯’ã„ï¼åœŸãŒä¹¾ã‹ãªã„ï¼é‰¢ãŒé‡ã„ãªã©"></textarea>

            <div class="row" style="margin-top:12px">
              <button class="btn" id="runDiag">ğŸ©º åˆ¤å®šã™ã‚‹</button>
              <button class="btn ghost" id="resetDiag">ãƒªã‚»ãƒƒãƒˆ</button>
            </div>
          </div>

          <div class="card soft">
            <h3 style="margin:0 0 8px">çµæœ</h3>
            <div class="sub">åˆ¤å®šâ†’ãƒ­ã‚°ä¿å­˜â†’ãƒ›ãƒ¼ãƒ ã«è¡¨ç¤ºã€‚å†™çœŸã‚‚åœ§ç¸®ã§ä¿å­˜ã€‚</div>
            <div class="hr"></div>
            <div id="diagResult" class="sub">ã¾ã åˆ¤å®šã—ã¦ãªã„ã€‚</div>

            <div class="hr"></div>
            <div class="row" style="justify-content:space-between;align-items:flex-end">
              <div>
                <div style="font-weight:999">è¨ºæ–­ãƒ­ã‚°</div>
                <div class="tiny">æœ€æ–°ã‹ã‚‰è¡¨ç¤ºï¼ˆã‚¿ãƒƒãƒ—ã§è©³ç´°ï¼‰</div>
              </div>
              <button class="btn small ghost" id="clearDiagLogs">ğŸ§¹ ãƒ­ã‚°å‰Šé™¤</button>
            </div>
            <div id="diagLogList" style="display:grid;gap:10px;margin-top:12px"></div>
            <div class="sub" id="diagLogEmpty" style="display:none;margin-top:10px">ãƒ­ã‚°ï¼šãªã—</div>
          </div>
        </div>
      </section>

      <!-- BACKUP -->
      <section class="card" id="view-backup" style="display:none">
        <h2 class="cardTitle">ğŸ’¾ å¼•ã£è¶Šã—ãƒ»ä¿å­˜</h2>
        <div class="sub">ã‚¹ãƒãƒ›å¤‰æ›´ã‚„ä¸‡ãŒä¸€ã«å‚™ãˆã¦ã€ä¿å­˜ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œã‚Œã‚‹ã€‚</div>

        <div class="hr"></div>

        <div class="card soft">
          <h3 style="margin:0 0 6px">â‘  ä¿å­˜ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œã‚‹</h3>
          <div class="sub">iCloud/ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜ã—ã¦ãŠã‘ã°å®‰å¿ƒã€‚</div>
          <div class="row" style="margin-top:10px">
            <button class="btn" id="exportBtn">â¬‡ï¸ ä¿å­˜ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œã‚‹</button>
            <button class="btn ghost" id="exportIcsBtn">ğŸ“† ã‚¿ã‚¹ã‚¯é€šçŸ¥(ics)</button>
          </div>
          <div class="tiny" style="margin-top:8px">icsã¯0å††ã§é€šçŸ¥ã«è¿‘ã„é‹ç”¨ãŒã§ãã‚‹ã€‚</div>
        </div>

        <div class="hr"></div>

        <div class="card soft">
          <h3 style="margin:0 0 6px">â‘¡ ä¿å­˜ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰æˆ»ã™ï¼ˆå¾©å…ƒï¼‰</h3>
          <div class="sub">ä¿å­˜ã—ã¦ãŠã„ãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸ã‚“ã§æˆ»ã™ã€‚</div>
          <input id="importInput" type="file" accept="application/json" style="margin-top:10px" />
          <div class="row" style="margin-top:10px">
            <button class="btn" id="importBtn">â¬†ï¸ æˆ»ã™ï¼ˆå¾©å…ƒï¼‰</button>
          </div>
        </div>

        <div class="hr"></div>

        <div class="card soft">
          <h3 style="margin:0 0 6px">â‘¢ å…¨éƒ¨æ¶ˆã™ï¼ˆæœ€çµ‚æ‰‹æ®µï¼‰</h3>
          <div class="sub">æˆ»ã›ãªã„ã€‚å…ˆã«â‘ æ¨å¥¨ã€‚</div>
          <div class="row" style="margin-top:10px">
            <button class="btn danger" id="wipeBtn">ğŸ§¨ å…¨ãƒ‡ãƒ¼ã‚¿ã‚’æ¶ˆã™</button>
          </div>
        </div>

        <div class="hr"></div>
        <div class="tiny">ä¿å­˜å ´æ‰€ï¼šã“ã®ç«¯æœ«ã®ä¸­ï¼ˆlocalStorageï¼‰</div>
      </section>
    </main>
  </div>

  <!-- Modal -->
  <div class="modalBack" id="modalBack">
    <div class="modal">
      <div class="modalHeader">
        <strong id="modalTitle">è©³ç´°</strong>
        <button class="x" id="closeModal">é–‰ã˜ã‚‹</button>
      </div>
      <div class="modalBody" id="modalBody"></div>
    </div>
  </div>

  <!-- Bottom nav -->
  <nav class="bottomNav" aria-label="Bottom Navigation">
    <button class="navBtn active" data-tab="home"><div class="ico">ğŸ </div><div style="font-size:11px">ãƒ›ãƒ¼ãƒ </div></button>
    <button class="navBtn" data-tab="plants"><div class="ico">ğŸŒ¿</div><div style="font-size:11px">æ¤ç‰©</div></button>
    <div class="navMid"><button type="button" id="nav-add">ï¼‹</button></div>
    <button class="navBtn" data-tab="diag"><div class="ico">ğŸ©º</div><div style="font-size:11px">è¨ºæ–­</div></button>
    <button class="navBtn" data-tab="backup"><div class="ico">ğŸ’¾</div><div style="font-size:11px">ä¿å­˜</div></button>
  </nav>

  <script>
    // ===== ãƒ‡ãƒãƒƒã‚°ï¼šã‚¨ãƒ©ãƒ¼ã‚’ç”»é¢ã«å‡ºã™ï¼ˆiPhoneã§ã‚‚åˆ†ã‹ã‚‹ï¼‰ =====
(function(){
  const show = (msg) => {
    const pill = document.getElementById("statusPill");
    if (pill) pill.textContent = "ã‚¨ãƒ©ãƒ¼: " + msg;
    alert("ã‚¨ãƒ©ãƒ¼: " + msg); // ä¸€æ—¦ã¯å¼·åˆ¶è¡¨ç¤ºï¼ˆåŸå› ãŒåˆ†ã‹ã‚Œã°æ¶ˆã—ã¦OKï¼‰
  };

  window.addEventListener("error", (e) => show(e.message || "unknown error"));
  window.addEventListener("unhandledrejection", (e) => show(e?.reason?.message || String(e.reason || "unknown rejection")));

  // å¿…é ˆé–¢æ•°ãŒç„¡ã„ã¨å…¨éƒ¨æ­¢ã¾ã‚‹ã®ã§å…ˆã«ãƒã‚§ãƒƒã‚¯
  window.addEventListener("DOMContentLoaded", () => {
    const mustFns = ["showTab","hideNav","saveState","renderPlants","renderHome","compressImageFile","fileToDataUrl","escapeHtml","nowISO","newId"];
    const missingFns = mustFns.filter(n => typeof window[n] !== "function");
    if (missingFns.length) show("é–¢æ•°ãŒç„¡ã„: " + missingFns.join(", "));
  });
})();
/* ===== PlantLog v1 (PART 1/3) =====/
/* ===== PlantLog v1 (PART 2/3) ===== */
const $ = (id)=>document.getElementById(id);
const views = ["home","plants","add","diag","backup"];
const LS_KEY = "plantlog_full_v1";
const THEME_KEY = "plantlog_theme_full_v1";

function nowISO(){ return new Date().toISOString(); }
function escapeHtml(s=""){
  return String(s).replace(/[&<>"']/g, m => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
  }[m]));
}
function newId(prefix="p"){
  return prefix + "_" + Math.random().toString(36).slice(2,10) + "_" + Date.now().toString(36);
}
function toDateOnly(d){ const x=new Date(d); x.setHours(0,0,0,0); return x; }
function addDays(date, days){ const d=new Date(date); d.setDate(d.getDate()+days); return d; }
function fmtMD(d){ const x=new Date(d); return `${x.getMonth()+1}/${x.getDate()}`; }
function fmtHM(d){ const x=new Date(d); return `${String(x.getHours()).padStart(2,"0")}:${String(x.getMinutes()).padStart(2,"0")}`; }

/* ===== ç”»åƒåœ§ç¸®ï¼ˆè»½é‡ä¿å­˜ï¼‰ ===== */
function fileToDataUrl(file){
  return new Promise((resolve,reject)=>{
    const r=new FileReader();
    r.onload=()=>resolve(r.result);
    r.onerror=reject;
    r.readAsDataURL(file);
  });
}
async function compressImageFile(file, maxW=900, quality=0.82){
  const dataUrl = await fileToDataUrl(file);
  const img = new Image();
  await new Promise((res,rej)=>{ img.onload=res; img.onerror=rej; img.src=dataUrl; });
  const w = img.naturalWidth || img.width;
  const h = img.naturalHeight || img.height;
  const scale = Math.min(1, maxW / w);
  const nw = Math.max(1, Math.round(w * scale));
  const nh = Math.max(1, Math.round(h * scale));
  const canvas = document.createElement("canvas");
  canvas.width = nw; canvas.height = nh;
  const ctx = canvas.getContext("2d");
  ctx.drawImage(img,0,0,nw,nh);
  return canvas.toDataURL("image/jpeg", quality);
}

/* ===== ä¿å­˜ ===== */
function loadState(){
  const raw = localStorage.getItem(LS_KEY);
  if(!raw) return { plants:[], diagLogs:[] };
  try{
    const st = JSON.parse(raw);
    return {
      plants: Array.isArray(st.plants)? st.plants:[],
      diagLogs: Array.isArray(st.diagLogs)? st.diagLogs:[]
    };
  }catch{
    return { plants:[], diagLogs:[] };
  }
}
function saveState(){
  localStorage.setItem(LS_KEY, JSON.stringify(state));
  $("statusPill").textContent="ä¿å­˜: ç«¯æœ«ã®ä¸­ âœ“";
  setTimeout(()=> $("statusPill").textContent="ä¿å­˜: ç«¯æœ«ã®ä¸­", 800);
}
let state = loadState();

/* ===== ãƒ†ãƒ¼ãƒ ===== */
function applyTheme(t){
  document.documentElement.setAttribute("data-theme", t==="dark"?"dark":"beige");
  localStorage.setItem(THEME_KEY, t);
  $("themeBtn").textContent = (t==="dark")?"â˜€ï¸ ãƒ™ãƒ¼ã‚¸ãƒ¥":"ğŸŒ™ ãƒ€ãƒ¼ã‚¯";
  const meta = document.querySelector('meta[name="theme-color"]');
  if(meta) meta.setAttribute("content", (t==="dark")?"#070b10":"#f4efe6");
}
applyTheme(localStorage.getItem(THEME_KEY)||"beige");
$("themeBtn").addEventListener("click",()=>{
  const cur = localStorage.getItem(THEME_KEY)||"beige";
  applyTheme(cur==="dark"?"beige":"dark");
});

/* ===== ç”»é¢åˆ‡æ›¿ ===== */
function showTab(tab){
  views.forEach(v=>{
    const el = $("view-"+v);
    if(el) el.style.display = (v===tab)?"":"none";
  });
  document.querySelectorAll(".tab").forEach(el=>{
    el.classList.toggle("active", el.dataset.tab===tab);
  });
  document.querySelectorAll(".navBtn").forEach(el=>{
    el.classList.toggle("active", el.dataset.tab===tab);
  });
  if(tab==="plants") renderPlants();
  if(tab==="home") renderHome();
  if(tab==="diag") renderDiagLogs();
}
$("tabs").addEventListener("click",(e)=>{
  const t = e.target.closest(".tab");
  if(!t) return;
  showTab(t.dataset.tab);
});
document.querySelectorAll(".navBtn").forEach(btn=>{
  btn.addEventListener("click",()=>showTab(btn.dataset.tab));
});

/* ===== ä¸‹ãƒŠãƒ“è‡ªå‹•éš ã— ===== */
let lastY = window.scrollY;
const nav = document.querySelector(".bottomNav");
window.addEventListener("scroll",()=>{
  const y=window.scrollY;
  const down=y>lastY;
  if(down && y>24) nav.classList.add("hide");
  else nav.classList.remove("hide");
  lastY=y;
},{passive:true});
function hideNav(ms=1100){
  nav.classList.add("hide");
  setTimeout(()=>nav.classList.remove("hide"),ms);
}

/* ===== 60ç¨®ãƒ†ãƒ³ãƒ—ãƒ¬ ===== */
const PRESETS = [
["ãƒ¢ãƒ³ã‚¹ãƒ†ãƒ©","Monstera deliciosa",7,30,90],
["ã‚³ãƒ«ã‚¸ãƒªãƒ","Cordyline",7,30,90],
["ãƒãƒˆã‚¹","Epipremnum aureum",7,30,60],
["ã‚µãƒ³ã‚¹ãƒ™ãƒªã‚¢","Dracaena trifasciata",14,45,120],
["ãƒ‘ã‚­ãƒ©","Pachira aquatica",7,30,90],
["ãƒ•ã‚£ã‚«ã‚¹ãƒ»ã‚¦ãƒ³ãƒ™ãƒ©ãƒ¼ã‚¿","Ficus umbellata",7,30,90],
["ãƒ•ã‚£ã‚«ã‚¹ãƒ»ãƒ™ãƒ³ã‚¬ãƒ¬ãƒ³ã‚·ã‚¹","Ficus benghalensis",7,30,90],
["ãƒ•ã‚£ãƒ­ãƒ‡ãƒ³ãƒ‰ãƒ­ãƒ³","Philodendron",7,30,90],
["ã‚¬ã‚¸ãƒ¥ãƒãƒ«","Ficus microcarpa",7,30,90],
["ã‚¢ãƒ³ã‚¹ãƒªã‚¦ãƒ ","Anthurium",7,30,60],
["ã‚¹ãƒˆãƒ¬ãƒªãƒã‚¢","Strelitzia",7,30,90],
["ãƒ‰ãƒ©ã‚»ãƒŠ","Dracaena",10,30,120],
["ã‚¢ãƒ­ã‚«ã‚·ã‚¢","Alocasia",7,30,60],
["ã‚«ãƒ©ãƒ†ã‚¢","Calathea",7,30,60],
["ã‚ªãƒªãƒ¼ãƒ–","Olea europaea",10,45,120],
["ãƒ­ãƒ¼ã‚ºãƒãƒªãƒ¼","Rosmarinus",7,45,120],
["ãƒ©ãƒ™ãƒ³ãƒ€ãƒ¼","Lavandula",7,45,120],
["ãƒã‚¸ãƒ«","Ocimum basilicum",3,21,30],
["ãƒŸãƒ³ãƒˆ","Mentha",3,21,30],
["ã‚¢ã‚¤ãƒ“ãƒ¼","Hedera",7,30,90],
["ã‚·ãƒ€","Fern",7,30,90],
["ã‚¯ãƒ¯ã‚ºã‚¤ãƒ¢","Alocasia odora",7,30,90],
["ã‚·ãƒ³ã‚´ãƒ‹ã‚¦ãƒ ","Syngonium",7,30,60],
["ã‚¢ã‚°ãƒ©ã‚ªãƒãƒ","Aglaonema",7,30,90],
["ãƒ›ãƒ¤","Hoya",10,30,90],
["ã‚«ãƒãƒƒã‚¯","Schefflera",7,30,90],
["ãƒ¦ãƒƒã‚«","Yucca",14,45,120],
["ãƒ‡ã‚£ãƒ•ã‚§ãƒ³ãƒã‚­ã‚¢","Dieffenbachia",7,30,60],
["ã‚¨ãƒãƒ¼ãƒ•ãƒ¬ãƒƒã‚·ãƒ¥","Albizia julibrissin",7,30,90],
["ãƒˆãƒƒã‚¯ãƒªãƒ©ãƒ³","Beaucarnea",14,45,120],
["ãƒ™ã‚´ãƒ‹ã‚¢","Begonia",7,30,60],
["ã‚»ãƒ­ãƒ¼ãƒ ","Philodendron selloum",7,30,90],
["ã‚¢ãƒ­ã‚¨","Aloe",14,45,120],
["ã‚¨ã‚±ãƒ™ãƒªã‚¢","Echeveria",14,45,120],
["ãƒã‚ªãƒ«ãƒã‚¢","Haworthia",14,45,120],
["ã‚«ãƒ©ãƒ³ã‚³ã‚¨","Kalanchoe",10,30,60],
["ã‚¯ãƒƒã‚«ãƒãƒ©","Philodendron xanadu",7,30,90],
["ãƒ¢ãƒ³ã‚¹ãƒ†ãƒ©ãƒ»ã‚¢ãƒ€ãƒ³ã‚½ãƒ‹ãƒ¼","Monstera adansonii",7,30,90],
["ã‚°ã‚ºãƒãƒ‹ã‚¢","Guzmania",7,30,60],
["ã‚¨ã‚¢ãƒ—ãƒ©ãƒ³ãƒ„","Tillandsia",5,30,90],
["ãƒ–ãƒ¼ã‚²ãƒ³ãƒ“ãƒªã‚¢","Bougainvillea",7,45,120],
["ã‚·ãƒãƒˆãƒãƒªã‚³","Fraxinus griffithii",7,30,120],
["ãƒ¬ãƒ¢ãƒ³","Citrus limon",7,45,120],
["ã‚¢ãƒœã‚«ãƒ‰","Persea americana",7,45,120],
["ã‚µãƒœãƒ†ãƒ³","Cactus",14,45,180],
["æŸ±ã‚µãƒœãƒ†ãƒ³","Cereus",14,45,180],
["ã‚´ãƒ ã®æœ¨","Ficus elastica",7,30,90],
["ãƒ™ãƒ³ã‚¸ãƒ£ãƒŸãƒ³","Ficus benjamina",7,30,90],
["ãƒ‘ãƒ³ãƒ€ã‚¬ã‚¸ãƒ¥ãƒãƒ«","Ficus microcarpa panda",7,30,90],
["ãƒšãƒšãƒ­ãƒŸã‚¢","Peperomia",7,30,90],
["ã‚¹ãƒ‘ãƒ†ã‚£ãƒ•ã‚£ãƒ©ãƒ ","Spathiphyllum",7,30,60],
["ãƒªãƒ—ã‚µãƒªã‚¹","Rhipsalis",7,30,90],
["ãƒãƒ•ãƒ­ãƒ¬ãƒ”ã‚¹","Nephrolepis",7,30,60],
["ã‚¢ãƒ¬ã‚«ãƒ¤ã‚·","Dypsis lutescens",7,30,90],
["ãƒãƒ£ãƒ¡ãƒ‰ãƒ¬ã‚¢","Chamaedorea",7,30,90],
["ãƒ†ãƒ¼ãƒ–ãƒ«ãƒ¤ã‚·","Chamaedorea elegans",7,30,90],
["ãƒãƒªã‚·ãƒ£ã‚¹","Polyscias",7,30,90],
["ã‚¯ãƒ«ã‚·ã‚¢","Clusia",7,30,90],
["ã‚»ãƒ€ãƒ ","Sedum",10,30,120]
];

function initPresets(){
  const sel = $("presetSelect");
  sel.innerHTML="";
  PRESETS.forEach((p,i)=>{
    const opt=document.createElement("option");
    opt.value=i;
    opt.textContent=p[0];
    sel.appendChild(opt);
  });
}
initPresets();
    /* ===== UIï¼šãƒ¢ãƒ¼ãƒ€ãƒ« ===== */
function openModal(title, html){
  $("modalTitle").textContent = title;
  $("modalBody").innerHTML = html;
  $("modalBack").style.display = "flex";
}
function closeModal(){ $("modalBack").style.display="none"; }
$("closeModal").addEventListener("click", closeModal);
$("modalBack").addEventListener("click",(e)=>{ if(e.target.id==="modalBack") closeModal(); });

/* ===== ä¸‹ãƒŠãƒ“ï¼šä¸­å¤®ï¼‹ã§ã‚«ãƒ¡ãƒ©èµ·å‹• ===== */
$("nav-add").addEventListener("click", ()=>{
  showTab("add");
  openAddCamera();
});
function openAddCamera(){
  hideNav(1300);
  setTimeout(()=> $("photoInput").click(), 60);
}

/* ===== Homeãƒœã‚¿ãƒ³ ===== */
$("homeAddBtn").addEventListener("click", ()=>{
  showTab("add"); openAddCamera();
});
$("homePresetBtn").addEventListener("click", ()=>{ showTab("add"); $("presetSelect").focus(); });
$("homePlantsBtn").addEventListener("click", ()=> showTab("plants"));
$("homeGoDiag").addEventListener("click", ()=> showTab("diag"));

/* ===== Plantsãƒœã‚¿ãƒ³ ===== */
$("plantsAddBtn").addEventListener("click", ()=>{ showTab("add"); openAddCamera(); });
$("plantsPresetBtn").addEventListener("click", ()=>{ showTab("add"); $("presetSelect").focus(); });

/* ===== æ—¢å®š â†’ å…¥åŠ›ã«åæ˜  ===== */
function presetToForm(idx){
  const p = PRESETS[idx];
  if(!p) return;
  $("nameInput").value = p[0];
  $("speciesInput").value = p[1];
  $("waterEvery").value = String(p[2]);
  $("fertEvery").value  = String(p[3]);
  $("pruneEvery").value = String(p[4]);
}
$("presetFillBtn").addEventListener("click", ()=>{
  presetToForm(parseInt($("presetSelect").value,10)||0);
  alert("å…¥åŠ›æ¬„ã«åæ˜ ã—ãŸã‚ˆã€‚å†™çœŸã‚’æ’®ã£ã¦ã€è¿½åŠ ã™ã‚‹ã€ãŒæœ€é€Ÿã€‚");
});
$("presetQuickAddBtn").addEventListener("click", ()=>{
  const idx = parseInt($("presetSelect").value,10)||0;
  const p = PRESETS[idx];
  if(!p) return;
  const plant = makePlant({
    name:p[0], species:p[1], location:"", memo:"",
    waterEvery:p[2], fertEvery:p[3], pruneEvery:p[4],
    photoDataUrl:""
  });
  state.plants.unshift(plant);
  saveState();
  renderPlants(); renderHome(); refreshDiagPlantSelect();
  alert("è¿½åŠ ã—ãŸã‚ˆï¼ˆå†™çœŸãªã—ï¼‰ã€‚ã‚ã¨ã§å†™çœŸã‚’æ’®ã£ã¦æ›´æ–°ã‚‚ã§ãã‚‹ã€‚");
  showTab("plants");
});

/* ===== è¿½åŠ ãƒ•ã‚©ãƒ¼ãƒ  ===== */
$("photoInput").addEventListener("change", async ()=>{
  const f = $("photoInput").files?.[0];
  if(!f) return;
  try{
    const dataUrl = await compressImageFile(f, 980, 0.82);
    $("photoPreview").src = dataUrl;
    $("photoPreview").style.display = "";
    $("photoPreview").dataset.dataurl = dataUrl;
  }catch{
    const raw = await fileToDataUrl(f);
    $("photoPreview").src = raw;
    $("photoPreview").style.display = "";
    $("photoPreview").dataset.dataurl = raw;
  }
});
$("resetAdd").addEventListener("click", ()=>{
  $("photoInput").value="";
  $("photoPreview").style.display="none";
  $("photoPreview").src="";
  $("photoPreview").dataset.dataurl="";
  $("nameInput").value="";
  $("speciesInput").value="";
  $("locInput").value="";
  $("waterEvery").value="7";
  $("fertEvery").value="30";
  $("pruneEvery").value="90";
  $("memoInput").value="";
});

function makePlant({name,species,location,memo,photoDataUrl,waterEvery,fertEvery,pruneEvery}){
  const now = nowISO();
  return {
    id:newId("p"),
    name, species, location, memo,
    photoDataUrl: photoDataUrl || "",
    createdAt: now,

    waterEvery: Number(waterEvery)||0,
    fertEvery:  Number(fertEvery)||0,
    pruneEvery: Number(pruneEvery)||0,

    lastWaterAt: now,
    lastFertAt:  now,
    lastPruneAt: now
  };
}

$("savePlant").addEventListener("click", async ()=>{
  const name = $("nameInput").value.trim();
  if(!name){ alert("åå‰ã‚’å…¥ã‚Œã¦ã€‚"); return; }

  const btn = $("savePlant");
  const prev = btn.textContent;
  btn.textContent="ä¿å­˜ä¸­â€¦"; btn.disabled=true;

  const plant = makePlant({
    name,
    species: $("speciesInput").value.trim(),
    location:$("locInput").value.trim(),
    memo:$("memoInput").value.trim(),
    waterEvery:$("waterEvery").value,
    fertEvery:$("fertEvery").value,
    pruneEvery:$("pruneEvery").value,
    photoDataUrl:$("photoPreview").dataset.dataurl || ""
  });

  state.plants.unshift(plant);
  saveState();

  btn.textContent=prev; btn.disabled=false;
  $("resetAdd").click();

  renderPlants(); renderHome(); refreshDiagPlantSelect();
  showTab("plants");
});

/* ===== ã‚¿ã‚¹ã‚¯è‡ªå‹•ç”Ÿæˆ ===== */
function computeDueTasks(daysWindow){
  const today = toDateOnly(new Date());
  const until = addDays(today, daysWindow);

  const tasks=[];
  for(const p of state.plants){
    const items=[
      {kind:"water", label:"ğŸ’§ æ°´ã‚„ã‚Š", every:p.waterEvery||0, last:p.lastWaterAt||p.createdAt},
      {kind:"fert",  label:"ğŸ§ª è‚¥æ–™",   every:p.fertEvery||0,  last:p.lastFertAt||p.createdAt},
      {kind:"prune", label:"âœ‚ï¸ å‰ªå®š",   every:p.pruneEvery||0, last:p.lastPruneAt||p.createdAt},
    ];
    for(const it of items){
      if(!it.every || it.every<=0) continue;
      const base = toDateOnly(new Date(it.last));
      const due = addDays(base, it.every);
      if(due>=today && due<=until){
        tasks.push({ plantId:p.id, plantName:p.name, kind:it.kind, label:it.label, due });
      }
    }
  }
  tasks.sort((a,b)=>a.due-b.due);
  return tasks;
}
function markTaskDone(plantId, kind){
  const idx = state.plants.findIndex(x=>x.id===plantId);
  if(idx<0) return;
  const now = nowISO();
  const p = state.plants[idx];
  if(kind==="water") p.lastWaterAt=now;
  if(kind==="fert")  p.lastFertAt=now;
  if(kind==="prune") p.lastPruneAt=now;
  state.plants[idx]=p;
  saveState();
}

/* ===== ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ï¼šHome ===== */
function renderHome(){
  $("countPill").textContent = String(state.plants.length);

  const days = parseInt($("daysWindow").value||"3",10) || 3;
  const tasks = computeDueTasks(days);
  const list = $("taskList");
  list.innerHTML="";

  const empty = $("taskEmpty");
  if(tasks.length===0){
    empty.style.display="";
  }else{
    empty.style.display="none";
    const today = toDateOnly(new Date());
    for(const t of tasks){
      const diff = Math.round((toDateOnly(t.due)-today)/(1000*60*60*24));
      const tag = diff===0 ? "ä»Šæ—¥" : diff===1 ? "æ˜æ—¥" : `ã‚ã¨${diff}æ—¥`;
      const el = document.createElement("div");
      el.className="card soft";
      el.style.padding="12px";
      el.innerHTML = `
        <div style="display:flex;gap:12px;align-items:center;justify-content:space-between">
          <div>
            <div style="font-weight:999">${escapeHtml(t.plantName)} ã« ${escapeHtml(t.label)}</div>
            <div class="tiny" style="margin-top:4px">æœŸé™ï¼š${fmtMD(t.due)}ï¼ˆ${tag}ï¼‰</div>
          </div>
          <div class="row" style="gap:8px">
            <button class="btn ghost small" data-act="detail">è©³ç´°</button>
            <button class="btn small" data-act="done">å®Œäº†</button>
          </div>
        </div>`;
      el.querySelector('[data-act="detail"]').onclick=()=>openPlantModal(t.plantId);
      el.querySelector('[data-act="done"]').onclick=()=>{
        markTaskDone(t.plantId, t.kind);
        renderHome();
      };
      list.appendChild(el);
    }
  }
  renderHomeDiag();
}
$("daysWindow").addEventListener("change", renderHome);

/* ===== ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ï¼šPlants ===== */
function renderPlants(){
  const grid = $("plantGrid");
  grid.innerHTML="";
  if(state.plants.length===0){
    $("plantEmpty").style.display="";
    return;
  }
  $("plantEmpty").style.display="none";

  for(const p of state.plants){
    const card=document.createElement("div");
    card.className="plantCard";
    const thumb = p.photoDataUrl || "";
    const badge = p.location ? escapeHtml(p.location) : (p.species ? escapeHtml(p.species) : "ç™»éŒ²æ¸ˆ");
    card.innerHTML=`
      <div class="thumb">
        ${thumb? `<img src="${thumb}" alt="">` : ``}
        <div class="badge">${badge}</div>
      </div>
      <div class="plantBody">
        <div class="plantName">${escapeHtml(p.name)}</div>
        <div class="plantMeta">${escapeHtml(p.memo || "ãƒ¡ãƒ¢ãªã—")}</div>
      </div>`;
    card.addEventListener("click",()=>openPlantModal(p.id));
    grid.appendChild(card);
  }
}

/* ===== æ¤ç‰©è©³ç´°ï¼ˆãƒ¢ãƒ¼ãƒ€ãƒ«ï¼‰ ===== */
function openPlantModal(id){
  const p = state.plants.find(x=>x.id===id);
  if(!p) return;

  const img = p.photoDataUrl ? `<img class="modalImg" src="${p.photoDataUrl}" alt="">` : "";
  const fmtLast = (iso)=> iso ? fmtMD(iso) : "â€”";

  openModal(`è©³ç´°ï¼š${p.name}`, `
    ${img}
    <div class="hr"></div>

    <div class="row" style="gap:10px">
      <button class="btn small" id="markWater">ğŸ’§ æ°´ã‚„ã‚Š</button>
      <button class="btn ghost small" id="markFert">ğŸ§ª è‚¥æ–™</button>
      <button class="btn ghost small" id="markPrune">âœ‚ï¸ å‰ªå®š</button>
    </div>

    <div class="hr"></div>

    <div class="sub"><b>å“ç¨®</b><br>${escapeHtml(p.species || "â€”")}</div>
    <div class="hr"></div>
    <div class="sub"><b>ç½®ãå ´æ‰€</b><br>${escapeHtml(p.location || "â€”")}</div>
    <div class="hr"></div>
    <div class="sub"><b>ãƒ¡ãƒ¢</b><br>${escapeHtml(p.memo || "â€”")}</div>

    <div class="hr"></div>

    <div class="card soft" style="padding:12px">
      <div style="font-weight:999;margin-bottom:6px">å‘¨æœŸ</div>
      <div class="sub">ğŸ’§ ${p.waterEvery||0}æ—¥ / ğŸ§ª ${p.fertEvery||0}æ—¥ / âœ‚ï¸ ${p.pruneEvery||0}æ—¥</div>
      <div class="tiny" style="margin-top:6px">æœ€çµ‚ï¼šğŸ’§ ${fmtLast(p.lastWaterAt)} / ğŸ§ª ${fmtLast(p.lastFertAt)} / âœ‚ï¸ ${fmtLast(p.lastPruneAt)}</div>
    </div>

    <div class="hr"></div>

    <div class="row" style="justify-content:space-between">
      <button class="btn danger small" id="deletePlant">ğŸ§¨ å‰Šé™¤</button>
      <button class="btn ghost small" id="editPlant">âœï¸ ç·¨é›†</button>
    </div>
  `);

  const updatePlant=(patch)=>{
    const idx = state.plants.findIndex(x=>x.id===id);
    if(idx<0) return;
    state.plants[idx] = { ...state.plants[idx], ...patch };
    saveState();
    renderPlants(); renderHome(); refreshDiagPlantSelect();
  };

  $("markWater").onclick=()=>{ updatePlant({lastWaterAt:nowISO()}); openPlantModal(id); };
  $("markFert").onclick =()=>{ updatePlant({lastFertAt:nowISO()}); openPlantModal(id); };
  $("markPrune").onclick=()=>{ updatePlant({lastPruneAt:nowISO()}); openPlantModal(id); };

  $("deletePlant").onclick=()=>{
    if(!confirm("ã“ã®æ¤ç‰©ã‚’å‰Šé™¤ã™ã‚‹ï¼Ÿï¼ˆæˆ»ã›ãªã„ï¼‰")) return;
    state.plants = state.plants.filter(x=>x.id!==id);
    saveState();
    closeModal();
    renderPlants(); renderHome(); refreshDiagPlantSelect();
  };

  $("editPlant").onclick=()=>{
    openModal(`ç·¨é›†ï¼š${p.name}`, `
      <div class="sub">å†™çœŸã®å·®ã—æ›¿ãˆã¯ã€Œè¿½åŠ ã€ç”»é¢ã§æ’®ã‚Šç›´ã—ã¦ã‹ã‚‰ä½œã‚Šç›´ã™ã®ãŒæœ€é€Ÿã€‚</div>
      <div class="hr"></div>

      <label>åå‰</label>
      <input id="eName" value="${escapeHtml(p.name)}">

      <label>å“ç¨®</label>
      <input id="eSpecies" value="${escapeHtml(p.species||"")}">

      <label>ç½®ãå ´æ‰€</label>
      <input id="eLoc" value="${escapeHtml(p.location||"")}">

      <label>æ°´ã‚„ã‚Šå‘¨æœŸï¼ˆæ—¥ï¼‰</label>
      <input id="eW" type="number" min="0" value="${p.waterEvery||0}">

      <label>è‚¥æ–™å‘¨æœŸï¼ˆæ—¥ï¼‰</label>
      <input id="eF" type="number" min="0" value="${p.fertEvery||0}">

      <label>å‰ªå®šå‘¨æœŸï¼ˆæ—¥ï¼‰</label>
      <input id="eP" type="number" min="0" value="${p.pruneEvery||0}">

      <label>ãƒ¡ãƒ¢</label>
      <textarea id="eMemo">${escapeHtml(p.memo||"")}</textarea>

      <div class="row" style="margin-top:12px">
        <button class="btn" id="eSave">âœ… ä¿å­˜</button>
        <button class="btn ghost" id="eCancel">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      </div>
    `);
    $("eCancel").onclick=()=>openPlantModal(id);
    $("eSave").onclick=()=>{
      const nn=$("eName").value.trim();
      if(!nn){ alert("åå‰ã‚’å…¥ã‚Œã¦ã€‚"); return; }
      updatePlant({
        name:nn,
        species:$("eSpecies").value.trim(),
        location:$("eLoc").value.trim(),
        waterEvery:Number($("eW").value)||0,
        fertEvery:Number($("eF").value)||0,
        pruneEvery:Number($("eP").value)||0,
        memo:$("eMemo").value.trim()
      });
      openPlantModal(id);
    };
  };
}

/* ===== è¨ºæ–­ï¼šå…¥åŠ› ===== */
function refreshDiagPlantSelect(){
  const sel = $("diagPlantSelect");
  sel.innerHTML="";
  const opt0=document.createElement("option");
  opt0.value=""; opt0.textContent="ï¼ˆé¸ã°ãªã„ï¼‰";
  sel.appendChild(opt0);
  for(const p of state.plants){
    const opt=document.createElement("option");
    opt.value=p.id;
    opt.textContent=p.name;
    sel.appendChild(opt);
  }
}
refreshDiagPlantSelect();

/* å†™çœŸãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆè¨ºæ–­ï¼‰ */
$("diagPhotoInput").addEventListener("change", async ()=>{
  const f = $("diagPhotoInput").files?.[0];
  if(!f) return;
  try{
    const dataUrl = await compressImageFile(f, 980, 0.82);
    $("diagPreview").src=dataUrl;
    $("diagPreview").style.display="";
    $("diagPreview").dataset.dataurl=dataUrl;
  }catch{
    const raw=await fileToDataUrl(f);
    $("diagPreview").src=raw;
    $("diagPreview").style.display="";
    $("diagPreview").dataset.dataurl=raw;
  }
});

/* ===== è¨ºæ–­ãƒ«ãƒ¼ãƒ«ï¼ˆãƒ«ãƒ¼ãƒ«å¼ TOP3ï¼‰ ===== */
function runRuleDiagnosis(symSet, ctx){
  const scores = [];
  const add = (key, title, score, why, actions)=>{
    scores.push({key,title,score,why,actions});
  };

  // åŸºæœ¬ã‚¹ã‚³ã‚¢
  if(symSet.has("yellow")){
    add("overwater","æ°´ã®ã‚„ã‚Šã™ã", 3, "é»„ã°ã¿ã¯éæ¹¿ã§å‡ºã‚„ã™ã„", ["åœŸãŒä¹¾ãã¾ã§æ°´ã‚’æ­¢ã‚ã‚‹","é‰¢åº•ã®æ’æ°´ç¢ºèª","æ ¹è…ã‚Œãªã‚‰æ¤ãˆæ›¿ãˆ"]);
    add("underlight","æ—¥ç…§ä¸è¶³", 2, "å…‰ä¸è¶³ã§ã‚‚é»„ã°ã¿ã‚„ã™ã„", ["æ˜ã‚‹ã„æ—¥é™°ã¸ç§»å‹•","æ€¥ãªç›´å°„ã¯é¿ã‘ã‚‹"]);
    add("nutrient","æ „é¤Šä¸è¶³", 2, "æ–°èŠ½ä»¥å¤–ãŒè–„ããªã‚‹", ["è–„ã‚ã®æ¶²è‚¥ã‚’å°‘é‡","è‚¥æ–™ã¯é »åº¦ã‚ˆã‚Šé‡ã‚’æ§ãˆã‚"]);
  }
  if(symSet.has("spots")){
    add("fungus","ã‚«ãƒ“/ç—…æ°—ï¼ˆæ–‘ç‚¹ï¼‰", 3, "æ–‘ç‚¹ã¯ç—…æ°—ãƒ»ã‚¹ãƒˆãƒ¬ã‚¹ã®å…¸å‹", ["è‘‰ã‚’æ‹­ã/åˆ‡ã‚‹","é¢¨é€šã—UP","éæ¹¿ã‚’é¿ã‘ã‚‹"]);
    add("sunburn","è‘‰ç„¼ã‘", 2, "å¼·å…‰ã§ã‚·ãƒŸãŒå‡ºã‚‹", ["ãƒ¬ãƒ¼ã‚¹è¶Šã—ã«","ç§»å‹•ã¯æ®µéšçš„ã«"]);
  }
  if(symSet.has("wilting")){
    add("dry","æ°´åˆ‡ã‚Œ/ä¹¾ç‡¥", 3, "ã—ãŠã‚Œã¯æ°´ä¸è¶³ã®å…¸å‹", ["åœŸãŒä¹¾ã„ã¦ã„ã‚Œã°ãŸã£ã·ã‚Š","è‘‰æ°´ã§æ¹¿åº¦UP","æ ¹è©°ã¾ã‚Šç¢ºèª"]);
    add("rootrot","æ ¹è…ã‚Œ", 3, "éæ¹¿ã§ã‚‚ã—ãŠã‚Œã‚‹", ["åœŸãŒæ¹¿ã£ã¦é‡ã„ãªã‚‰æ°´åœæ­¢","æ ¹ã®çŠ¶æ…‹ç¢ºèª","æ¤ãˆæ›¿ãˆæ¤œè¨"]);
  }
  if(symSet.has("bugs")){
    add("pests","å®³è™«ï¼ˆãƒãƒ€ãƒ‹/ã‚«ã‚¤ã‚¬ãƒ©ãƒ ã‚·ç­‰ï¼‰", 4, "ãƒ™ã‚¿ã¤ããƒ»è™«ã¯ã»ã¼å®³è™«", ["è‘‰è£ã‚’æ´—ã†/æ‹­ã","éš”é›¢","å¿…è¦ãªã‚‰è–¬å‰¤"]);
  }
  if(symSet.has("mold")){
    add("powdery","ã†ã©ã‚“ã“/ã‚«ãƒ“", 4, "ç™½ã„ç²‰ã¯ã‚«ãƒ“ã®å¯èƒ½æ€§å¤§", ["è‘‰ã‚’æ‹­ã/åˆ‡ã‚‹","é¢¨é€šã—UP","æ°´ã‚„ã‚Šæ§ãˆã‚"]);
  }
  if(symSet.has("brown")){
    add("dryair","ä¹¾ç‡¥/æ°´åˆ‡ã‚Œ", 3, "èŒ¶æ¯ã‚Œã¯ä¹¾ç‡¥ã‚„æ°´åˆ‡ã‚Œ", ["æ°´ã®è¦‹ç›´ã—","è‘‰æ°´/åŠ æ¹¿","ç›´å°„ã‚„ã‚¨ã‚¢ã‚³ãƒ³é¢¨å›é¿"]);
    add("salt","è‚¥æ–™ç„¼ã‘", 2, "è‚¥æ–™éå¤šã§å…ˆãŒæ¯ã‚Œã‚‹", ["è‚¥æ–™ã‚’æ­¢ã‚ã‚‹","ä¸€åº¦ãŸã£ã·ã‚Šæµã™"]);
  }

  // æ–‡è„ˆè£œæ­£
  if(ctx.water==="more"){
    for(const s of scores){ if(s.key==="overwater"||s.key==="rootrot") s.score+=2; }
  }
  if(ctx.water==="less"){
    for(const s of scores){ if(s.key==="dry") s.score+=2; }
  }
  if(ctx.light==="strong"){
    for(const s of scores){ if(s.key==="sunburn") s.score+=2; }
  }
  if(ctx.light==="weak"){
    for(const s of scores){ if(s.key==="underlight") s.score+=2; }
  }
  if(ctx.air==="bad"){
    for(const s of scores){ if(s.key==="fungus"||s.key==="powdery") s.score+=2; }
  }

  // åŒç‚¹æ•´ç†
  scores.sort((a,b)=>b.score-a.score);
  const top = scores.slice(0,3);
  return top.length ? top : [{title:"æƒ…å ±ä¸è¶³", score:0, why:"ç—‡çŠ¶ãŒå°‘ãªã„", actions:["ç—‡çŠ¶ã‚’è¿½åŠ ","å†™çœŸã‚’æ’®ã‚‹","æ°´ã‚„ã‚Š/å…‰/é¢¨é€šã—ã‚’é¸ã¶"]}];
}

/* ===== è¨ºæ–­ï¼šä¿å­˜ãƒ­ã‚° ===== */
function addDiagLog({plantId, plantName, photoDataUrl, sym, ctx, memo, result}){
  const log = {
    id:newId("d"),
    createdAt: nowISO(),
    plantId: plantId || "",
    plantName: plantName || "",
    photoDataUrl: photoDataUrl || "",
    sym: Array.from(sym),
    ctx,
    memo: memo || "",
    result
  };
  state.diagLogs.unshift(log);
  state.diagLogs = state.diagLogs.slice(0,50); // ä¸Šé™
  saveState();
}

/* ===== è¨ºæ–­ï¼šå®Ÿè¡Œ ===== */
$("runDiag").addEventListener("click", ()=>{
  const sym = new Set(Array.from(document.querySelectorAll(".sym:checked")).map(x=>x.value));
  const ctx = {
    water: $("ctxWater").value,
    light: $("ctxLight").value,
    air: $("ctxAir").value
  };
  const memo = $("diagMemo").value.trim();
  const plantId = $("diagPlantSelect").value;
  const plant = plantId ? state.plants.find(p=>p.id===plantId) : null;

  const result = runRuleDiagnosis(sym, ctx);

  $("diagResult").innerHTML = `
    <div style="font-weight:999;margin-bottom:8px">åŸå› å€™è£œTOP${result.length}</div>
    ${result.map((r,i)=>`
      <div class="card soft" style="padding:12px;margin-top:10px">
        <div style="display:flex;justify-content:space-between;gap:10px;align-items:center">
          <div style="font-weight:999">${i+1}. ${escapeHtml(r.title)}</div>
          <div class="chip ${r.score>=5?'bad':r.score>=3?'warn':'ok'}">ã‚¹ã‚³ã‚¢ ${r.score}</div>
        </div>
        <div class="tiny" style="margin-top:6px">${escapeHtml(r.why||"")}</div>
        <div class="tiny" style="margin-top:8px"><b>å¯¾å‡¦</b>ï¼š${escapeHtml((r.actions||[]).join(" / "))}</div>
      </div>
    `).join("")}
    <div class="hr"></div>
    <div class="tiny">â€»ã“ã‚Œã¯ãƒ«ãƒ¼ãƒ«å¼ã€‚æ­£ç¢ºæ€§ã‚’ä¸Šã’ã‚‹ãªã‚‰æ¬¡ã§AIåŒ–ã§ãã‚‹ã€‚</div>
  `;

  const photo = $("diagPreview").dataset.dataurl || "";
  addDiagLog({
    plantId,
    plantName: plant ? plant.name : "",
    photoDataUrl: photo,
    sym,
    ctx,
    memo,
    result
  });

  renderDiagLogs();
  renderHomeDiag();
});
$("resetDiag").addEventListener("click", ()=>{
  $("diagPhotoInput").value="";
  $("diagPreview").style.display="none";
  $("diagPreview").src="";
  $("diagPreview").dataset.dataurl="";
  $("diagPlantSelect").value="";
  document.querySelectorAll(".sym").forEach(x=>x.checked=false);
  $("ctxWater").value="unknown";
  $("ctxLight").value="unknown";
  $("ctxAir").value="unknown";
  $("diagMemo").value="";
  $("diagResult").textContent="ã¾ã åˆ¤å®šã—ã¦ãªã„ã€‚";
});
$("clearDiagLogs").addEventListener("click", ()=>{
  if(!confirm("è¨ºæ–­ãƒ­ã‚°ã‚’å…¨éƒ¨æ¶ˆã™ï¼Ÿ")) return;
  state.diagLogs=[];
  saveState();
  renderDiagLogs();
  renderHomeDiag();
});

/* ===== è¨ºæ–­ãƒ­ã‚°è¡¨ç¤º ===== */
function renderDiagLogs(){
  const list = $("diagLogList");
  list.innerHTML="";
  if(state.diagLogs.length===0){
    $("diagLogEmpty").style.display="";
    return;
  }
  $("diagLogEmpty").style.display="none";

  state.diagLogs.slice(0,12).forEach(log=>{
    const el=document.createElement("div");
    el.className="card soft";
    el.style.padding="12px";
    const t = new Date(log.createdAt);
    const head = `${fmtMD(t)} ${fmtHM(t)}${log.plantName?` / ${log.plantName}`:""}`;
    const top = (log.result && log.result[0]) ? log.result[0].title : "â€”";
    el.innerHTML=`
      <div style="display:flex;justify-content:space-between;gap:10px;align-items:center">
        <div>
          <div style="font-weight:999">${escapeHtml(head)}</div>
          <div class="tiny" style="margin-top:4px">TOPï¼š${escapeHtml(top)}</div>
        </div>
        <button class="btn ghost small">è©³ç´°</button>
      </div>
    `;
    el.querySelector("button").onclick=()=>openDiagModal(log.id);
    list.appendChild(el);
  });
}

function renderHomeDiag(){
  const list = $("homeDiagList");
  list.innerHTML="";
  const logs = state.diagLogs.slice(0,3);
  if(logs.length===0){
    $("homeDiagEmpty").style.display="";
    return;
  }
  $("homeDiagEmpty").style.display="none";

  logs.forEach(log=>{
    const t = new Date(log.createdAt);
    const head = `${fmtMD(t)} ${fmtHM(t)}${log.plantName?` / ${log.plantName}`:""}`;
    const top = (log.result && log.result[0]) ? log.result[0].title : "â€”";
    const el=document.createElement("div");
    el.className="card soft";
    el.style.padding="12px";
    el.innerHTML=`
      <div style="display:flex;justify-content:space-between;gap:10px;align-items:center">
        <div>
          <div style="font-weight:999">${escapeHtml(head)}</div>
          <div class="tiny" style="margin-top:4px">TOPï¼š${escapeHtml(top)}</div>
        </div>
        <button class="btn ghost small">è¦‹ã‚‹</button>
      </div>
    `;
    el.querySelector("button").onclick=()=>{ showTab("diag"); openDiagModal(log.id); };
    list.appendChild(el);
  });
}

function openDiagModal(id){
  const log = state.diagLogs.find(x=>x.id===id);
  if(!log) return;
  const img = log.photoDataUrl ? `<img class="modalImg" src="${log.photoDataUrl}" alt="">` : "";
  const t = new Date(log.createdAt);
  const head = `${fmtMD(t)} ${fmtHM(t)}${log.plantName?` / ${log.plantName}`:""}`;
  const symTxt = (log.sym||[]).join(" / ") || "ï¼ˆæœªé¸æŠï¼‰";
  const ctxTxt = `æ°´:${log.ctx?.water||"unknown"} å…‰:${log.ctx?.light||"unknown"} é¢¨:${log.ctx?.air||"unknown"}`;
  openModal("è¨ºæ–­ãƒ­ã‚°", `
    ${img}
    <div class="hr"></div>
    <div style="font-weight:999">${escapeHtml(head)}</div>
    <div class="tiny" style="margin-top:6px">ç—‡çŠ¶ï¼š${escapeHtml(symTxt)}</div>
    <div class="tiny" style="margin-top:6px">çŠ¶æ³ï¼š${escapeHtml(ctxTxt)}</div>
    ${log.memo? `<div class="hr"></div><div class="tiny"><b>ãƒ¡ãƒ¢</b><br>${escapeHtml(log.memo)}</div>`:""}
    <div class="hr"></div>
    <div style="font-weight:999;margin-bottom:6px">çµæœ</div>
    ${(log.result||[]).map((r,i)=>`
      <div class="card soft" style="padding:12px;margin-top:10px">
        <div style="font-weight:999">${i+1}. ${escapeHtml(r.title||"")}</div>
        <div class="tiny" style="margin-top:6px">${escapeHtml(r.why||"")}</div>
        <div class="tiny" style="margin-top:8px"><b>å¯¾å‡¦</b>ï¼š${escapeHtml((r.actions||[]).join(" / "))}</div>
      </div>
    `).join("")}
    <div class="hr"></div>
    <div class="row" style="justify-content:space-between">
      <button class="btn danger small" id="delLog">ğŸ§¨ ã“ã®ãƒ­ã‚°å‰Šé™¤</button>
      <button class="btn ghost small" id="closeLog">é–‰ã˜ã‚‹</button>
    </div>
  `);
  $("closeLog").onclick=closeModal;
  $("delLog").onclick=()=>{
    if(!confirm("ã“ã®ãƒ­ã‚°ã‚’å‰Šé™¤ã™ã‚‹ï¼Ÿ")) return;
    state.diagLogs = state.diagLogs.filter(x=>x.id!==id);
    saveState();
    closeModal();
    renderDiagLogs();
    renderHomeDiag();
  };
}

/* ===== ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼ˆä¿å­˜ãƒ•ã‚¡ã‚¤ãƒ«ï¼‰ ===== */
function downloadText(filename, text, mime="application/json"){
  const blob = new Blob([text], { type:mime });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href=url; a.download=filename;
  document.body.appendChild(a);
  a.click(); a.remove();
  URL.revokeObjectURL(url);
}
function fmtYMD(d){
  const x=new Date(d);
  return `${x.getFullYear()}-${String(x.getMonth()+1).padStart(2,"0")}-${String(x.getDate()).padStart(2,"0")}`;
}
$("exportBtn").addEventListener("click", ()=>{
  downloadText(`PlantLog_ä¿å­˜ãƒ•ã‚¡ã‚¤ãƒ«_${fmtYMD(new Date())}.json`, JSON.stringify(state,null,2), "application/json");
  alert("ä¿å­˜ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œã£ãŸã‚ˆã€‚ã€ãƒ•ã‚¡ã‚¤ãƒ«ã€ã‚¢ãƒ—ãƒªã«ä¿å­˜ã—ã¦ã­ã€‚");
});
$("importBtn").addEventListener("click", async ()=>{
  const f = $("importInput").files?.[0];
  if(!f){ alert("ä¿å­˜ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸ã‚“ã§ã­ã€‚"); return; }
  try{
    const obj = JSON.parse(await f.text());
    if(!obj || !Array.isArray(obj.plants)) throw new Error("format");
    state = {
      plants: Array.isArray(obj.plants)?obj.plants:[],
      diagLogs: Array.isArray(obj.diagLogs)?obj.diagLogs:[]
    };
    saveState();
    renderPlants(); renderHome(); refreshDiagPlantSelect(); renderDiagLogs(); renderHomeDiag();
    showTab("home");
    alert("å¾©å…ƒã§ããŸã‚ˆã€‚");
  }catch{
    alert("ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯PlantLogã®ä¿å­˜ãƒ•ã‚¡ã‚¤ãƒ«ã˜ã‚ƒãªã„ã‹ã‚‚ã€‚åˆ¥ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸ã‚“ã§ã­ã€‚");
  }
});
$("wipeBtn").addEventListener("click", ()=>{
  if(!confirm("æœ¬å½“ã«å…¨éƒ¨æ¶ˆã™ï¼Ÿï¼ˆæˆ»ã›ãªã„ï¼‰\nå…ˆã«ã€ä¿å­˜ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œã‚‹ã€æ¨å¥¨ï¼")) return;
  state = { plants:[], diagLogs:[] };
  saveState();
  renderPlants(); renderHome(); refreshDiagPlantSelect(); renderDiagLogs(); renderHomeDiag();
  alert("å…¨ãƒ‡ãƒ¼ã‚¿ã‚’æ¶ˆã—ãŸã‚ˆã€‚");
});

/* ===== ICSï¼ˆæœŸé™æ—¥ã‚’ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã«å…¥ã‚Œã‚‹ï¼‰ ===== */
function pad2(n){ return String(n).padStart(2,"0"); }
function toIcsDate(d){
  const x=new Date(d);
  return `${x.getFullYear()}${pad2(x.getMonth()+1)}${pad2(x.getDate())}`;
}
function icsEscape(s){ return String(s).replace(/\\n/g," ").replace(/,/g,"\\,").replace(/;/g,"\\;"); }

$("exportIcsBtn").addEventListener("click", ()=>{
  const days = 60; // 60æ—¥åˆ†æ›¸ãå‡ºã—
  const tasks = computeDueTasks(days);
  if(tasks.length===0){ alert("äºˆå®šã«å‡ºã›ã‚‹ã‚¿ã‚¹ã‚¯ãŒãªã„ã€‚"); return; }

  const lines = [];
  lines.push("BEGIN:VCALENDAR");
  lines.push("VERSION:2.0");
  lines.push("PRODID:-//PlantLog//JP");
  lines.push("CALSCALE:GREGORIAN");

  tasks.slice(0,200).forEach(t=>{
    const dt = toIcsDate(t.due);
    const uid = `${t.plantId}-${t.kind}-${dt}@plantlog`;
    const summary = `${t.plantName}ï¼š${t.label}`;
    lines.push("BEGIN:VEVENT");
    lines.push(`UID:${uid}`);
    lines.push(`DTSTAMP:${toIcsDate(new Date())}T000000Z`);
    lines.push(`DTSTART;VALUE=DATE:${dt}`);
    lines.push(`DTEND;VALUE=DATE:${dt}`);
    lines.push(`SUMMARY:${icsEscape(summary)}`);
    lines.push("END:VEVENT");
  });

  lines.push("END:VCALENDAR");

  downloadText(`PlantLog_ã‚¿ã‚¹ã‚¯é€šçŸ¥_${fmtYMD(new Date())}.ics`, lines.join("\r\n"), "text/calendar");
  alert("icsã‚’ä½œã£ãŸã‚ˆã€‚ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã«èª­ã¿è¾¼ã‚€ã¨æœŸé™ãŒå…¥ã‚‹ã€‚");
});

/* ===== åˆæœŸãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚° ===== */
renderPlants();
renderHome();
renderDiagLogs();
renderHomeDiag();
refreshDiagPlantSelect();
showTab("home");
  </script>

</body>
</html>
