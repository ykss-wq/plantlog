<!doctype html>
<html lang="ja" data-theme="light">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>PlantLog</title>
  <meta name="theme-color" content="#f4efe6" />

  <style>
    /* =========================
      THEME TOKENS
    ========================= */
    :root{
      --bg:#f4efe6;
      --panel:#ffffff;
      --panel2:#fbf7f0;
      --line:#e7ded2;

      --text:#2b2b2b;
      --muted:#7a756b;

      --accent:#6a8f6a;
      --accent2:#94b594;

      --danger:#ef4444;
      --danger2:#fb7185;

      --shadow: 0 10px 28px rgba(60,40,20,.10);
      --shadow2: 0 6px 18px rgba(60,40,20,.08);
      --radius:22px;
      --radius2:16px;
    }

    /* âœ… ãƒ€ãƒ¼ã‚¯ï¼ˆä¸‡èƒ½æ„Ÿï¼‰ */
    [data-theme="dark"]{
      --bg:#070b10;
      --panel:rgba(15,23,34,.86);
      --panel2:rgba(12,19,32,.78);
      --line:rgba(255,255,255,.10);

      --text:#e9eef6;
      --muted:#9bb0c6;

      --accent:#26e39b;
      --accent2:#2bd3ff;

      --danger:#ff6b6b;
      --danger2:#ff9f6b;

      --shadow: 0 18px 50px rgba(0,0,0,.45);
      --shadow2: 0 10px 30px rgba(0,0,0,.35);
    }

    *{box-sizing:border-box}
    html,body{height:100%}

    body{
      margin:0;
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,"Hiragino Kaku Gothic ProN","Noto Sans JP","Yu Gothic",sans-serif;
      color:var(--text);
      background: var(--bg);
      padding:
        calc(env(safe-area-inset-top) + 14px)
        14px
        calc(env(safe-area-inset-bottom) + 140px);
      overflow-x:hidden;
      position:relative;
    }

    /* âœ… æ·¡ã„èƒŒæ™¯ï¼ˆãƒ†ãƒ¼ãƒã«åˆã‚ã›ã¦å¤‰åŒ–ï¼‰ */
    body:before{
      content:"";
      position:fixed; inset:0;
      pointer-events:none;
      opacity:.65;
      background:
        radial-gradient(820px 520px at 10% 25%, color-mix(in srgb, var(--accent) 18%, transparent), transparent 62%),
        radial-gradient(760px 520px at 95% 22%, color-mix(in srgb, var(--accent2) 16%, transparent), transparent 62%),
        radial-gradient(820px 520px at 50% 115%, color-mix(in srgb, var(--accent) 12%, transparent), transparent 64%);
    }

    .wrap{max-width:980px;margin:0 auto; position:relative;}
    .grid{display:grid;gap:14px}

    /* =========================
      HEADER
    ========================= */
    header{
      position:sticky; top:0; z-index:20;
      margin:-6px 0 10px;
      padding: 8px 0 12px;
      background: color-mix(in srgb, var(--bg) 86%, transparent);
      backdrop-filter: blur(12px);
      border-bottom:1px solid color-mix(in srgb, var(--line) 80%, transparent);
    }
    .top{
      display:flex; align-items:flex-start; justify-content:space-between; gap:12px;
      padding: 0 2px 10px;
    }
    .brand{display:flex; align-items:center; gap:10px;}
    .logo{
      width:40px;height:40px;border-radius:14px;
      display:grid;place-items:center;
      background: linear-gradient(135deg, color-mix(in srgb, var(--accent) 18%, transparent), color-mix(in srgb, var(--accent2) 14%, transparent));
      border:1px solid color-mix(in srgb, var(--line) 92%, transparent);
      box-shadow: var(--shadow2);
      font-size:18px;
    }
    .title{margin:0;font-size:20px;letter-spacing:.2px;line-height:1.1;}
    .subtitle{margin-top:4px;font-size:12px;color:var(--muted);}

    .pill{
      font-size:12px;
      color:var(--muted);
      padding:8px 12px;
      border:1px solid color-mix(in srgb, var(--line) 92%, transparent);
      border-radius:999px;
      background: color-mix(in srgb, var(--panel) 78%, transparent);
      box-shadow: 0 8px 18px rgba(60,40,20,.06);
      white-space:nowrap;
    }
    .pillBtn{
      cursor:pointer;
      user-select:none;
    }

    /* top tabs scroll */
    .tabs{
      display:flex; gap:10px;
      overflow-x:auto;
      -webkit-overflow-scrolling:touch;
      padding: 0 2px 4px;
      scrollbar-width:none;
    }
    .tabs::-webkit-scrollbar{display:none}
    .tab{
      flex:0 0 auto;
      display:flex; align-items:center; gap:8px;
      padding:12px 14px;
      border-radius:999px;
      border:1px solid color-mix(in srgb, var(--line) 92%, transparent);
      background: color-mix(in srgb, var(--panel) 72%, transparent);
      box-shadow: var(--shadow2);
      cursor:pointer;
      user-select:none;
      font-weight:900;
      font-size:14px;
    }
    .tab.active{
      background: linear-gradient(90deg,
        color-mix(in srgb, var(--accent) 24%, transparent),
        color-mix(in srgb, var(--accent2) 18%, transparent));
      border-color: color-mix(in srgb, var(--accent) 36%, var(--line));
    }

    /* =========================
      CARDS
    ========================= */
    .card{
      border:1px solid color-mix(in srgb, var(--line) 92%, transparent);
      border-radius: var(--radius);
      background: color-mix(in srgb, var(--panel) 88%, transparent);
      box-shadow: var(--shadow);
      padding: 16px;
      overflow:hidden;
    }
    .card.soft{background: color-mix(in srgb, var(--panel) 78%, transparent); box-shadow:none;}
    .cardTitle{
      margin:0 0 6px;
      font-size:18px;
      letter-spacing:.2px;
      display:flex;gap:8px;align-items:center;
      font-weight:999;
    }
    .sub{color:var(--muted);font-size:13px;line-height:1.6;}
    .hr{height:1px;background:color-mix(in srgb, var(--line) 85%, transparent); margin:14px 0}

    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;}
    .btn{
      border:none;
      background: linear-gradient(90deg, var(--accent), var(--accent2));
      color: color-mix(in srgb, var(--text) 10%, #0d2011);
      font-weight:999;
      padding:12px 14px;
      border-radius:14px;
      cursor:pointer;
      box-shadow: 0 12px 24px color-mix(in srgb, var(--accent) 18%, transparent);
    }
    .btn.small{padding:10px 12px;font-size:13px;border-radius:12px}
    .btn.ghost{
      background: color-mix(in srgb, var(--panel) 88%, transparent);
      border:1px solid color-mix(in srgb, var(--line) 92%, transparent);
      box-shadow:none;
      color:var(--text);
      font-weight:999;
    }
    .btn.danger{
      background: linear-gradient(90deg, var(--danger), var(--danger2));
      color:#2a0b0b;
      box-shadow: 0 12px 24px color-mix(in srgb, var(--danger) 20%, transparent);
    }

    input,select,textarea{
      width:100%;
      border:1px solid color-mix(in srgb, var(--line) 92%, transparent);
      border-radius:14px;
      padding:12px 12px;
      background: color-mix(in srgb, var(--panel) 78%, transparent);
      color:var(--text);
      outline:none;
      font-size:14px;
    }
    textarea{min-height:92px;resize:vertical}
    label{display:block;margin:12px 0 6px;font-size:12px;color:var(--muted)}

    /* =========================
      UNIVERSAL HOME (cards)
    ========================= */
    .homeGrid{
      display:grid;
      gap:12px;
      grid-template-columns: 1fr;
    }
    @media(min-width:860px){
      .homeGrid{ grid-template-columns: 1fr 1fr; }
    }

    .actionCard{
      position:relative;
      border-radius: var(--radius);
      border:1px solid color-mix(in srgb, var(--line) 92%, transparent);
      background: linear-gradient(180deg,
        color-mix(in srgb, var(--panel) 86%, transparent),
        color-mix(in srgb, var(--panel2) 86%, transparent));
      box-shadow: var(--shadow);
      padding:14px;
      overflow:hidden;
      cursor:pointer;
    }
    .actionCard:before{
      content:"";
      position:absolute; inset:-80px;
      background: radial-gradient(420px 220px at 20% 20%,
        color-mix(in srgb, var(--accent) 22%, transparent), transparent 60%);
      opacity:.9;
      pointer-events:none;
      transform: rotate(6deg);
    }
    .actionTop{
      display:flex;justify-content:space-between;gap:12px;align-items:flex-start;
      position:relative; z-index:1;
    }
    .actionIcon{
      width:44px;height:44px;border-radius:16px;
      display:grid;place-items:center;
      border:1px solid color-mix(in srgb, var(--line) 92%, transparent);
      background: color-mix(in srgb, var(--panel) 78%, transparent);
      box-shadow: var(--shadow2);
      font-size:20px;
      flex:0 0 auto;
    }
    .actionTitle{
      margin:0;
      font-weight:999;
      font-size:16px;
      letter-spacing:.2px;
    }
    .actionDesc{
      margin-top:6px;
      font-size:12px;
      color:var(--muted);
      line-height:1.55;
    }
    .actionMeta{
      margin-top:10px;
      display:flex;gap:8px;flex-wrap:wrap;
    }
    .miniPill{
      font-size:12px;
      padding:7px 10px;
      border-radius:999px;
      border:1px solid color-mix(in srgb, var(--line) 92%, transparent);
      background: color-mix(in srgb, var(--panel) 78%, transparent);
      color:var(--muted);
      font-weight:900;
    }
    .ctaRow{
      margin-top:12px;
      display:flex;gap:10px;flex-wrap:wrap;
      position:relative; z-index:1;
    }

    /* =========================
      PLANTS GRID
    ========================= */
    .plantGrid{
      display:grid;
      gap:12px;
      grid-template-columns: repeat(2, minmax(0,1fr));
    }
    @media(min-width:860px){ .plantGrid{grid-template-columns: repeat(3, minmax(0,1fr));} }

    .plantCard{
      border:1px solid color-mix(in srgb, var(--line) 92%, transparent);
      border-radius: var(--radius);
      overflow:hidden;
      background: color-mix(in srgb, var(--panel) 86%, transparent);
      box-shadow: var(--shadow);
      cursor:pointer;
    }
    .thumb{
      height:120px;
      background: linear-gradient(90deg,
        color-mix(in srgb, var(--accent) 22%, transparent),
        color-mix(in srgb, var(--accent2) 18%, transparent));
      position:relative;
    }
    .thumb img{width:100%;height:100%;object-fit:cover;display:block}
    .badge{
      position:absolute;left:10px;top:10px;
      font-size:12px;
      padding:7px 10px;
      border-radius:999px;
      background: color-mix(in srgb, var(--panel) 86%, transparent);
      border:1px solid color-mix(in srgb, var(--line) 92%, transparent);
      color:var(--muted);
      font-weight:999;
      backdrop-filter: blur(8px);
    }
    .plantBody{padding:12px}
    .plantName{margin:0;font-size:15px;font-weight:999}
    .plantMeta{margin-top:6px;font-size:12px;color:var(--muted);line-height:1.45}

    /* =========================
      MODAL
    ========================= */
    .modalBack{
      position:fixed; inset:0;
      background: rgba(0,0,0,.26);
      display:none;
      align-items:flex-end;
      justify-content:center;
      padding: 18px;
      z-index:60;
    }
    .modal{
      width:min(720px, 100%);
      border-radius: 22px;
      background: color-mix(in srgb, var(--panel) 96%, transparent);
      border:1px solid color-mix(in srgb, var(--line) 92%, transparent);
      box-shadow: 0 30px 90px rgba(0,0,0,.25);
      overflow:hidden;
    }
    .modalHeader{
      display:flex; justify-content:space-between; align-items:center;
      padding:14px 14px;
      border-bottom:1px solid color-mix(in srgb, var(--line) 92%, transparent);
    }
    .x{
      border:1px solid color-mix(in srgb, var(--line) 92%, transparent);
      background: color-mix(in srgb, var(--panel) 86%, transparent);
      border-radius:12px;
      padding:8px 10px;
      cursor:pointer;
      font-weight:999;
      color:var(--text);
    }
    .modalBody{padding:14px}
    .modalImg{
      width:100%;
      height:220px;
      object-fit:cover;
      border-radius: 18px;
      border:1px solid color-mix(in srgb, var(--line) 92%, transparent);
      background: color-mix(in srgb, var(--panel) 86%, transparent);
    }
    a{color: color-mix(in srgb, var(--accent2) 70%, #2f7e66)}

    /* =========================
      BOTTOM NAV
    ========================= */
    .bottomNav{
      position:fixed;
      left:14px; right:14px;
      bottom: calc(env(safe-area-inset-bottom) + 18px);
      height:66px;
      border-radius: 20px;
      border:1px solid color-mix(in srgb, var(--line) 92%, transparent);
      background: color-mix(in srgb, var(--panel) 86%, transparent);
      box-shadow: 0 18px 40px rgba(0,0,0,.14);
      display:flex;
      overflow:hidden;
      z-index:40;
      backdrop-filter: blur(12px);
      touch-action: manipulation;
      transition: transform .22s ease;
    }
    .bottomNav.hide{ transform: translateY(120%); }

    .navBtn{
      flex:1;
      border:none;
      background:transparent;
      display:flex;flex-direction:column;
      align-items:center;justify-content:center;
      gap:6px;
      color:var(--muted);
      font-weight:999;
      cursor:pointer;
    }
    .navBtn .ico{font-size:18px;line-height:1}
    .navBtn.active{color: var(--accent)}
    .navMid{
      width:72px;
      display:flex;align-items:center;justify-content:center;
      border-left:1px solid color-mix(in srgb, var(--line) 75%, transparent);
      border-right:1px solid color-mix(in srgb, var(--line) 75%, transparent);
      background: linear-gradient(180deg,
        color-mix(in srgb, var(--accent) 10%, transparent),
        transparent);
    }
    .navMid button{
      width:46px;height:46px;border-radius:16px;
      border:none;
      background: linear-gradient(90deg, var(--accent), var(--accent2));
      color:#0d2011;font-weight:999;
      box-shadow: 0 14px 26px color-mix(in srgb, var(--accent) 22%, transparent);
      cursor:pointer;
      font-size:20px;
    }
    .tiny{font-size:12px;color:var(--muted)}
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="top">
        <div class="brand">
          <div class="logo">ğŸƒ</div>
          <div>
            <h1 class="title">PlantLog</h1>
            <div class="subtitle">æ¤ç‰©ã®ç®¡ç†ã‚’å„ªã—ãã‹ã‚“ãŸã‚“ã«</div>
          </div>
        </div>

        <div class="row" style="justify-content:flex-end">
          <div class="pill" id="statusPill">ä¿å­˜: ç«¯æœ«ã®ä¸­</div>
          <div class="pill pillBtn" id="themeBtn">ğŸŒ™ ãƒ€ãƒ¼ã‚¯</div>
        </div>
      </div>

      <div class="tabs" id="tabs">
        <div class="tab active" data-tab="home">ğŸ  ãƒ›ãƒ¼ãƒ </div>
        <div class="tab" data-tab="plants">ğŸŒ¿ æ¤ç‰©</div>
        <div class="tab" data-tab="add">â• è¿½åŠ </div>
        <div class="tab" data-tab="diag">ğŸ©º ãƒã‚§ãƒƒã‚¯</div>
        <div class="tab" data-tab="backup">ğŸ’¾ ä¿å­˜</div>
      </div>
    </header>

    <main class="grid">
      <!-- HOME (ä¸‡èƒ½ãƒ›ãƒ¼ãƒ ï¼šã‚«ãƒ¼ãƒ‰ã§é›†ç´„) -->
      <section class="card" id="view-home">
        <h2 class="cardTitle">ğŸ  ä»Šæ—¥ã¯ã“ã‚Œã ã‘</h2>
        <div class="sub">ã€Œè¿½åŠ ã€ã€Œãƒã‚§ãƒƒã‚¯ã€ã€Œä¿å­˜ã€ã‚’è¿·ã‚ãšä½¿ãˆã‚‹ã‚ˆã†ã«ã¾ã¨ã‚ãŸã€‚</div>
        <div class="hr"></div>

        <div class="homeGrid">
          <!-- ä»Šæ—¥ -->
          <div class="actionCard" id="homeToday">
            <div class="actionTop">
              <div style="display:flex;gap:12px;align-items:flex-start">
                <div class="actionIcon">ğŸ—“ï¸</div>
                <div>
                  <div class="actionTitle">ä»Šæ—¥ã®ã‚¿ã‚¹ã‚¯</div>
                  <div class="actionDesc">æ°´ã‚„ã‚Šãƒ»è‚¥æ–™ãƒ»å‰ªå®šã®ã€Œè¿‘ã„æœŸé™ã€ã ã‘è¡¨ç¤ºã€‚</div>
                </div>
              </div>
            </div>
            <div class="actionMeta">
              <span class="miniPill">ç™»éŒ² <b id="countPill">0</b></span>
              <span class="miniPill">æœŸé™ <b id="duePill">0</b></span>
              <span class="miniPill">è¡¨ç¤º <input id="daysWindow" type="number" min="0" value="3"
                style="width:44px;border:none;background:transparent;text-align:center;padding:0;margin:0 4px;color:var(--text);font-weight:999" />æ—¥</span>
            </div>
            <div class="ctaRow">
              <button class="btn small" id="homeGoAdd">ï¼‹ è¿½åŠ </button>
              <button class="btn ghost small" id="homeGoPlants">ä¸€è¦§</button>
            </div>
          </div>

          <!-- å†™çœŸãƒã‚§ãƒƒã‚¯ -->
          <div class="actionCard" id="homeDiag">
            <div class="actionTop">
              <div style="display:flex;gap:12px;align-items:flex-start">
                <div class="actionIcon">ğŸ“¸</div>
                <div>
                  <div class="actionTitle">å†™çœŸã§çŠ¶æ…‹ãƒã‚§ãƒƒã‚¯</div>
                  <div class="actionDesc">ç—‡çŠ¶ã‚’é¸ã¶ã ã‘ã§ã€ŒåŸå› å€™è£œã€ã¨ã€Œå¯¾å‡¦ã€ã‚’å‡ºã™ã€‚</div>
                </div>
              </div>
            </div>
            <div class="ctaRow">
              <button class="btn small" id="homeGoDiag">é–‹ã</button>
              <button class="btn ghost small" id="homeGoAdd2">ã¾ãšè¿½åŠ </button>
            </div>
          </div>

          <!-- ã‚¯ã‚¤ãƒƒã‚¯è¿½åŠ  -->
          <div class="actionCard" id="homeAdd">
            <div class="actionTop">
              <div style="display:flex;gap:12px;align-items:flex-start">
                <div class="actionIcon">â•</div>
                <div>
                  <div class="actionTitle">ã™ãè¿½åŠ </div>
                  <div class="actionDesc">å†™çœŸï¼‹åå‰ã ã‘ã€‚ã‚ã¨ã§è©³ã—ãæ›¸ã‘ã‚‹ã€‚</div>
                </div>
              </div>
            </div>
            <div class="ctaRow">
              <button class="btn small" id="homeGoAdd3">å†™çœŸã§è¿½åŠ </button>
            </div>
          </div>

          <!-- ä¿å­˜ -->
          <div class="actionCard" id="homeBackup">
            <div class="actionTop">
              <div style="display:flex;gap:12px;align-items:flex-start">
                <div class="actionIcon">ğŸ’¾</div>
                <div>
                  <div class="actionTitle">å¼•ã£è¶Šã—ãƒ»ä¿å­˜</div>
                  <div class="actionDesc">ã‚¹ãƒãƒ›å¤‰æ›´ã‚„ä¸‡ãŒä¸€ã«å‚™ãˆã¦ä¿å­˜ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œã‚‹ã€‚</div>
                </div>
              </div>
            </div>
            <div class="ctaRow">
              <button class="btn small" id="homeGoBackup">ä¿å­˜ã¸</button>
            </div>
          </div>
        </div>

        <div class="hr"></div>

        <div class="card soft" style="padding:12px">
          <div style="font-weight:999">ã‚¿ã‚¹ã‚¯ä¸€è¦§</div>
          <div class="sub" style="margin-top:4px">æœŸé™ãŒè¿‘ã„ã‚‚ã®ã ã‘å‡ºã™ã€‚ãƒã‚§ãƒƒã‚¯ã§å®Œäº†ã§ãã‚‹ã€‚</div>
          <div class="hr"></div>
          <div id="taskList" style="display:grid;gap:10px"></div>
          <div class="sub" id="taskEmpty" style="display:none;margin-top:10px">ä»Šæ—¥ã‚„ã‚‹ã“ã¨ï¼šãªã—</div>
        </div>
      </section>

      <!-- PLANTS -->
      <section class="card" id="view-plants" style="display:none">
        <div class="row" style="justify-content:space-between;align-items:flex-end">
          <div>
            <h2 class="cardTitle">ğŸŒ¿ æ¤ç‰©</h2>
            <div class="sub">å†™çœŸã‚«ãƒ¼ãƒ‰ã§ä¸€è¦§ã€‚ã‚¿ãƒƒãƒ—ã§è©³ç´°ã€‚</div>
          </div>
          <button class="btn small" id="addFromPlants">â• è¿½åŠ </button>
        </div>
        <div class="hr"></div>

        <div class="plantGrid" id="plantGrid"></div>
        <div class="sub" id="plantEmpty" style="display:none;margin-top:10px">ã¾ã æ¤ç‰©ãŒã‚ã‚Šã¾ã›ã‚“ã€‚â•ã‹ã‚‰è¿½åŠ ã—ã¦ã­ã€‚</div>
      </section>

      <!-- ADD -->
      <section class="card" id="view-add" style="display:none">
        <h2 class="cardTitle">â• è¿½åŠ </h2>
        <div class="sub">å†™çœŸã¨åå‰ã ã‘ã§OKã€‚èª¬æ˜ã¯è‡ªå‹•ã§å…¥ã‚‹ï¼ˆç„¡æ–™ï¼‰ã€‚</div>

        <div class="hr"></div>

        <label>å†™çœŸï¼ˆã‚«ãƒ¡ãƒ©/ã‚¢ãƒ«ãƒãƒ ï¼‰</label>
        <input id="photoInput" type="file" accept="image/*" capture="environment" />
        <img id="photoPreview" class="modalImg" style="display:none;margin-top:10px" />

        <label style="margin-top:12px">åå‰</label>
        <input id="nameInput" placeholder="ä¾‹ï¼šãƒ¢ãƒ³ã‚¹ãƒ†ãƒ© / ã‚³ãƒ«ã‚¸ãƒªãƒ" />

        <label>ç½®ãå ´æ‰€ï¼ˆä»»æ„ï¼‰</label>
        <input id="locInput" placeholder="ä¾‹ï¼šãƒªãƒ“ãƒ³ã‚°çª“éš› / æ¸©å®¤" />

        <div class="row" style="margin-top:10px">
          <div style="flex:1">
            <label>æ°´ã‚„ã‚Šå‘¨æœŸï¼ˆæ—¥ï¼‰</label>
            <input id="waterEvery" type="number" min="0" value="7" />
          </div>
          <div style="flex:1">
            <label>è‚¥æ–™å‘¨æœŸï¼ˆæ—¥ï¼‰</label>
            <input id="fertEvery" type="number" min="0" value="30" />
          </div>
          <div style="flex:1">
            <label>å‰ªå®šå‘¨æœŸï¼ˆæ—¥ï¼‰</label>
            <input id="pruneEvery" type="number" min="0" value="90" />
          </div>
        </div>

        <label>ãƒ¡ãƒ¢ï¼ˆä»»æ„ï¼‰</label>
        <textarea id="memoInput" placeholder="ä¾‹ï¼šå†¬ã¯æ§ãˆã‚ã€‚è‘‰æ°´ã¯é€±2ã€‚"></textarea>

        <div class="row" style="margin-top:12px">
          <button class="btn" id="savePlant">âœ… è¿½åŠ ã™ã‚‹</button>
          <button class="btn ghost" id="resetAdd">ãƒªã‚»ãƒƒãƒˆ</button>
        </div>

        <div class="hr"></div>
        <div class="tiny">â€»å†™çœŸã¨ãƒ‡ãƒ¼ã‚¿ã¯ã“ã®ç«¯æœ«å†…ã«ä¿å­˜ï¼ˆã‚¯ãƒ©ã‚¦ãƒ‰é€ä¿¡ãªã—ï¼‰</div>
      </section>

      <!-- DIAG -->
      <section class="card" id="view-diag" style="display:none">
        <h2 class="cardTitle">ğŸ©º ãƒã‚§ãƒƒã‚¯</h2>
        <div class="sub">ç—‡çŠ¶ã‚’é¸ã¶ã ã‘ã§åŸå› å€™è£œã¨å¯¾å‡¦ï¼ˆä»Šã¯ãƒ«ãƒ¼ãƒ«å¼ï¼‰ã€‚</div>

        <div class="hr"></div>

        <label>å†™çœŸï¼ˆä»»æ„ï¼‰</label>
        <input id="diagPhotoInput" type="file" accept="image/*" capture="environment" />
        <img id="diagPreview" class="modalImg" style="display:none;margin-top:10px" />

        <label style="margin-top:12px">æ¤ç‰©ï¼ˆä»»æ„ï¼‰</label>
        <select id="diagPlantSelect"></select>

        <label style="margin-top:12px">ç—‡çŠ¶ï¼ˆå½“ã¦ã¯ã¾ã‚‹ã‚‚ã®ï¼‰</label>
        <div class="row">
          <label style="flex:1"><input type="checkbox" class="sym" value="yellow"> è‘‰ãŒé»„ã°ã‚€</label>
          <label style="flex:1"><input type="checkbox" class="sym" value="spots"> æ–‘ç‚¹/ã‚·ãƒŸ</label>
          <label style="flex:1"><input type="checkbox" class="sym" value="wilting"> ã—ãŠã‚Œã‚‹</label>
        </div>
        <div class="row">
          <label style="flex:1"><input type="checkbox" class="sym" value="bugs"> è™«/ãƒ™ã‚¿ã¤ã</label>
          <label style="flex:1"><input type="checkbox" class="sym" value="mold"> ã‚«ãƒ“/ç™½ã„ç²‰</label>
          <label style="flex:1"><input type="checkbox" class="sym" value="brown"> èŒ¶è‰²ãæ¯ã‚Œã‚‹</label>
        </div>

        <label style="margin-top:12px">çŠ¶æ³</label>
        <div class="row">
          <div style="flex:1">
            <label style="margin-top:0">ç›´è¿‘ã§æ°´ã‚„ã‚Šå¤šã‚ï¼Ÿ</label>
            <select id="ctxWater">
              <option value="unknown">ã‚ã‹ã‚‰ãªã„</option>
              <option value="more">å¤šã‚</option>
              <option value="less">å°‘ãªã‚</option>
            </select>
          </div>
          <div style="flex:1">
            <label style="margin-top:0">æ—¥å½“ãŸã‚Š</label>
            <select id="ctxLight">
              <option value="unknown">ã‚ã‹ã‚‰ãªã„</option>
              <option value="strong">å¼·ã„</option>
              <option value="weak">å¼±ã„</option>
            </select>
          </div>
          <div style="flex:1">
            <label style="margin-top:0">é¢¨é€šã—</label>
            <select id="ctxAir">
              <option value="unknown">ã‚ã‹ã‚‰ãªã„</option>
              <option value="good">è‰¯ã„</option>
              <option value="bad">æ‚ªã„</option>
            </select>
          </div>
        </div>

        <div class="row" style="margin-top:12px">
          <button class="btn" id="runDiag">ğŸ©º åˆ¤å®šã™ã‚‹</button>
          <button class="btn ghost" id="resetDiag">ãƒªã‚»ãƒƒãƒˆ</button>
        </div>

        <div class="hr"></div>
        <div id="diagResult" class="sub">ç—‡çŠ¶ã‚’é¸ã‚“ã§ã€Œåˆ¤å®šã™ã‚‹ã€ã‚’æŠ¼ã—ã¦ã€‚</div>
      </section>

      <!-- BACKUP -->
      <section class="card" id="view-backup" style="display:none">
        <h2 class="cardTitle">ğŸ’¾ å¼•ã£è¶Šã—ãƒ»ä¿å­˜</h2>
        <div class="sub">
          ã‚¹ãƒãƒ›ã‚’å¤‰ãˆã‚‹æ™‚ãƒ»æ¶ˆã—ãŸããªã„æ™‚ã«ä½¿ã†ã€‚<br>
          â€»ãµã ã‚“ã¯è‡ªå‹•ã§ç«¯æœ«ã«ä¿å­˜ã•ã‚Œã¦ã„ã¾ã™ã€‚
        </div>

        <div class="hr"></div>

        <div class="card soft">
          <h3 style="margin:0 0 6px">â‘  ä¿å­˜ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œã‚‹ï¼ˆãŠã™ã™ã‚ï¼‰</h3>
          <div class="sub">ã€Œãƒ•ã‚¡ã‚¤ãƒ«ã€ã‚¢ãƒ—ãƒªã‚„iCloudã«ä¿å­˜ã—ã¦ãŠã‘ã°å®‰å¿ƒã€‚</div>
          <div class="row" style="margin-top:10px">
            <button class="btn" id="exportBtn">â¬‡ï¸ ä¿å­˜ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œã‚‹</button>
          </div>
          <div class="tiny" style="margin-top:10px">
            ä¿å­˜ã—ãŸå ´æ‰€ãŒåˆ†ã‹ã‚‰ãªã„æ™‚ï¼šiPhoneã®ã€Œãƒ•ã‚¡ã‚¤ãƒ«ã€â†’ã€Œæœ€è¿‘ä½¿ã£ãŸé …ç›®ã€ã‚’è¦‹ã¦ã€‚
          </div>
        </div>

        <div class="hr"></div>

        <div class="card soft">
          <h3 style="margin:0 0 6px">â‘¡ ä¿å­˜ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰æˆ»ã™ï¼ˆå¾©å…ƒï¼‰</h3>
          <div class="sub">ä¿å­˜ã—ã¦ãŠã„ãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸ã‚“ã§æˆ»ã™ã€‚</div>
          <input id="importInput" type="file" accept="application/json" style="margin-top:10px" />
          <div class="row" style="margin-top:10px">
            <button class="btn" id="importBtn">â¬†ï¸ æˆ»ã™ï¼ˆå¾©å…ƒï¼‰</button>
          </div>
        </div>

        <div class="hr"></div>

        <div class="card soft">
          <h3 style="margin:0 0 6px">â‘¢ å…¨éƒ¨æ¶ˆã™ï¼ˆæœ€çµ‚æ‰‹æ®µï¼‰</h3>
          <div class="sub">æˆ»ã›ãªã„ã€‚å…ˆã«â‘ ã‚’ãŠã™ã™ã‚ã€‚</div>
          <div class="row" style="margin-top:10px">
            <button class="btn danger" id="wipeBtn">ğŸ§¨ å…¨ãƒ‡ãƒ¼ã‚¿ã‚’æ¶ˆã™</button>
          </div>
        </div>

        <div class="hr"></div>
        <div class="tiny">ä¿å­˜å ´æ‰€ï¼šã“ã®ç«¯æœ«ã®ä¸­ï¼ˆlocalStorageï¼‰</div>
      </section>
    </main>
  </div>

  <!-- Modal -->
  <div class="modalBack" id="modalBack">
    <div class="modal">
      <div class="modalHeader">
        <strong id="modalTitle">è©³ç´°</strong>
        <button class="x" id="closeModal">é–‰ã˜ã‚‹</button>
      </div>
      <div class="modalBody" id="modalBody"></div>
    </div>
  </div>

  <!-- Bottom nav -->
  <nav class="bottomNav" aria-label="Bottom Navigation">
    <button class="navBtn active" data-tab="home" id="nav-home"><div class="ico">ğŸ </div><div style="font-size:11px">ãƒ›ãƒ¼ãƒ </div></button>
    <button class="navBtn" data-tab="plants" id="nav-plants"><div class="ico">ğŸŒ¿</div><div style="font-size:11px">æ¤ç‰©</div></button>
    <div class="navMid"><button type="button" id="nav-add">ï¼‹</button></div>
    <button class="navBtn" data-tab="diag" id="nav-diag"><div class="ico">ğŸ©º</div><div style="font-size:11px">ãƒã‚§ãƒƒã‚¯</div></button>
    <button class="navBtn" data-tab="backup" id="nav-backup"><div class="ico">ğŸ’¾</div><div style="font-size:11px">ä¿å­˜</div></button>
  </nav>

  <script>
    /* =========================
      State
    ========================= */
    const LS_KEY = "plantlog_universal_v1";
    const THEME_KEY = "plantlog_theme";
    const $ = (id) => document.getElementById(id);
    const views = ["home","plants","add","diag","backup"];

    function nowISO(){ return new Date().toISOString(); }
    function clampInt(n, def=0){ n = parseInt(n,10); return Number.isFinite(n) ? n : def; }
    function escapeHtml(s=""){
      return String(s).replace(/[&<>"']/g, m => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
      }[m]));
    }
    function toDateOnly(d){ const x = new Date(d); x.setHours(0,0,0,0); return x; }
    function addDays(date, days){ const d=new Date(date); d.setDate(d.getDate()+days); return d; }
    function fmtDate(d){
      const x=new Date(d);
      return `${x.getFullYear()}-${String(x.getMonth()+1).padStart(2,"0")}-${String(x.getDate()).padStart(2,"0")}`;
    }
    function fileToDataUrl(file){
      return new Promise((resolve,reject)=>{
        const r = new FileReader();
        r.onload = ()=> resolve(r.result);
        r.onerror = reject;
        r.readAsDataURL(file);
      });
    }
    function newId(){
      return "p_" + Math.random().toString(36).slice(2,10) + "_" + Date.now().toString(36);
    }

    function loadState(){
      const raw = localStorage.getItem(LS_KEY);
      if(!raw) return { plants: [] };
      try{
        const st = JSON.parse(raw);
        if(!st || !Array.isArray(st.plants)) return { plants: [] };
        return st;
      }catch{ return { plants: [] }; }
    }
    function saveState(st){
      localStorage.setItem(LS_KEY, JSON.stringify(st));
      $("statusPill").textContent = "ä¿å­˜: ç«¯æœ«ã®ä¸­ âœ“";
      setTimeout(()=> $("statusPill").textContent = "ä¿å­˜: ç«¯æœ«ã®ä¸­", 800);
    }
    let state = loadState();

    /* =========================
      Theme toggle
    ========================= */
    function applyTheme(t){
      document.documentElement.setAttribute("data-theme", t);
      localStorage.setItem(THEME_KEY, t);
      const btn = $("themeBtn");
      if(btn) btn.textContent = (t==="dark") ? "â˜€ï¸ ãƒ™ãƒ¼ã‚¸ãƒ¥" : "ğŸŒ™ ãƒ€ãƒ¼ã‚¯";
      // theme-color ã‚‚å¤‰ãˆã‚‹ï¼ˆiPhoneä¸Šéƒ¨ã®è‰²ï¼‰
      const meta = document.querySelector('meta[name="theme-color"]');
      if(meta) meta.setAttribute("content", (t==="dark") ? "#070b10" : "#f4efe6");
    }
    applyTheme(localStorage.getItem(THEME_KEY) || "light");
    $("themeBtn").addEventListener("click", ()=>{
      const cur = document.documentElement.getAttribute("data-theme") || "light";
      applyTheme(cur==="dark" ? "light" : "dark");
    });

    /* =========================
      Tabs
    ========================= */
    function showTab(tab){
      views.forEach(v=>{
        const el = $("view-"+v);
        if(el) el.style.display = (v===tab) ? "" : "none";
      });

      document.querySelectorAll(".tab").forEach(el=>{
        el.classList.toggle("active", el.dataset.tab === tab);
      });
      document.querySelectorAll(".navBtn").forEach(el=>{
        el.classList.toggle("active", el.dataset.tab === tab);
      });

      if(tab==="plants") renderPlants();
      if(tab==="home") renderHome();
      if(tab==="diag") refreshDiagSelect();
    }

    $("tabs").addEventListener("click",(e)=>{
      const t = e.target.closest(".tab");
      if(!t) return;
      showTab(t.dataset.tab);
    });
    document.querySelectorAll(".navBtn").forEach(btn=>{
      btn.addEventListener("click", ()=> showTab(btn.dataset.tab));
    });
    $("nav-add").addEventListener("click", ()=> showTab("add");

    /* =========================
      Bottom nav auto-hide on scroll
    ========================= */
    let lastY = window.scrollY;
    const nav = document.querySelector(".bottomNav");
    window.addEventListener("scroll", () => {
      const y = window.scrollY;
      const goingDown = y > lastY;
      if (goingDown && y > 20) nav.classList.add("hide");
      else nav.classList.remove("hide");
      lastY = y;
    }, { passive:true });

    /* =========================
      Home actions
    ========================= */
    $("homeGoAdd").onclick = ()=> showTab("add");
    $("homeGoAdd2").onclick = ()=> showTab("add");
    $("homeGoAdd3").onclick = ()=> showTab("add");
    $("homeGoPlants").onclick = ()=> showTab("plants");
    $("homeGoDiag").onclick = ()=> showTab("diag");
    $("homeGoBackup").onclick = ()=> showTab("backup");
    $("addFromPlants").onclick = ()=> showTab("add");

    /* =========================
      Wikipedia summaryï¼ˆç„¡æ–™ï¼‰
    ========================= */
    async function fetchWikiSummary(title, lang="ja"){
      const url = `https://${lang}.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(title)}`;
      try{
        const res = await fetch(url, { headers: { accept: "application/json" } });
        if(!res.ok) return null;
        const data = await res.json();
        if(!data.extract || data.type === "disambiguation") return null;
        return {
          source:`wikipedia:${lang}`,
          title: data.title || title,
          extract: data.extract,
          thumbnail: data.thumbnail?.source || "",
          pageUrl: data.content_urls?.desktop?.page || ""
        };
      }catch{ return null; }
    }
    async function getAutoDescription(name){
      let info = await fetchWikiSummary(name,"ja");
      if(!info) info = await fetchWikiSummary(name,"en");
      return info;
    }

    /* =========================
      ADD
    ========================= */
    $("photoInput").addEventListener("change", async ()=>{
      const f = $("photoInput").files?.[0];
      if(!f) return;
      const dataUrl = await fileToDataUrl(f);
      $("photoPreview").src = dataUrl;
      $("photoPreview").style.display = "";
    });

    $("resetAdd").onclick = ()=>{
      $("photoInput").value = "";
      $("photoPreview").style.display = "none";
      $("nameInput").value = "";
      $("locInput").value = "";
      $("waterEvery").value = "7";
      $("fertEvery").value = "30";
      $("pruneEvery").value = "90";
      $("memoInput").value = "";
    };

    $("savePlant").onclick = async ()=>{
      const name = $("nameInput").value.trim();
      if(!name){ alert("åå‰ã‚’å…¥ã‚Œã¦ã€‚"); return; }

      const btn = $("savePlant");
      const prev = btn.textContent;
      btn.textContent = "â³ è‡ªå‹•èª¬æ˜ã‚’å–å¾—ä¸­â€¦";
      btn.disabled = true;

      const location = $("locInput").value.trim();
      const memo = $("memoInput").value.trim();
      const waterEvery = clampInt($("waterEvery").value, 0);
      const fertEvery  = clampInt($("fertEvery").value, 0);
      const pruneEvery = clampInt($("pruneEvery").value, 0);

      let photoDataUrl = "";
      const f = $("photoInput").files?.[0];
      if(f){ try{ photoDataUrl = await fileToDataUrl(f); }catch{} }

      const auto = await getAutoDescription(name);

      const plant = {
        id: newId(),
        name,
        location,
        memo,
        photoDataUrl,
        waterEvery, fertEvery, pruneEvery,
        createdAt: nowISO(),
        lastWaterAt: nowISO(),
        lastFertAt: nowISO(),
        lastPruneAt: nowISO(),
        autoDesc: auto?.extract || "",
        autoSource: auto?.source || "",
        autoTitle: auto?.title || "",
        autoThumb: auto?.thumbnail || "",
        autoUrl: auto?.pageUrl || ""
      };

      state.plants.unshift(plant);
      saveState(state);

      btn.textContent = prev;
      btn.disabled = false;

      $("resetAdd").click();
      showTab("plants");
    };

    /* =========================
      PLANTS
    ========================= */
    function oneLineDesc(p){
      const s = (p.autoDesc||"").replace(/\s+/g," ").trim();
      if(!s) return "";
      return s.length>52 ? s.slice(0,52)+"â€¦" : s;
    }

    function renderPlants(){
      const grid = $("plantGrid");
      grid.innerHTML = "";

      if(state.plants.length===0){
        $("plantEmpty").style.display = "";
        return;
      }
      $("plantEmpty").style.display = "none";

      for(const p of state.plants){
        const card = document.createElement("div");
        card.className = "plantCard";

        const badgeText = p.location ? escapeHtml(p.location) : "ç™»éŒ²æ¸ˆ";
        const thumbUrl = p.photoDataUrl || p.autoThumb || "";
        const desc = oneLineDesc(p);

        card.innerHTML = `
          <div class="thumb">
            ${thumbUrl ? `<img src="${thumbUrl}" alt="">` : ""}
            <div class="badge">${badgeText}</div>
          </div>
          <div class="plantBody">
            <h3 class="plantName">${escapeHtml(p.name)}</h3>
            <div class="plantMeta">${desc ? escapeHtml(desc) : "èª¬æ˜ï¼šæœªå–å¾—ï¼ˆåˆ¥å/å­¦åã§å–ã‚Œã‚‹ã“ã¨ã‚ã‚Šï¼‰"}</div>
          </div>
        `;
        card.onclick = ()=> openPlantModal(p.id);
        grid.appendChild(card);
      }

      refreshDiagSelect();
      renderHome();
    }

    /* =========================
      MODAL
    ========================= */
    function closeModal(){ $("modalBack").style.display="none"; }
    $("closeModal").onclick = closeModal;
    $("modalBack").addEventListener("click",(e)=>{ if(e.target.id==="modalBack") closeModal(); });

    function updatePlant(id, patch){
      const idx = state.plants.findIndex(x=>x.id===id);
      if(idx<0) return;
      state.plants[idx] = { ...state.plants[idx], ...patch };
      saveState(state);
      renderPlants();
    }

    function openPlantModal(id){
      const p = state.plants.find(x=>x.id===id);
      if(!p) return;

      $("modalTitle").textContent = `è©³ç´°ï¼š${p.name}`;
      const imgUrl = p.photoDataUrl || p.autoThumb || "";

      const autoBlock = p.autoDesc ? `
        <div class="hr"></div>
        <div class="sub"><b>èª¬æ˜ï¼ˆè‡ªå‹•ï¼‰</b><br>${escapeHtml(p.autoDesc)}</div>
        <div class="sub" style="margin-top:8px">
          å‡ºå…¸ï¼š${p.autoUrl ? `<a href="${p.autoUrl}" target="_blank" rel="noreferrer">Wikipedia</a>` : escapeHtml(p.autoSource||"")}
        </div>
      ` : `
        <div class="hr"></div>
        <div class="sub">èª¬æ˜ãŒå–ã‚Œãªã‹ã£ãŸã€‚åˆ¥å/å­¦åã§è©¦ã™ã¨å–ã‚Œã‚‹ã“ã¨ãŒã‚ã‚‹ã€‚</div>
      `;

      $("modalBody").innerHTML = `
        ${imgUrl ? `<img class="modalImg" src="${imgUrl}" alt="">` : ""}
        <div class="hr"></div>

        <div class="row">
          <div style="flex:1">
            <div class="sub"><b>ç½®ãå ´æ‰€</b><br>${escapeHtml(p.location||"â€”")}</div>
          </div>
          <div style="flex:1">
            <div class="sub"><b>ãƒ¡ãƒ¢</b><br>${escapeHtml(p.memo||"â€”")}</div>
          </div>
        </div>

        <div class="hr"></div>

        <div class="row">
          <button class="btn small" id="markWater">ğŸ’§ æ°´ã‚„ã‚Š</button>
          <button class="btn ghost small" id="markFert">ğŸ§ª è‚¥æ–™</button>
          <button class="btn ghost small" id="markPrune">âœ‚ï¸ å‰ªå®š</button>
        </div>

        <div class="hr"></div>

        <div class="sub">
          <b>å‘¨æœŸ</b><br>
          ğŸ’§ ${p.waterEvery||0}æ—¥ / ğŸ§ª ${p.fertEvery||0}æ—¥ / âœ‚ï¸ ${p.pruneEvery||0}æ—¥
        </div>
        <div class="sub" style="margin-top:6px">
          <b>æœ€çµ‚</b><br>
          ğŸ’§ ${fmtDate(p.lastWaterAt)} / ğŸ§ª ${fmtDate(p.lastFertAt)} / âœ‚ï¸ ${fmtDate(p.lastPruneAt)}
        </div>

        ${autoBlock}

        <div class="hr"></div>
        <div class="row" style="justify-content:space-between">
          <button class="btn danger small" id="deletePlant">ğŸ§¨ å‰Šé™¤</button>
          <button class="btn ghost small" id="closePlant">é–‰ã˜ã‚‹</button>
        </div>
      `;

      $("modalBack").style.display="flex";

      document.getElementById("closePlant").onclick = closeModal;
      document.getElementById("markWater").onclick = ()=>{ updatePlant(id,{lastWaterAt:nowISO()}); openPlantModal(id); renderHome(); };
      document.getElementById("markFert").onclick  = ()=>{ updatePlant(id,{lastFertAt:nowISO()}); openPlantModal(id); renderHome(); };
      document.getElementById("markPrune").onclick = ()=>{ updatePlant(id,{lastPruneAt:nowISO()}); openPlantModal(id); renderHome(); };
      document.getElementById("deletePlant").onclick = ()=>{
        if(!confirm("ã“ã®æ¤ç‰©ã‚’å‰Šé™¤ã™ã‚‹ï¼Ÿï¼ˆæˆ»ã›ãªã„ï¼‰")) return;
        state.plants = state.plants.filter(x=>x.id!==id);
        saveState(state);
        closeModal();
        renderPlants();
      };
    }

    /* =========================
      HOME tasks
    ========================= */
    function computeDueTasks(daysWindow){
      const today = toDateOnly(new Date());
      const until = addDays(today, daysWindow);

      const tasks=[];
      for(const p of state.plants){
        const items=[
          {kind:"water", label:"ğŸ’§ æ°´ã‚„ã‚Š", every:p.waterEvery||0, last:p.lastWaterAt},
          {kind:"fert",  label:"ğŸ§ª è‚¥æ–™",   every:p.fertEvery||0,  last:p.lastFertAt},
          {kind:"prune", label:"âœ‚ï¸ å‰ªå®š",   every:p.pruneEvery||0, last:p.lastPruneAt},
        ];
        for(const it of items){
          if(!it.every || it.every<=0) continue;
          const due = addDays(toDateOnly(it.last || p.createdAt), it.every);
          if(due>=today && due<=until){
            tasks.push({
              id:`${p.id}:${it.kind}:${fmtDate(due)}`,
              plantId:p.id,
              plantName:p.name,
              kind:it.kind,
              label:it.label,
              due
            });
          }
        }
      }
      tasks.sort((a,b)=>a.due-b.due);
      return tasks;
    }

    function renderHome(){
      $("countPill").textContent = String(state.plants.length);

      const days = clampInt($("daysWindow").value, 3);
      const tasks = computeDueTasks(days);
      $("duePill").textContent = String(tasks.length);

      const list = $("taskList");
      list.innerHTML = "";

      if(tasks.length===0){
        $("taskEmpty").style.display="";
        return;
      }
      $("taskEmpty").style.display="none";

      for(const t of tasks){
        const el = document.createElement("div");
        el.className="card soft";
        el.style.padding="12px";
        el.innerHTML = `
          <div style="display:flex;gap:12px;align-items:center;justify-content:space-between">
            <div>
              <div style="font-weight:999">${escapeHtml(t.plantName)} ã« ${escapeHtml(t.label)}</div>
              <div class="tiny" style="margin-top:4px">æœŸé™ï¼š${fmtDate(t.due)}</div>
            </div>
            <div class="row">
              <button class="btn ghost small" data-act="detail">è©³ç´°</button>
              <button class="btn small" data-act="done">å®Œäº†</button>
            </div>
          </div>
        `;
        el.querySelector('[data-act="detail"]').onclick = ()=> openPlantModal(t.plantId);
        el.querySelector('[data-act="done"]').onclick = ()=>{
          if(t.kind==="water") updatePlant(t.plantId,{lastWaterAt:nowISO()});
          if(t.kind==="fert")  updatePlant(t.plantId,{lastFertAt:nowISO()});
          if(t.kind==="prune") updatePlant(t.plantId,{lastPruneAt:nowISO()});
          renderHome();
        };
        list.appendChild(el);
      }
    }
    $("daysWindow").addEventListener("change", renderHome);

    /* =========================
      DIAG
    ========================= */
    function refreshDiagSelect(){
      const sel = $("diagPlantSelect");
      sel.innerHTML = `<option value="">ï¼ˆé¸ã°ãªã„ï¼‰</option>`;
      for(const p of state.plants){
        const opt = document.createElement("option");
        opt.value = p.id;
        opt.textContent = p.name;
        sel.appendChild(opt);
      }
    }

    $("diagPhotoInput").addEventListener("change", async ()=>{
      const f = $("diagPhotoInput").files?.[0];
      if(!f) return;
      const dataUrl = await fileToDataUrl(f);
      $("diagPreview").src = dataUrl;
      $("diagPreview").style.display = "";
    });

    function diagRule(sym, ctx){
      const score = new Map();
      const add=(k,v)=>score.set(k,(score.get(k)||0)+v);

      if(sym.includes("yellow")){
        add("æ°´ã®ã‚„ã‚Šã™ãï¼ˆæ ¹è…ã‚Œï¼‰",2);
        add("è‚¥æ–™ä¸è¶³/çª’ç´ ä¸è¶³",1);
        add("å¯’ã•/æ¸©åº¦ã‚¹ãƒˆãƒ¬ã‚¹",1);
      }
      if(sym.includes("spots")){
        add("è‘‰ç„¼ã‘ï¼ˆå¼·å…‰ï¼‰",2);
        add("ç—…æ°—ï¼ˆã‚«ãƒ“/ç´°èŒï¼‰",2);
        add("æ°´æ»´ï¼‹æ—¥å…‰ï¼ˆãƒ¬ãƒ³ã‚ºç„¼ã‘ï¼‰",1);
      }
      if(sym.includes("wilting")){
        add("æ°´åˆ‡ã‚Œ",2);
        add("æ ¹è…ã‚Œï¼ˆå¸ãˆãªã„ï¼‰",2);
        add("é«˜æ¸©/ä¹¾ç‡¥ã‚¹ãƒˆãƒ¬ã‚¹",1);
      }
      if(sym.includes("bugs")){
        add("ãƒãƒ€ãƒ‹/ã‚¢ãƒ–ãƒ©ãƒ ã‚·ç­‰ã®å®³è™«",3);
        add("é¢¨é€šã—ä¸è¶³",1);
      }
      if(sym.includes("mold")){
        add("é¢¨é€šã—ä¸è¶³ï¼ˆã‚«ãƒ“ï¼‰",3);
        add("éæ¹¿",2);
      }
      if(sym.includes("brown")){
        add("æ°´åˆ‡ã‚Œ/ä¹¾ç‡¥",2);
        add("è‘‰ç„¼ã‘/ç›´å°„",2);
        add("è‚¥æ–™æ¿ƒåº¦ãŒå¼·ã„",1);
      }

      if(ctx.water==="more") add("æ°´ã®ã‚„ã‚Šã™ãï¼ˆæ ¹è…ã‚Œï¼‰",2);
      if(ctx.water==="less") add("æ°´åˆ‡ã‚Œ",2);
      if(ctx.light==="strong") add("è‘‰ç„¼ã‘ï¼ˆå¼·å…‰ï¼‰",2);
      if(ctx.light==="weak") add("æ—¥ç…§ä¸è¶³",2);
      if(ctx.air==="bad") add("é¢¨é€šã—ä¸è¶³ï¼ˆã‚«ãƒ“ï¼‰",2);

      const ranked=[...score.entries()].sort((a,b)=>b[1]-a[1]).slice(0,3);
      const tips=[
        "ãƒ»åœŸãŒæ¹¿ã‚Šã£ã±ãªã—ãªã‚‰ï¼šä¹¾ã‹ã—æ°—å‘³ï¼‹é‰¢åº•/æ ¹ã‚’ç¢ºèª",
        "ãƒ»è‘‰ç„¼ã‘ç–‘ã„ï¼šé®å…‰ï¼ˆãƒ¬ãƒ¼ã‚¹è¶Šã—ï¼‰ï¼‹è‘‰æ°´ã¯æœã€œå¤•",
        "ãƒ»å®³è™«ç–‘ã„ï¼šè‘‰è£ãƒã‚§ãƒƒã‚¯â†’ã‚·ãƒ£ãƒ¯ãƒ¼â†’å¿…è¦ãªã‚‰è–¬å‰¤",
        "ãƒ»ã‚«ãƒ“ç–‘ã„ï¼šé¢¨é€šã—æ”¹å–„ï¼‹åœŸè¡¨é¢ã‚’ä¹¾ã‹ã™"
      ];
      return {ranked,tips};
    }

    $("runDiag").onclick = ()=>{
      const sym=[...document.querySelectorAll(".sym:checked")].map(x=>x.value);
      const ctx={ water:$("ctxWater").value, light:$("ctxLight").value, air:$("ctxAir").value };

      const plantId = $("diagPlantSelect").value;
      const plant = plantId ? state.plants.find(p=>p.id===plantId) : null;

      if(sym.length===0 && !plant){
        $("diagResult").textContent = "ç—‡çŠ¶ãƒã‚§ãƒƒã‚¯ã‚’å…¥ã‚Œã‚‹ã‹ã€æ¤ç‰©ã‚’é¸ã‚“ã§ã€‚";
        return;
      }

      const r = diagRule(sym, ctx);
      const top = r.ranked.length
        ? r.ranked.map(([k,v],i)=>`<div class="sub"><b>TOP${i+1}</b>ï¼š${escapeHtml(k)}ï¼ˆ${v}ï¼‰</div>`).join("")
        : `<div class="sub">æƒ…å ±ãŒå°‘ãªãã¦ç‰¹å®šã§ããªã„ã€‚ç—‡çŠ¶ãƒã‚§ãƒƒã‚¯ã‚’å¢—ã‚„ã—ã¦ã€‚</div>`;

      $("diagResult").innerHTML = `
        ${plant ? `<div class="sub">å¯¾è±¡ï¼š<b>${escapeHtml(plant.name)}</b></div>` : ""}
        <div class="hr"></div>
        ${top}
        <div class="hr"></div>
        <div class="sub"><b>ã¾ãšã®å¯¾å‡¦ï¼ˆå®‰å…¨å´ï¼‰</b><br>${r.tips.map(t=>escapeHtml(t)).join("<br>")}</div>
      `;
    };

    $("resetDiag").onclick = ()=>{
      document.querySelectorAll(".sym").forEach(x=>x.checked=false);
      $("ctxWater").value="unknown";
      $("ctxLight").value="unknown";
      $("ctxAir").value="unknown";
      $("diagPlantSelect").value="";
      $("diagPhotoInput").value="";
      $("diagPreview").style.display="none";
      $("diagResult").textContent="ç—‡çŠ¶ã‚’é¸ã‚“ã§ã€Œåˆ¤å®šã™ã‚‹ã€ã‚’æŠ¼ã—ã¦ã€‚";
    };

    /* =========================
      Backup
    ========================= */
    function downloadText(filename, text, mime="application/json"){
      const blob = new Blob([text], { type:mime });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href=url; a.download=filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    $("exportBtn").onclick = ()=>{
      downloadText(`PlantLog_ä¿å­˜ãƒ•ã‚¡ã‚¤ãƒ«_${fmtDate(new Date())}.json`, JSON.stringify(state,null,2), "application/json");
      alert("ä¿å­˜ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œã£ãŸã‚ˆã€‚ã€ãƒ•ã‚¡ã‚¤ãƒ«ã€ã‚¢ãƒ—ãƒªã«ä¿å­˜ã—ã¦ã­ã€‚");
    };

    $("importBtn").onclick = async ()=>{
      const f = $("importInput").files?.[0];
      if(!f){ alert("ä¿å­˜ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸ã‚“ã§ã­ã€‚"); return; }
      try{
        const obj = JSON.parse(await f.text());
        if(!obj || !Array.isArray(obj.plants)) throw new Error("format");
        state = obj;
        saveState(state);
        alert("å¾©å…ƒã§ããŸã‚ˆã€‚");
        renderPlants();
        showTab("home");
      }catch{
        alert("ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯PlantLogã®ä¿å­˜ãƒ•ã‚¡ã‚¤ãƒ«ã˜ã‚ƒãªã„ã‹ã‚‚ã€‚åˆ¥ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸ã‚“ã§ã­ã€‚");
      }
    };

    $("wipeBtn").onclick = ()=>{
      if(!confirm("æœ¬å½“ã«å…¨éƒ¨æ¶ˆã™ï¼Ÿï¼ˆæˆ»ã›ãªã„ï¼‰\nå…ˆã«ã€ä¿å­˜ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œã‚‹ã€ãŒãŠã™ã™ã‚ï¼")) return;
      state = { plants: [] };
      saveState(state);
      renderPlants();
      renderHome();
      alert("å…¨ãƒ‡ãƒ¼ã‚¿ã‚’æ¶ˆã—ãŸã‚ˆã€‚");
    };

    /* =========================
      Init
    ========================= */
    renderPlants();
    renderHome();
    refreshDiagSelect();
    showTab("home");
  </script>
</body>
</html>
