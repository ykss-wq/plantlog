<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>PlantLogï¼ˆè‡ªåˆ†ç”¨ï¼‰</title>
  <meta name="theme-color" content="#0b0f14" />

  <style>
    :root{
      --bg:#070b10;
      --card:#0f1722cc;
      --card2:#0c1320cc;
      --line:#1a2a3e;
      --text:#e9eef6;
      --muted:#9bb0c6;
      --accent:#26e39b;
      --accent2:#2bd3ff;
      --warn:#ffcc66;
      --danger:#ff6b6b;
      --ok:#34d399;
      --shadow: 0 18px 50px rgba(0,0,0,.45);
      --radius:18px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,"Hiragino Kaku Gothic ProN","Noto Sans JP","Yu Gothic",sans-serif;
      color:var(--text);
      background:
        radial-gradient(1100px 600px at 20% -10%, rgba(38,227,155,.18), transparent 55%),
        radial-gradient(900px 500px at 90% 10%, rgba(43,211,255,.16), transparent 55%),
        radial-gradient(900px 600px at 50% 110%, rgba(135,120,255,.12), transparent 55%),
        linear-gradient(180deg, #060a10 0%, #070b10 100%);
      padding: env(safe-area-inset-top) 14px calc(env(safe-area-inset-bottom) + 18px);
    }
    header{
      position:sticky; top:0;
      padding: 10px 0 12px;
      backdrop-filter: blur(14px);
      background: linear-gradient(180deg, rgba(7,11,16,.85), rgba(7,11,16,.35));
      border-bottom:1px solid rgba(255,255,255,.06);
      z-index:10;
    }
    .brand{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      margin:0 2px 10px;
    }
    .brand h1{
      margin:0;
      font-size:18px;
      letter-spacing:.2px;
      display:flex;align-items:center;gap:10px;
    }
    .pill{
      font-size:12px;color:var(--muted);
      padding:6px 10px;border:1px solid rgba(255,255,255,.10);
      border-radius:999px;background:rgba(15,23,34,.55);
    }
    .tabs{display:flex;gap:8px;flex-wrap:wrap}
    .tab{
      border:1px solid rgba(255,255,255,.10);
      background:rgba(15,23,34,.45);
      color:var(--text);
      padding:10px 12px;
      border-radius:999px;
      font-size:13px;
      display:flex;align-items:center;gap:8px;
      cursor:pointer;
      user-select:none;
    }
    .tab.active{
      border-color: rgba(38,227,155,.55);
      background: linear-gradient(90deg, rgba(38,227,155,.22), rgba(43,211,255,.14));
      box-shadow: 0 10px 30px rgba(38,227,155,.10);
    }

    .wrap{max-width:980px;margin:0 auto}
    .grid{display:grid;gap:12px}
    .card{
      border:1px solid rgba(255,255,255,.08);
      background: linear-gradient(180deg, rgba(15,23,34,.62), rgba(10,15,24,.62));
      border-radius: var(--radius);
      padding: 14px;
      box-shadow: var(--shadow);
    }
    .card h2{margin:0 0 6px;font-size:18px}
    .sub{color:var(--muted);font-size:13px;line-height:1.4}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .btn{
      border:none;
      color:#061012;
      background: linear-gradient(90deg, var(--accent), var(--accent2));
      padding:12px 14px;
      border-radius:12px;
      font-weight:700;
      cursor:pointer;
      box-shadow: 0 14px 35px rgba(38,227,155,.18);
    }
    .btn.ghost{
      background:transparent;color:var(--text);
      border:1px solid rgba(255,255,255,.12);
      box-shadow:none;
    }
    .btn.danger{
      background:linear-gradient(90deg, #ff6b6b, #ff9f6b);
      color:#130707;
    }
    .btn.small{padding:10px 12px;font-size:13px;border-radius:12px}
    input,select,textarea{
      width:100%;
      background: rgba(8,12,18,.55);
      border:1px solid rgba(255,255,255,.10);
      color:var(--text);
      border-radius: 12px;
      padding: 12px 12px;
      outline:none;
      font-size:14px;
    }
    textarea{min-height:90px;resize:vertical}
    label{font-size:12px;color:var(--muted);display:block;margin:10px 0 6px}
    .split{display:grid;grid-template-columns:1fr;gap:12px}
    @media(min-width:860px){ .split{grid-template-columns:1.25fr .75fr} }

    /* Hero camera */
    .hero{
      display:grid;
      grid-template-columns: 1fr;
      gap:12px;
    }
    .heroTop{
      display:flex;justify-content:space-between;gap:12px;align-items:center;flex-wrap:wrap;
    }
    .heroTitle{
      font-size:22px;margin:0;
      letter-spacing:.2px;
    }
    .heroCTA{
      display:flex;gap:10px;flex-wrap:wrap;
    }
    .bigCapture{
      display:flex;align-items:center;justify-content:center;
      height:120px;
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.10);
      background:
        radial-gradient(500px 200px at 30% 20%, rgba(38,227,155,.22), transparent 60%),
        radial-gradient(500px 220px at 80% 40%, rgba(43,211,255,.18), transparent 60%),
        rgba(15,23,34,.55);
      cursor:pointer;
      box-shadow: var(--shadow);
      position:relative;
      overflow:hidden;
    }
    .bigCapture strong{font-size:16px}
    .bigCapture span{display:block;color:var(--muted);font-size:12px;margin-top:6px;text-align:center}
    .bigCapture:after{
      content:"";
      position:absolute; inset:-60px;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,.10), transparent);
      transform: rotate(18deg);
      animation: shine 4.2s infinite;
    }
    @keyframes shine{
      0%{transform:translateX(-40%) rotate(18deg)}
      60%{transform:translateX(120%) rotate(18deg)}
      100%{transform:translateX(120%) rotate(18deg)}
    }

    /* Plant cards */
    .plantGrid{
      display:grid;
      gap:12px;
      grid-template-columns: repeat(2, minmax(0,1fr));
    }
    @media(min-width:860px){ .plantGrid{grid-template-columns: repeat(3, minmax(0,1fr));} }

    .plantCard{
      border:1px solid rgba(255,255,255,.08);
      border-radius: 18px;
      overflow:hidden;
      background: rgba(12,18,28,.6);
      box-shadow: var(--shadow);
      cursor:pointer;
    }
    .thumb{
      height:130px;
      background: linear-gradient(90deg, rgba(38,227,155,.15), rgba(43,211,255,.10));
      position:relative;
    }
    .thumb img{
      width:100%;height:100%;object-fit:cover;display:block;
      filter:saturate(1.05) contrast(1.04);
    }
    .thumb .badge{
      position:absolute;left:10px;top:10px;
      font-size:12px;color:#041012;
      background: linear-gradient(90deg, var(--accent), var(--accent2));
      padding:6px 10px;border-radius:999px;font-weight:800;
    }
    .plantBody{padding:12px}
    .plantName{margin:0;font-size:15px;line-height:1.2}
    .plantMeta{margin:6px 0 0;color:var(--muted);font-size:12px}
    .chips{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .chip{
      font-size:12px;color:var(--text);
      padding:6px 10px;border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(10,15,24,.45);
    }
    .chip.ok{border-color: rgba(52,211,153,.35); }
    .chip.warn{border-color: rgba(255,204,102,.35); }
    .chip.bad{border-color: rgba(255,107,107,.35); }

    /* Task list */
    .tasks{display:grid;gap:10px;margin-top:10px}
    .task{
      display:flex;gap:10px;align-items:flex-start;
      padding:12px;border-radius:14px;
      border:1px solid rgba(255,255,255,.08);
      background: rgba(10,15,24,.45);
    }
    .task input{width:auto;margin-top:2px}
    .taskTitle{font-weight:800}
    .taskSub{color:var(--muted);font-size:12px;margin-top:2px}

    /* Modal */
    .modalBack{
      position:fixed;inset:0;
      background: rgba(0,0,0,.55);
      display:none;
      align-items:flex-end;
      justify-content:center;
      padding: 18px;
      z-index:50;
    }
    .modal{
      width:min(720px, 100%);
      border-radius: 20px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(10,15,24,.92);
      backdrop-filter: blur(14px);
      box-shadow: 0 30px 80px rgba(0,0,0,.60);
      overflow:hidden;
    }
    .modalHeader{
      display:flex;justify-content:space-between;align-items:center;
      padding:14px 14px;border-bottom:1px solid rgba(255,255,255,.08);
    }
    .modalHeader strong{font-size:15px}
    .x{background:transparent;border:1px solid rgba(255,255,255,.14);color:var(--text);
      border-radius:12px;padding:8px 10px;cursor:pointer}
    .modalBody{padding:14px}
    .modalImg{width:100%;height:220px;border-radius:16px;object-fit:cover;border:1px solid rgba(255,255,255,.08)}
    .muted{color:var(--muted)}
    .hr{height:1px;background:rgba(255,255,255,.08);margin:12px 0}
    .tiny{font-size:12px;color:var(--muted)}
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <h1>ğŸŒ¿ PlantLog <span class="pill">è‡ªåˆ†ç”¨ / å†™çœŸã‚«ãƒ¼ãƒ‰</span></h1>
        <span class="pill" id="statusPill">ä¿å­˜: localStorage</span>
      </div>

      <div class="tabs" id="tabs">
        <div class="tab active" data-tab="today">ğŸ  ä»Šæ—¥</div>
        <div class="tab" data-tab="plants">ğŸŒ¿ æ¤ç‰©</div>
        <div class="tab" data-tab="add">â• è¿½åŠ </div>
        <div class="tab" data-tab="diag">ğŸ©º ç—…æ°—ãƒã‚§ãƒƒã‚¯ï¼ˆCï¼‰</div>
        <div class="tab" data-tab="backup">ğŸ’¾ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—</div>
      </div>
    </header>

    <main class="grid" style="margin-top:12px">
      <!-- TODAY -->
      <section class="card" id="view-today">
        <div class="hero">
          <div class="heroTop">
            <div>
              <h2 class="heroTitle">ä»Šæ—¥ã‚„ã‚‹ã“ã¨</h2>
              <div class="sub">ã€ŒæœŸé™ãƒ™ãƒ¼ã‚¹ã€ï¼‹ã€Œãƒã‚§ãƒƒã‚¯å¼ã€ã€‚å†™çœŸã§â€œè¨ºæ–­â€ã‚‚ã™ãã€‚</div>
            </div>
            <div class="heroCTA">
              <button class="btn small" id="goAdd">â• æ¤ç‰©ã‚’è¿½åŠ </button>
              <button class="btn small ghost" id="goPlants">ğŸŒ¿ ä¸€è¦§ã‚’è¦‹ã‚‹</button>
            </div>
          </div>

          <div class="bigCapture" id="quickDiag">
            <div style="text-align:center;position:relative;z-index:1">
              <strong>ğŸ“¸ å†™çœŸã§çŠ¶æ…‹ãƒã‚§ãƒƒã‚¯ï¼ˆã¾ãšã¯ãƒ¡ãƒ¢ï¼‹å€™è£œï¼‰</strong>
              <span>ã‚«ãƒ¡ãƒ© or å†™çœŸ â†’ ç—‡çŠ¶è³ªå• â†’ åŸå› å€™è£œã¨å¯¾å‡¦</span>
            </div>
          </div>

          <div class="card" style="padding:12px;background:rgba(12,18,28,.45);box-shadow:none">
            <div class="row" style="justify-content:space-between">
              <div class="row">
                <div class="pill" id="countPill">ç™»éŒ² 0</div>
                <div class="pill" id="duePill">æœŸé™ã‚¿ã‚¹ã‚¯ 0</div>
              </div>
              <div class="row">
                <div class="tiny">æœŸé™(æ—¥)</div>
                <input id="daysWindow" type="number" min="0" value="3" style="width:90px" />
              </div>
            </div>
            <div class="tasks" id="taskList" style="margin-top:12px"></div>
            <div class="tiny" id="taskEmpty" style="margin-top:10px;display:none">ä»Šæ—¥ã‚„ã‚‹ã“ã¨ï¼šãªã—</div>
          </div>
        </div>
      </section>

      <!-- PLANTS -->
      <section class="card" id="view-plants" style="display:none">
        <div class="row" style="justify-content:space-between">
          <div>
            <h2>æ¤ç‰©</h2>
            <div class="sub">å†™çœŸã‚«ãƒ¼ãƒ‰ã§ç®¡ç†ã€‚ã‚¿ãƒƒãƒ—ã§è©³ç´°ãƒ»å±¥æ­´ãƒ»å‰Šé™¤ã€‚</div>
          </div>
          <button class="btn small" id="addFromPlants">â• è¿½åŠ </button>
        </div>

        <div class="hr"></div>

        <div class="plantGrid" id="plantGrid"></div>
        <div class="tiny" id="plantEmpty" style="display:none;margin-top:10px">
          ã¾ã æ¤ç‰©ãŒã‚ã‚Šã¾ã›ã‚“ã€‚â•è¿½åŠ  ã‹ã‚‰1ã¤ç™»éŒ²ã—ã¦ã¿ã¦ã€‚
        </div>
      </section>

      <!-- ADD -->
      <section class="card" id="view-add" style="display:none">
        <h2>æ¤ç‰©ã‚’è¿½åŠ </h2>
        <div class="sub">åå‰ãƒ»ç¨®ãƒ»å†™çœŸãƒ»ç½®ãå ´æ‰€ãƒ»å‘¨æœŸã ã‘ã§OKã€‚ã‚ã¨ã‹ã‚‰ç·¨é›†ã§ãã‚‹ã€‚</div>

        <div class="split" style="margin-top:12px">
          <div class="card" style="padding:12px;background:rgba(12,18,28,.45);box-shadow:none">
            <label>å†™çœŸï¼ˆã‚«ãƒ¡ãƒ©/ã‚¢ãƒ«ãƒãƒ ï¼‰</label>
            <input id="photoInput" type="file" accept="image/*" capture="environment" />
            <div style="margin-top:10px">
              <img id="photoPreview" class="modalImg" style="height:200px;display:none" />
              <div class="tiny" id="photoHint">â€» å†™çœŸã¯ç«¯æœ«å†…ä¿å­˜ï¼ˆã‚¯ãƒ©ã‚¦ãƒ‰é€ä¿¡ãªã—ï¼‰</div>
            </div>

            <label style="margin-top:12px">åå‰</label>
            <input id="nameInput" placeholder="ä¾‹ï¼šãƒ¢ãƒ³ã‚¹ãƒ†ãƒ©" />

            <label>ç¨®ï¼ˆç·‘ç¨®ï¼‰</label>
            <input id="speciesInput" placeholder="ä¾‹ï¼šMonstera deliciosa / è¦³è‘‰æ¤ç‰©" />

            <label>ç½®ãå ´æ‰€</label>
            <input id="locInput" placeholder="ä¾‹ï¼šãƒªãƒ“ãƒ³ã‚°çª“éš› / æ¸©å®¤" />

            <div class="row" style="margin-top:10px">
              <div style="flex:1">
                <label>æ°´ã‚„ã‚Šå‘¨æœŸï¼ˆæ—¥ï¼‰</label>
                <input id="waterEvery" type="number" min="0" value="7" />
              </div>
              <div style="flex:1">
                <label>è‚¥æ–™å‘¨æœŸï¼ˆæ—¥ï¼‰</label>
                <input id="fertEvery" type="number" min="0" value="30" />
              </div>
              <div style="flex:1">
                <label>å‰ªå®šå‘¨æœŸï¼ˆæ—¥ï¼‰</label>
                <input id="pruneEvery" type="number" min="0" value="90" />
              </div>
            </div>

            <label>ãƒ¡ãƒ¢</label>
            <textarea id="memoInput" placeholder="ä¾‹ï¼šè‘‰æ°´ã¯é€±2ã€å†¬ã¯æ§ãˆã‚ã€‚"></textarea>

            <div class="row" style="margin-top:12px">
              <button class="btn" id="savePlant">âœ… ç™»éŒ²ã™ã‚‹</button>
              <button class="btn ghost" id="resetAdd">ãƒªã‚»ãƒƒãƒˆ</button>
            </div>
          </div>

          <div class="card" style="padding:12px;background:rgba(12,18,28,.45);box-shadow:none">
            <h3 style="margin:0 0 8px">â€œæ˜ ãˆã‚‹â€ãƒã‚¤ãƒ³ãƒˆ</h3>
            <div class="sub">
              ã—ã‚‡ã¼ã•ã®åŸå› ã¯ã€Œå†™çœŸãŒãªã„ã€ã€Œæ“ä½œãŒé ã„ã€ã€‚<br/>
              ã“ã“ã¯ <b>ç™»éŒ²â†’ã‚«ãƒ¼ãƒ‰è¡¨ç¤ºâ†’ã‚¿ãƒƒãƒ—è©³ç´°</b> ã§ä¸€æ°—ã«ãƒ—ãƒ­æ„ŸãŒå‡ºã‚‹ã€‚
            </div>
            <div class="hr"></div>
            <div class="tiny">æ¬¡ã®å¼·åŒ–ï¼ˆä»»æ„ï¼‰</div>
            <div class="chips" style="margin-top:8px">
              <span class="chip">ğŸ“† é€šçŸ¥(ics)</span>
              <span class="chip">ğŸ§¾ ä½œæ¥­å±¥æ­´</span>
              <span class="chip">ğŸ©º è¨ºæ–­ãƒ­ã‚°</span>
              <span class="chip">ğŸª´ ç½®ãå ´æ‰€ãƒ•ã‚£ãƒ«ã‚¿</span>
            </div>
          </div>
        </div>
      </section>

      <!-- DIAG -->
      <section class="card" id="view-diag" style="display:none">
        <h2>ç—…æ°—ãƒã‚§ãƒƒã‚¯ï¼ˆCï¼‰</h2>
        <div class="sub">å†™çœŸï¼‹ç—‡çŠ¶è³ªå•ã§ã€ŒåŸå› å€™è£œTOP3ã€ã¨ã€Œå¯¾å‡¦ã€ã‚’å‡ºã™ï¼ˆã¾ãšã¯ãƒ«ãƒ¼ãƒ«å¼ï¼‰ã€‚</div>

        <div class="split" style="margin-top:12px">
          <div class="card" style="padding:12px;background:rgba(12,18,28,.45);box-shadow:none">
            <label>å†™çœŸï¼ˆä»»æ„ï¼‰</label>
            <input id="diagPhotoInput" type="file" accept="image/*" capture="environment" />
            <img id="diagPreview" class="modalImg" style="height:200px;display:none;margin-top:10px" />

            <label style="margin-top:12px">æ¤ç‰©ï¼ˆä»»æ„ï¼‰</label>
            <select id="diagPlantSelect"></select>

            <label style="margin-top:12px">ç—‡çŠ¶ï¼ˆå½“ã¦ã¯ã¾ã‚‹ã‚‚ã®ï¼‰</label>
            <div class="row">
              <label style="flex:1"><input type="checkbox" class="sym" value="yellow"> è‘‰ãŒé»„ã°ã‚€</label>
              <label style="flex:1"><input type="checkbox" class="sym" value="spots"> æ–‘ç‚¹/ã‚·ãƒŸ</label>
              <label style="flex:1"><input type="checkbox" class="sym" value="wilting"> ã—ãŠã‚Œã‚‹</label>
            </div>
            <div class="row">
              <label style="flex:1"><input type="checkbox" class="sym" value="bugs"> è™«/ãƒ™ã‚¿ã¤ã</label>
              <label style="flex:1"><input type="checkbox" class="sym" value="mold"> ã‚«ãƒ“/ç™½ã„ç²‰</label>
              <label style="flex:1"><input type="checkbox" class="sym" value="brown"> èŒ¶è‰²ãæ¯ã‚Œã‚‹</label>
            </div>

            <label style="margin-top:12px">çŠ¶æ³</label>
            <div class="row">
              <div style="flex:1">
                <label style="margin-top:0">ç›´è¿‘ã§æ°´ã‚„ã‚Šå¤šã‚ï¼Ÿ</label>
                <select id="ctxWater">
                  <option value="unknown">ã‚ã‹ã‚‰ãªã„</option>
                  <option value="more">å¤šã‚</option>
                  <option value="less">å°‘ãªã‚</option>
                </select>
              </div>
              <div style="flex:1">
                <label style="margin-top:0">æ—¥å½“ãŸã‚Š</label>
                <select id="ctxLight">
                  <option value="unknown">ã‚ã‹ã‚‰ãªã„</option>
                  <option value="strong">å¼·ã„</option>
                  <option value="weak">å¼±ã„</option>
                </select>
              </div>
              <div style="flex:1">
                <label style="margin-top:0">é¢¨é€šã—</label>
                <select id="ctxAir">
                  <option value="unknown">ã‚ã‹ã‚‰ãªã„</option>
                  <option value="good">è‰¯ã„</option>
                  <option value="bad">æ‚ªã„</option>
                </select>
              </div>
            </div>

            <label>ãƒ¡ãƒ¢</label>
            <textarea id="diagMemo" placeholder="ä¾‹ï¼šæœ€è¿‘å¯’ã„ï¼é‰¢ãŒé‡ã„ï¼åœŸãŒä¹¾ã‹ãªã„ãªã©"></textarea>

            <div class="row" style="margin-top:12px">
              <button class="btn" id="runDiag">ğŸ©º åˆ¤å®šã™ã‚‹</button>
              <button class="btn ghost" id="resetDiag">ãƒªã‚»ãƒƒãƒˆ</button>
            </div>
          </div>

          <div class="card" style="padding:12px;background:rgba(12,18,28,.45);box-shadow:none">
            <h3 style="margin:0 0 8px">çµæœ</h3>
            <div class="sub">ä»Šã¯â€œãƒ«ãƒ¼ãƒ«å¼â€ã€‚å¾Œã§AIã«å·®ã—æ›¿ãˆã‚‚å¯èƒ½ï¼ˆã‚³ã‚¹ãƒˆæœ€å°ï¼‰ã€‚</div>
            <div class="hr"></div>
            <div id="diagResult" class="sub">ã¾ã åˆ¤å®šã—ã¦ãªã„ã€‚</div>
          </div>
        </div>
      </section>

      <!-- BACKUP -->
      <section class="card" id="view-backup" style="display:none">
        <h2>ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—</h2>
        <div class="sub">ãƒ‡ãƒ¼ã‚¿ã¯ç«¯æœ«å†…ï¼ˆlocalStorageï¼‰ã€‚ãƒ•ã‚¡ã‚¤ãƒ«ã§ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—/å¾©å…ƒã§ãã‚‹ã€‚</div>

        <div class="split" style="margin-top:12px">
          <div class="card" style="padding:12px;background:rgba(12,18,28,.45);box-shadow:none">
            <h3 style="margin:0 0 8px">ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</h3>
            <div class="sub">JSONã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦ä¿ç®¡ã€‚</div>
            <div class="row" style="margin-top:10px">
              <button class="btn" id="exportBtn">â¬‡ï¸ JSONæ›¸ãå‡ºã—</button>
              <button class="btn ghost" id="exportIcsBtn">ğŸ“† é€šçŸ¥(ics)ç”Ÿæˆ</button>
            </div>
            <div class="tiny" style="margin-top:10px">â€» icsã¯ã€ŒæœŸé™æ—¥ã€ã®é€šçŸ¥ã‚’ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã«å…¥ã‚Œã‚‹æ–¹å¼ï¼ˆ0å††ã§ç¢ºå®Ÿï¼‰</div>
          </div>

          <div class="card" style="padding:12px;background:rgba(12,18,28,.45);box-shadow:none">
            <h3 style="margin:0 0 8px">ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</h3>
            <div class="sub">JSONã‚’èª­ã¿è¾¼ã‚“ã§å¾©å…ƒã€‚</div>
            <input id="importInput" type="file" accept="application/json" />
            <div class="row" style="margin-top:10px">
              <button class="btn" id="importBtn">â¬†ï¸ å¾©å…ƒã™ã‚‹</button>
              <button class="btn danger" id="wipeBtn">ğŸ§¨ å…¨å‰Šé™¤</button>
            </div>
            <div class="tiny" style="margin-top:10px;color:#ffb4b4">å…¨å‰Šé™¤ã¯æˆ»ã›ãªã„ï¼ˆãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—æ¨å¥¨ï¼‰</div>
          </div>
        </div>
      </section>
    </main>
  </div>

  <!-- Modal (plant detail) -->
  <div class="modalBack" id="modalBack">
    <div class="modal">
      <div class="modalHeader">
        <strong id="modalTitle">è©³ç´°</strong>
        <button class="x" id="closeModal">é–‰ã˜ã‚‹</button>
      </div>
      <div class="modalBody" id="modalBody"></div>
    </div>
  </div>

<script>
(() => {
  const KEY = "plantlog_v2";
  const now = () => new Date();
  const dayMs = 24*60*60*1000;

  /** @type {{plants:any[], tasksDone:Record<string,boolean>, diagLog:any[]}} */
  let state = load() || { plants: [], tasksDone: {}, diagLog: [] };

  const $ = (id) => document.getElementById(id);
  const tabs = $("tabs");
  const views = {
    today: $("view-today"),
    plants: $("view-plants"),
    add: $("view-add"),
    diag: $("view-diag"),
    backup: $("view-backup"),
  };

  function save(){
    localStorage.setItem(KEY, JSON.stringify(state));
    $("statusPill").textContent = "ä¿å­˜: localStorage âœ“";
    setTimeout(()=> $("statusPill").textContent = "ä¿å­˜: localStorage", 900);
  }
  function load(){
    try{
      const raw = localStorage.getItem(KEY);
      return raw ? JSON.parse(raw) : null;
    }catch(e){ return null; }
  }

  function uid(){ return Math.random().toString(16).slice(2) + Date.now().toString(16); }

  function fmtDate(d){
    const x = new Date(d);
    const y = x.getFullYear();
    const m = String(x.getMonth()+1).padStart(2,"0");
    const dd = String(x.getDate()).padStart(2,"0");
    return `${y}-${m}-${dd}`;
  }

  function daysBetween(a,b){
    const aa = new Date(a); const bb = new Date(b);
    return Math.round((bb - aa)/dayMs);
  }

  function nextDue(last, every){
    if(!every || every<=0) return null;
    const base = last ? new Date(last) : new Date();
    return new Date(base.getTime() + every*dayMs);
  }

  function ensureDefaults(p){
    const base = {
      id: uid(),
      name: "",
      species: "",
      location: "",
      memo: "",
      photo: "",
      waterEvery: 7,
      fertEvery: 30,
      pruneEvery: 90,
      lastWater: null,
      lastFert: null,
      lastPrune: null,
      createdAt: new Date().toISOString()
    };
    return {...base, ...p};
  }

  function switchTab(tab){
    for(const el of tabs.querySelectorAll(".tab")){
      el.classList.toggle("active", el.dataset.tab===tab);
    }
    Object.entries(views).forEach(([k,v]) => v.style.display = (k===tab ? "" : "none"));
    if(tab==="today") renderToday();
    if(tab==="plants") renderPlants();
    if(tab==="diag") renderDiagSelect();
  }

  tabs.addEventListener("click", (e)=>{
    const t = e.target.closest(".tab");
    if(!t) return;
    switchTab(t.dataset.tab);
  });

  $("goAdd").onclick = () => switchTab("add");
  $("goPlants").onclick = () => switchTab("plants");
  $("addFromPlants").onclick = () => switchTab("add");
  $("quickDiag").onclick = () => switchTab("diag");

  // --- Add Plant ---
  let addPhotoData = "";
  $("photoInput").addEventListener("change", async (e)=>{
    const f = e.target.files?.[0];
    if(!f) return;
    addPhotoData = await fileToDataURL(f, 1100);
    $("photoPreview").src = addPhotoData;
    $("photoPreview").style.display = "";
  });

  $("resetAdd").onclick = () => {
    addPhotoData = "";
    $("photoInput").value = "";
    $("photoPreview").style.display = "none";
    $("nameInput").value = "";
    $("speciesInput").value = "";
    $("locInput").value = "";
    $("waterEvery").value = 7;
    $("fertEvery").value = 30;
    $("pruneEvery").value = 90;
    $("memoInput").value = "";
  };

  $("savePlant").onclick = () => {
    const name = $("nameInput").value.trim();
    if(!name){
      alert("åå‰ã¯å¿…é ˆã€‚");
      return;
    }
    const p = ensureDefaults({
      name,
      species: $("speciesInput").value.trim(),
      location: $("locInput").value.trim(),
      memo: $("memoInput").value.trim(),
      photo: addPhotoData || "",
      waterEvery: Number($("waterEvery").value||0),
      fertEvery: Number($("fertEvery").value||0),
      pruneEvery: Number($("pruneEvery").value||0),
      lastWater: null,
      lastFert: null,
      lastPrune: null
    });
    state.plants.unshift(p);
    save();
    $("resetAdd").click();
    switchTab("plants");
  };

  // --- Render Plants ---
  function renderPlants(){
    const grid = $("plantGrid");
    grid.innerHTML = "";
    $("plantEmpty").style.display = state.plants.length ? "none" : "";
    state.plants.forEach(p=>{
      const due = computePlantDue(p);
      const card = document.createElement("div");
      card.className = "plantCard";
      card.innerHTML = `
        <div class="thumb">
          ${p.photo ? `<img src="${p.photo}" alt="">` : ``}
          <div class="badge">${p.location ? esc(p.location) : "æœªè¨­å®š"}</div>
        </div>
        <div class="plantBody">
          <p class="plantName">${esc(p.name)}</p>
          <div class="plantMeta">${esc(p.species || "ç¨®ï¼šæœªå…¥åŠ›")}</div>
          <div class="chips">
            ${chipHTML("ğŸ’§æ°´", due.water)}
            ${chipHTML("ğŸ§ªè‚¥æ–™", due.fert)}
            ${chipHTML("âœ‚ï¸å‰ªå®š", due.prune)}
          </div>
        </div>
      `;
      card.onclick = () => openPlantModal(p.id);
      grid.appendChild(card);
    });
  }

  function chipHTML(label, info){
    if(!info) return `<span class="chip">${label} -</span>`;
    const cls = info.level;
    return `<span class="chip ${cls}">${label} ${info.text}</span>`;
  }

  function computePlantDue(p){
    const w = dueInfo(p.lastWater, p.waterEvery);
    const f = dueInfo(p.lastFert, p.fertEvery);
    const pr = dueInfo(p.lastPrune, p.pruneEvery);
    return {water:w, fert:f, prune:pr};
  }

  function dueInfo(last, every){
    if(!every || every<=0) return null;
    const lastD = last ? new Date(last) : null;
    const due = nextDue(lastD, every);
    const diff = daysBetween(now(), due);
    let level = "ok";
    if(diff < 0) level = "bad";
    else if(diff <= 2) level = "warn";
    const text = diff < 0 ? `${Math.abs(diff)}æ—¥é…ã‚Œ` : `${diff}æ—¥`;
    return { due, diff, level, text };
  }

  // --- Today tasks ---
  $("daysWindow").addEventListener("change", renderToday);

  function renderToday(){
    const n = state.plants.length;
    $("countPill").textContent = `ç™»éŒ² ${n}`;
    const daysWin = Number($("daysWindow").value||0);
    const tasks = buildTasks(daysWin);

    $("duePill").textContent = `æœŸé™ã‚¿ã‚¹ã‚¯ ${tasks.length}`;

    const list = $("taskList");
    list.innerHTML = "";
    $("taskEmpty").style.display = tasks.length ? "none" : "";

    tasks.forEach(t=>{
      const key = `done:${t.kind}:${t.plantId}:${fmtDate(t.due)}`;
      const done = !!state.tasksDone[key];

      const el = document.createElement("div");
      el.className = "task";
      el.innerHTML = `
        <input type="checkbox" ${done?"checked":""} />
        <div style="flex:1">
          <div class="taskTitle">${t.icon} ${esc(t.name)}ï¼š${t.label}</div>
          <div class="taskSub">æœŸé™ï¼š${fmtDate(t.due)}ï¼ˆ${t.diff<0?`${Math.abs(t.diff)}æ—¥é…ã‚Œ`:`ã‚ã¨${t.diff}æ—¥`}ï¼‰</div>
        </div>
        <button class="btn small ghost">è©³ç´°</button>
      `;
      const cb = el.querySelector("input");
      cb.onchange = () => {
        state.tasksDone[key] = cb.checked;
        save();
      };
      el.querySelector("button").onclick = () => openPlantModal(t.plantId);
      list.appendChild(el);
    });
  }

  function buildTasks(daysWin){
    const out = [];
    state.plants.forEach(p=>{
      const d = computePlantDue(p);
      pushTaskIf(d.water, p, "water", "ğŸ’§", "æ°´ã‚„ã‚Š");
      pushTaskIf(d.fert, p, "fert", "ğŸ§ª", "è‚¥æ–™");
      pushTaskIf(d.prune, p, "prune", "âœ‚ï¸", "å‰ªå®š");
      function pushTaskIf(info, p, kind, icon, label){
        if(!info) return;
        if(info.diff <= daysWin) {
          out.push({plantId:p.id, name:p.name, kind, icon, label, due:info.due, diff:info.diff});
        }
      }
    });
    out.sort((a,b)=> a.due - b.due);
    return out;
  }

  // --- Modal (Plant detail) ---
  function openPlantModal(id){
    const p = state.plants.find(x=>x.id===id);
    if(!p) return;
    $("modalTitle").textContent = p.name;
    const due = computePlantDue(p);
    $("modalBody").innerHTML = `
      ${p.photo ? `<img class="modalImg" src="${p.photo}" alt="">` : `<div class="modalImg" style="display:flex;align-items:center;justify-content:center;color:var(--muted)">å†™çœŸãªã—</div>`}
      <div class="hr"></div>

      <div class="row" style="justify-content:space-between">
        <div>
          <div><b>${esc(p.name)}</b> <span class="muted">(${esc(p.species||"ç¨®ï¼šæœªå…¥åŠ›")})</span></div>
          <div class="tiny">ç½®ãå ´æ‰€ï¼š${esc(p.location||"æœªè¨­å®š")}</div>
        </div>
        <button class="btn small danger" id="delBtn">å‰Šé™¤</button>
      </div>

      <div class="hr"></div>

      <div class="row">
        <button class="btn small" id="doWater">ğŸ’§ æ°´ã‚„ã‚Šã—ãŸ</button>
        <button class="btn small" id="doFert">ğŸ§ª è‚¥æ–™ã—ãŸ</button>
        <button class="btn small" id="doPrune">âœ‚ï¸ å‰ªå®šã—ãŸ</button>
      </div>

      <div class="chips" style="margin-top:10px">
        ${chipHTML("ğŸ’§æ°´", due.water)}
        ${chipHTML("ğŸ§ªè‚¥æ–™", due.fert)}
        ${chipHTML("âœ‚ï¸å‰ªå®š", due.prune)}
      </div>

      <label style="margin-top:12px">ãƒ¡ãƒ¢</label>
      <textarea id="editMemo">${escTextarea(p.memo||"")}</textarea>
      <div class="row" style="margin-top:10px">
        <button class="btn small ghost" id="saveMemo">ãƒ¡ãƒ¢ä¿å­˜</button>
      </div>

      <div class="hr"></div>
      <div class="tiny">â€» å†™çœŸã‚‚å¾Œã‹ã‚‰å·®ã—æ›¿ãˆã§ãã‚‹ï¼ˆã“ã“ã¯æ¬¡ã®å¼·åŒ–ã§è¿½åŠ ã—ã¦ã‚‚OKï¼‰</div>
    `;

    $("delBtn").onclick = () => {
      if(!confirm("å‰Šé™¤ã™ã‚‹ï¼Ÿï¼ˆæˆ»ã›ãªã„ï¼‰")) return;
      state.plants = state.plants.filter(x=>x.id!==id);
      save();
      closeModal();
      renderPlants();
      renderToday();
    };

    $("doWater").onclick = () => { p.lastWater = new Date().toISOString(); save(); openPlantModal(id); renderToday(); renderPlants(); };
    $("doFert").onclick  = () => { p.lastFert  = new Date().toISOString(); save(); openPlantModal(id); renderToday(); renderPlants(); };
    $("doPrune").onclick = () => { p.lastPrune = new Date().toISOString(); save(); openPlantModal(id); renderToday(); renderPlants(); };

    $("saveMemo").onclick = () => {
      p.memo = $("editMemo").value;
      save();
      alert("ä¿å­˜ã—ãŸ");
    };

    $("modalBack").style.display = "flex";
  }
  function closeModal(){ $("modalBack").style.display="none"; }
  $("closeModal").onclick = closeModal;
  $("modalBack").addEventListener("click", (e)=>{ if(e.target.id==="modalBack") closeModal(); });

  // --- Diagnose ---
  let diagPhotoData = "";
  $("diagPhotoInput").addEventListener("change", async (e)=>{
    const f = e.target.files?.[0];
    if(!f) return;
    diagPhotoData = await fileToDataURL(f, 1100);
    $("diagPreview").src = diagPhotoData;
    $("diagPreview").style.display = "";
  });

  function renderDiagSelect(){
    const sel = $("diagPlantSelect");
    sel.innerHTML = `<option value="">ï¼ˆæœªé¸æŠï¼‰</option>` + state.plants.map(p=>`<option value="${p.id}">${esc(p.name)}</option>`).join("");
  }

  $("resetDiag").onclick = () => {
    diagPhotoData = "";
    $("diagPhotoInput").value = "";
    $("diagPreview").style.display = "none";
    $("diagPlantSelect").value = "";
    document.querySelectorAll(".sym").forEach(x=>x.checked=false);
    $("ctxWater").value="unknown";
    $("ctxLight").value="unknown";
    $("ctxAir").value="unknown";
    $("diagMemo").value="";
    $("diagResult").textContent="ã¾ã åˆ¤å®šã—ã¦ãªã„ã€‚";
  };

  $("runDiag").onclick = () => {
    const syms = [...document.querySelectorAll(".sym")].filter(x=>x.checked).map(x=>x.value);
    const ctx = {
      water: $("ctxWater").value,
      light: $("ctxLight").value,
      air: $("ctxAir").value
    };
    const memo = $("diagMemo").value.trim();
    const plantId = $("diagPlantSelect").value;

    const r = diagnose(syms, ctx);
    const top = r.slice(0,3);

    const plantName = plantId ? (state.plants.find(p=>p.id===plantId)?.name || "") : "";

    $("diagResult").innerHTML = `
      <div><b>å€™è£œTOP3</b>${plantName?`ï¼ˆ${esc(plantName)}ï¼‰`:``}</div>
      <div class="hr"></div>
      ${top.map((x,i)=>`
        <div style="margin-bottom:12px">
          <div><b>${i+1}. ${esc(x.name)}</b> <span class="muted">(${x.score}ç‚¹)</span></div>
          <div class="tiny">${esc(x.why)}</div>
          <div class="tiny" style="margin-top:6px">âœ… å¯¾å‡¦ï¼š${esc(x.todo)}</div>
        </div>
      `).join("")}
      <div class="hr"></div>
      <div class="tiny">â€» ã“ã‚Œã¯â€œãƒ«ãƒ¼ãƒ«å¼â€ã€‚å†™çœŸAIã‚’å…¥ã‚Œã‚‹ãªã‚‰ã€Œæœ€çµ‚åˆ¤æ–­ã ã‘AIã€ã«ã™ã‚‹ã¨ã‚³ã‚¹ãƒˆæœ€å°ã§å¼·ã„ã€‚</div>
    `;

    state.diagLog.unshift({at:new Date().toISOString(), plantId, syms, ctx, memo, top, photo: diagPhotoData?true:false});
    save();
  };

  function diagnose(syms, ctx){
    // ãƒ«ãƒ¼ãƒ«å¼ã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°ï¼ˆã‚ã¨ã§AIå·®ã—æ›¿ãˆå¯èƒ½ï¼‰
    const rules = [
      {
        name:"æ°´ã®ã‚„ã‚Šã™ãï¼ˆæ ¹è…ã‚Œï¼‰",
        score:0,
        when:()=> (syms.includes("wilting")||syms.includes("yellow")) && ctx.water==="more",
        why:"ã—ãŠã‚Œ/é»„ã°ã¿ï¼‹æ°´å¤šã‚ã¯æ ¹ãŒé…¸æ¬ ã«ãªã‚Šã‚„ã™ã„ã€‚",
        todo:"é‰¢ã‚’æŒã£ã¦é‡ã„/åœŸãŒä¹¾ã‹ãªã„ãªã‚‰æ–­æ°´â†’é¢¨é€šã—â†’å¿…è¦ãªã‚‰æ¤ãˆæ›¿ãˆï¼ˆæ ¹ãƒã‚§ãƒƒã‚¯ï¼‰ã€‚"
      },
      {
        name:"æ°´ä¸è¶³ï¼ˆä¹¾ç‡¥ï¼‰",
        score:0,
        when:()=> (syms.includes("wilting")||syms.includes("brown")) && ctx.water==="less",
        why:"ã—ãŠã‚Œ/æ¯ã‚Œï¼‹æ°´å°‘ãªã‚s ã¯ä¹¾ç‡¥ã‚¹ãƒˆãƒ¬ã‚¹ã®å…¸å‹ã€‚",
        todo:"åœŸãŒä¹¾ã„ã¦è»½ã„ãªã‚‰ãŸã£ã·ã‚Šæ½…æ°´â†’æ’æ°´ç¢ºèªâ†’ä»¥å¾Œå‘¨æœŸè¦‹ç›´ã—ã€‚"
      },
      {
        name:"æ—¥ç…§ã‚¹ãƒˆãƒ¬ã‚¹ï¼ˆå¼·ã™ã/è‘‰ç„¼ã‘ï¼‰",
        score:0,
        when:()=> syms.includes("brown") && ctx.light==="strong",
        why:"èŒ¶è‰²ã„æ¯ã‚Œï¼‹å¼·å…‰ã¯è‘‰ç„¼ã‘ã®å¯èƒ½æ€§ã€‚",
        todo:"åŠæ—¥é™°ã¸ç§»å‹•â†’ç›´å°„ã‚’é¿ã‘ã‚‹â†’é®å…‰ï¼ˆãƒ¬ãƒ¼ã‚¹ï¼‰ã§æ…£ã‚‰ã™ã€‚"
      },
      {
        name:"æ—¥ç…§ä¸è¶³ï¼ˆå¾’é•·/é»„åŒ–ï¼‰",
        score:0,
        when:()=> syms.includes("yellow") && ctx.light==="weak",
        why:"é»„ã°ã¿ï¼‹å¼±å…‰ã¯ä»£è¬ä½ä¸‹ã§èµ·ãã‚„ã™ã„ã€‚",
        todo:"æ˜ã‚‹ã„å ´æ‰€ã¸â†’æ•°æ—¥ã§å›å¾©å‚¾å‘ã‹ç¢ºèªâ†’æ°´ã‚„ã‚Šé »åº¦ã‚‚æ§ãˆã‚ã«ã€‚"
      },
      {
        name:"å®³è™«ï¼ˆãƒãƒ€ãƒ‹/ã‚«ã‚¤ã‚¬ãƒ©ãƒ ã‚·/ã‚¢ãƒ–ãƒ©ãƒ ã‚·ï¼‰",
        score:0,
        when:()=> syms.includes("bugs") || (syms.includes("spots") && ctx.air==="bad"),
        why:"è™«/ãƒ™ã‚¿ã¤ãã¯å®³è™«ã€‚æ–‘ç‚¹ï¼‹é¢¨é€šã—æ‚ªã„ã¨å¢—ãˆã‚„ã™ã„ã€‚",
        todo:"è‘‰è£ãƒã‚§ãƒƒã‚¯â†’ã‚·ãƒ£ãƒ¯ãƒ¼æ´—æµ„â†’æ‹­ãå–ã‚Šâ†’å¿…è¦ãªã‚‰è–¬å‰¤/çŸ³é¹¸æ°´ã€‚éš”é›¢æ¨å¥¨ã€‚"
      },
      {
        name:"ã‚«ãƒ“/ã†ã©ã‚“ã“ç—…ï¼ˆé€šæ°—ä¸è‰¯ï¼‰",
        score:0,
        when:()=> syms.includes("mold") || (syms.includes("spots") && ctx.air==="bad"),
        why:"ç™½ã„ç²‰/ã‚«ãƒ“ã€æ–‘ç‚¹ï¼‹é€šæ°—ä¸è‰¯ã¯ç—…æ°—ãŒå‡ºã‚„ã™ã„ã€‚",
        todo:"é¢¨é€šã—æ”¹å–„â†’è‘‰æ°´æ§ãˆâ†’ à¦†à¦•à§à¦°à¦¾à¦¨à§à¦¤è‘‰é™¤å»â†’æ®ºèŒå‰¤ï¼ˆå¿…è¦æ™‚ï¼‰ã€‚"
      },
      {
        name:"è‚¥æ–™éå¤šï¼ˆè‚¥æ–™ç„¼ã‘ï¼‰",
        score:0,
        when:()=> syms.includes("brown") && syms.includes("spots"),
        why:"èŒ¶æ¯ã‚Œï¼‹æ–‘ç‚¹ã¯è‚¥æ–™éå¤šã§ã‚‚å‡ºã‚‹ã€‚",
        todo:"è‚¥æ–™ã‚’æ­¢ã‚ã‚‹â†’æ°´ã§æµã™â†’æ–°èŠ½ã®çŠ¶æ…‹ã§åˆ¤æ–­ã€‚"
      },
    ];

    // ã‚¹ã‚³ã‚¢é…åˆ†
    rules.forEach(r=>{
      let s=0;
      if(r.when()) s+=70;
      syms.forEach(v=>{
        if(r.name.includes("æ°´") && (v==="wilting"||v==="yellow")) s+=10;
        if(r.name.includes("å®³è™«") && (v==="bugs"||v==="spots")) s+=15;
        if(r.name.includes("ã‚«ãƒ“") && (v==="mold"||v==="spots")) s+=15;
        if(r.name.includes("æ—¥ç…§") && (v==="brown"||v==="yellow")) s+=10;
      });
      if(ctx.air==="bad" && (r.name.includes("å®³è™«")||r.name.includes("ã‚«ãƒ“"))) s+=10;
      if(ctx.light==="strong" && r.name.includes("è‘‰ç„¼ã‘")) s+=10;
      if(ctx.light==="weak" && r.name.includes("ä¸è¶³")) s+=10;
      if(ctx.water==="more" && r.name.includes("æ ¹è…ã‚Œ")) s+=10;
      if(ctx.water==="less" && r.name.includes("æ°´ä¸è¶³")) s+=10;
      r.score = Math.min(100, s);
    });

    // ã‚‚ã—å…¨éƒ¨å¼±ã„ãªã‚‰ã€Œè¦è¦³å¯Ÿã€ã‚’å…¥ã‚Œã‚‹
    const sorted = rules.sort((a,b)=>b.score-a.score);
    if(sorted[0].score < 40){
      sorted.unshift({
        name:"è¦è¦³å¯Ÿï¼ˆæƒ…å ±ä¸è¶³ï¼‰",
        score:60,
        why:"ç—‡çŠ¶ãŒçµã‚Œãªã„ã€‚å†™çœŸ/è‘‰è£/åœŸã®çŠ¶æ…‹/æœ€è¿‘ã®ç’°å¢ƒå¤‰åŒ–ãŒå¿…è¦ã€‚",
        todo:"è‘‰è£ãƒ»åœŸã®æ¹¿ã‚Šãƒ»æ ¹å…ƒã®åŒ‚ã„ãƒ»æ–°èŠ½ã®çŠ¶æ…‹ã‚’ç¢ºèªã€‚å†™çœŸã‚’æ’®ã£ã¦æ¯”è¼ƒã€‚"
      });
    }
    return sorted;
  }

  // --- Backup / Restore ---
  $("exportBtn").onclick = () => {
    const blob = new Blob([JSON.stringify(state, null, 2)], {type:"application/json"});
    download(blob, `plantlog-backup-${fmtDate(new Date())}.json`);
  };

  $("importBtn").onclick = async () => {
    const f = $("importInput").files?.[0];
    if(!f){ alert("JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸ã‚“ã§ã€‚"); return; }
    const txt = await f.text();
    try{
      const data = JSON.parse(txt);
      if(!data || typeof data !== "object") throw new Error("bad");
      if(!Array.isArray(data.plants)) throw new Error("plants");
      // normalize
      data.plants = data.plants.map(ensureDefaults);
      if(!data.tasksDone) data.tasksDone = {};
      if(!data.diagLog) data.diagLog = [];
      state = data;
      save();
      alert("å¾©å…ƒã—ãŸ");
      renderToday(); renderPlants(); renderDiagSelect();
    }catch(e){
      alert("èª­ã¿è¾¼ã¿å¤±æ•—ï¼ˆJSONå½¢å¼ã˜ã‚ƒãªã„/å£Šã‚Œã¦ã‚‹ï¼‰");
    }
  };

  $("wipeBtn").onclick = () => {
    if(!confirm("å…¨å‰Šé™¤ã™ã‚‹ï¼Ÿï¼ˆæˆ»ã›ãªã„ï¼‰")) return;
    state = {plants:[], tasksDone:{}, diagLog:[]};
    save();
    renderToday(); renderPlants(); renderDiagSelect();
  };

  $("exportIcsBtn").onclick = () => {
    const ics = buildICS(state.plants);
    const blob = new Blob([ics], {type:"text/calendar;charset=utf-8"});
    download(blob, `plantlog-notify-${fmtDate(new Date())}.ics`);
    alert("icsã‚’ä¿å­˜ã—ãŸã€‚ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã§é–‹ãã¨é€šçŸ¥ãŒå…¥ã‚‹ã€‚");
  };

  function buildICS(plants){
    // ç°¡æ˜“ï¼šå„æ¤ç‰©ã®æ¬¡å›æœŸé™ã‚’ã‚¤ãƒ™ãƒ³ãƒˆåŒ–ï¼ˆçµ‚æ—¥ï¼‰ã€‚é€šçŸ¥ã¯ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼å´ã§è¨­å®š
    const lines = [];
    lines.push("BEGIN:VCALENDAR");
    lines.push("VERSION:2.0");
    lines.push("PRODID:-//PlantLog//JP");
    plants.forEach(p=>{
      const due = computePlantDue(p);
      const addEvent = (info, label)=>{
        if(!info) return;
        const dt = fmtDate(info.due).replaceAll("-","");
        lines.push("BEGIN:VEVENT");
        lines.push(`UID:${p.id}-${label}-${dt}@plantlog`);
        lines.push(`DTSTAMP:${fmtDate(new Date()).replaceAll("-","")}T000000Z`);
        lines.push(`DTSTART;VALUE=DATE:${dt}`);
        lines.push(`SUMMARY:${escapeICS(`PlantLog: ${p.name} ${label}`)}`);
        lines.push(`DESCRIPTION:${escapeICS(`å ´æ‰€:${p.location||"æœªè¨­å®š"} / ç¨®:${p.species||"æœªå…¥åŠ›"}`)}`);
        lines.push("END:VEVENT");
      };
      addEvent(due.water, "æ°´ã‚„ã‚Š");
      addEvent(due.fert, "è‚¥æ–™");
      addEvent(due.prune, "å‰ªå®š");
    });
    lines.push("END:VCALENDAR");
    return lines.join("\r\n");
  }
  function escapeICS(s){ return String(s||"").replace(/[,;]/g, (m)=>"\\"+m).replace(/\n/g,"\\n"); }

  // --- utils ---
  function esc(s){
    return String(s ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;");
  }
  function escTextarea(s){
    // textarea innerHTMLç”¨ï¼ˆã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã¯åŒã˜ã§OKï¼‰
    return esc(s);
  }

  function download(blob, filename){
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url; a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(()=>URL.revokeObjectURL(url), 500);
  }

  async function fileToDataURL(file, maxW=1100){
    // ç”»åƒã‚’ãƒªã‚µã‚¤ã‚ºã—ã¦ DataURLï¼ˆå®¹é‡ç¯€ç´„ï¼‰
    const img = await loadImage(file);
    const canvas = document.createElement("canvas");
    const ratio = Math.min(1, maxW / img.width);
    canvas.width = Math.round(img.width * ratio);
    canvas.height = Math.round(img.height * ratio);
    const ctx = canvas.getContext("2d");
    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
    return canvas.toDataURL("image/jpeg", 0.86);
  }
  function loadImage(file){
    return new Promise((resolve,reject)=>{
      const url = URL.createObjectURL(file);
      const img = new Image();
      img.onload = ()=>{ URL.revokeObjectURL(url); resolve(img); };
      img.onerror = reject;
      img.src = url;
    });
  }

  // init
  state.plants = state.plants.map(ensureDefaults);
  save(); // normalize save once
  renderToday();
  renderPlants();
  renderDiagSelect();
})();
</script>
</body>
</html>
